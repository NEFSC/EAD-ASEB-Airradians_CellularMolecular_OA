---
title: "Gill_MDA_analysis"
author: "Samuel Gurr"
date: "2023-10-04"
output: html_notebook
---

-   Last updates: October 04, 2023

# OA Reexposure Challenge

### May 2023: F2 Adult Bay scallops exposed to a two-week full-reciprocal pCO2 challenge

### Objective: plot and analyze ATP colorimetric data from snap frozen gill tissue 

## Load Libraries

```{r setup, include=TRUE}

# library(lmtest) # to receive p value from betareg model
# library(FSA) # for the Dun test post hoc for SRH non-parametric 2 way anova]
# library(emmeans)
library(ggplot2)
library(dplyr)
library(tidyverse)
library(car)
# library(lmerTest)
library(tidyr)
# library(reshape2)
library(ggpubr)
# library(nlme)
# library(rcompanion) # to run the Schrier -Ray-Hare non parametric 2 way 
library(ggpmisc) # stat_poly for inserting equation and R2 for ggplot line 
knitr::opts_knit$set(root.dir = "C:/Users/samjg/Documents/Github_repositories/Airradians_CellularMolecular_OA/RAnalysis") # sets the working directory for the entire R markdown file - no need to reload the wd
```

## Load MDA assay raw data

* keep all data in raw form, merge here to a master raw

* output the raw master to the Data folder

```{r load MDA assay data}

# WITHOUT PATH CORRECTION :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

# Ran on 202031004 - Plate 1 
raw_1004_plate1      <- read.csv(file="Data/Colorimetric_assays/MDA/Runs_20231004/Plate1/Plate1_MDA_assay_nopathcorrection.csv",
                          sep = ",",
                          skip=2,
                          header=TRUE,
                          fileEncoding="latin1")
raw_1004_plate1_mtx  <- as.matrix(raw_1004_plate1[c(1:8),c(3:14)])
colnames(raw_1004_plate1_mtx) = c("1","2","3","4","5","6","7","8","9","10","11","12")
rownames(raw_1004_plate1_mtx) = c("A","B","C","D","E","F","G","H")
raw_1004_plate1_table <- as.data.frame.table(raw_1004_plate1_mtx, responseName = "value") %>% 
                            dplyr::rename(well_row=Var1, well_column=Var2, Abs_695nm_no_path_correct=value) %>% 
                            dplyr::mutate(well=paste0(well_row,well_column),
                                          Run_date ="20231004",
                                          Plate="1") %>% 
                            dplyr::select(-c(well_row,well_column))

# Ran on 20230828 - Plate 2 
raw_1004_plate2      <- read.csv(file="Data/Colorimetric_assays/MDA/Runs_20231004/Plate2/Plate2_MDA_assay_nopathcorrection.csv",
                          sep = ",",
                          skip=2,
                          header=TRUE,
                          fileEncoding="latin1")
raw_1004_plate2_mtx  <- as.matrix(raw_1004_plate2[c(1:8),c(3:14)])
colnames(raw_1004_plate2_mtx) = c("1","2","3","4","5","6","7","8","9","10","11","12")
rownames(raw_1004_plate2_mtx) = c("A","B","C","D","E","F","G","H")
raw_1004_plate2_table <- as.data.frame.table(raw_1004_plate2_mtx, responseName = "value") %>% 
                            dplyr::rename(well_row=Var1, well_column=Var2, Abs_695nm_no_path_correct=value) %>% 
                            dplyr::mutate(well=paste0(well_row,well_column),
                                          Run_date ="20231004",
                                          Plate="2") %>% 
                            dplyr::select(-c(well_row,well_column))


# CUVETTE REFERENCE PATH CORRECTION  :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

# Ran on 202031004 - Plate 1 
raw_1004_plate1_cuv      <- read.csv(file="Data/Colorimetric_assays/MDA/Runs_20231004/Plate1/Plate1_MDA_assay_cuvette_ref.csv",
                          sep = ",",
                          skip=2,
                          header=TRUE,
                          fileEncoding="latin1")
raw_1004_plate1_cuv_mtx  <- as.matrix(raw_1004_plate1_cuv[c(1:8),c(3:14)])
colnames(raw_1004_plate1_cuv_mtx) = c("1","2","3","4","5","6","7","8","9","10","11","12")
rownames(raw_1004_plate1_cuv_mtx) = c("A","B","C","D","E","F","G","H")
raw_1004_plate1_cuv_table <- as.data.frame.table(raw_1004_plate1_cuv_mtx, responseName = "value") %>% 
                            dplyr::rename(well_row=Var1, well_column=Var2, Abs_695nm_cov_ref_correct=value) %>% 
                            dplyr::mutate(well=paste0(well_row,well_column),
                                          Run_date ="20231004",
                                          Plate="1") %>% 
                            dplyr::mutate(Abs_695nm_cov_ref_correct = 
                                   case_when(Abs_695nm_cov_ref_correct == "Path?" ~ NA, # Path? replace as NA
                                             TRUE ~ as.numeric(Abs_695nm_cov_ref_correct) ) ) %>% # print if not Path?
                            dplyr::select(-c(well_row,well_column))

# Ran on 20230828 - Plate 2 
raw_1004_plate2_cuv      <- read.csv(file="Data/Colorimetric_assays/MDA/Runs_20231004/Plate2/Plate2_MDA_assay_cuvette_ref.csv",
                          sep = ",",
                          skip=2,
                          header=TRUE,
                          fileEncoding="latin1")
raw_1004_plate2_cuv_mtx  <- as.matrix(raw_1004_plate2_cuv[c(1:8),c(3:14)])
colnames(raw_1004_plate2_cuv_mtx) = c("1","2","3","4","5","6","7","8","9","10","11","12")
rownames(raw_1004_plate2_cuv_mtx) = c("A","B","C","D","E","F","G","H")
raw_1004_plate2_cuv_table <- as.data.frame.table(raw_1004_plate2_cuv_mtx, responseName = "value") %>% 
                            dplyr::rename(well_row=Var1, well_column=Var2, Abs_695nm_cov_ref_correct=value) %>% 
                            dplyr::mutate(well=paste0(well_row,well_column),
                                          Run_date ="20231004",
                                          Plate="2") %>% 
                            dplyr::mutate(Abs_695nm_cov_ref_correct = 
                                   case_when(Abs_695nm_cov_ref_correct == "Path?" ~ NA, # Path? replace as NA
                                             TRUE ~ as.numeric(Abs_695nm_cov_ref_correct) ) ) %>% # print if not Path?
                            dplyr::select(-c(well_row,well_column))





# INTERNAL WATER CONSTANT PATH CORRECTION  :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

# Ran on 202031004 - Plate 1 
raw_1004_plate1_water  <- read.csv(file="Data/Colorimetric_assays/MDA/Runs_20231004/Plate1/Plate1_MDA_assay_water_constant.csv",
                          sep = ",",
                          skip=1,
                          header=TRUE,
                          fileEncoding="latin1")
raw_1004_plate1_water_mtx  <- as.matrix(raw_1004_plate1_water[c(1:8),c(3:14)])
colnames(raw_1004_plate1_water_mtx) = c("1","2","3","4","5","6","7","8","9","10","11","12")
rownames(raw_1004_plate1_water_mtx) = c("A","B","C","D","E","F","G","H")
raw_1004_plate1_water_table <- as.data.frame.table(raw_1004_plate1_water_mtx, responseName = "value") %>% 
                            dplyr::rename(well_row=Var1, well_column=Var2, Abs_695nm_water_constant_correct=value) %>% 
                            dplyr::mutate(well=paste0(well_row,well_column),
                                          Run_date ="20231004",
                                          Plate="1") %>% 
                            dplyr::mutate(Abs_695nm_water_constant_correct = 
                                   case_when(Abs_695nm_water_constant_correct == "Path?" ~ NA, # Path? replace as NA
                                             TRUE ~ as.numeric(Abs_695nm_water_constant_correct) ) ) %>% # print if not Path?
                            dplyr::select(-c(well_row,well_column))

# Ran on 20230828 - Plate 2 
raw_1004_plate2_water  <- read.csv(file="Data/Colorimetric_assays/MDA/Runs_20231004/Plate2/Plate2_MDA_assay_water_constant.csv",
                          sep = ",",
                          skip=2,
                          header=TRUE,
                          fileEncoding="latin1")
raw_1004_plate2_water_mtx  <- as.matrix(raw_1004_plate2_water[c(1:8),c(3:14)])
colnames(raw_1004_plate2_water_mtx) = c("1","2","3","4","5","6","7","8","9","10","11","12")
rownames(raw_1004_plate2_water_mtx) = c("A","B","C","D","E","F","G","H")
raw_1004_plate2_water_table <- as.data.frame.table(raw_1004_plate2_water_mtx, responseName = "value") %>% 
                            dplyr::rename(well_row=Var1, well_column=Var2, Abs_695nm_water_constant_correct=value) %>% 
                            dplyr::mutate(well=paste0(well_row,well_column),
                                          Run_date ="20231004",
                                          Plate="2") %>% 
                            dplyr::mutate(Abs_695nm_water_constant_correct = 
                                   case_when(Abs_695nm_water_constant_correct == "Path?" ~ NA, # Path? replace as NA
                                             TRUE ~ as.numeric(Abs_695nm_water_constant_correct) ) ) %>% # print if not Path?
                            dplyr::select(-c(well_row,well_column))


# MERGE WITHIN PLATE 


raw_Plate1_MDA <-  merge(raw_1004_plate1_table, 
                        (merge(raw_1004_plate1_cuv_table,raw_1004_plate1_water_table)) ) 

raw_Plate2_MDA <-  merge(raw_1004_plate2_table, 
                        (merge(raw_1004_plate2_cuv_table,raw_1004_plate2_water_table)) ) 

# load metadata

metadata      <- read.csv(file="Data/Colorimetric_assays/MDA/Metadata_MDA.csv",
                          sep = ",",
                          header=TRUE)

# merge the rbind of all raw data with the metadat 
raw_MDA_master <- merge( (rbind(raw_Plate1_MDA,raw_Plate2_MDA)),
                         (metadata %>% dplyr::select(!Notes)) )
nrow(raw_MDA_master) # 192
# View(raw_MDA_master) # view it if you want to

```

## MDA raw plots 

- any glaring outliers?

```{r} 
# plot the data to see any glaring outliers 
raw_plot_no_cor <- raw_MDA_master %>% 
                      dplyr::filter(Type %in% 'Sample') %>% 
                      ggplot(aes(y = Abs_695nm_no_path_correct, 
                                 x  = Scallop_ID)) +
                      theme_bw() +
                      ggtitle("No path correction - raw") +
                      geom_point()

raw_plot_cuvette_cor <- raw_MDA_master %>% 
                      dplyr::filter(Type %in% 'Sample') %>% 
                      ggplot(aes(y = Abs_695nm_cov_ref_correct, 
                                 x  = Scallop_ID)) +
                      theme_bw() +
                      ggtitle("Cuvette reference correct - raw") +
                      geom_point()


raw_plot_water_cor <- raw_MDA_master %>% 
                      dplyr::filter(Type %in% 'Sample') %>% 
                      ggplot(aes(y = Abs_695nm_water_constant_correct, 
                                 x  = Scallop_ID)) +
                      theme_bw() +
                      ggtitle("Water constant correct - raw") +
                      geom_point()
ggarrange(raw_plot_no_cor,
          raw_plot_cuvette_cor,
          raw_plot_water_cor,
          nrow=3)

# write csv
write.csv(raw_MDA_master, file = "Data/Colorimetric_assays/MDA/Raw_Master_MDA.csv")

```

## Load BCA assay raw data

* keep all data in raw form, merge here to a master raw

* output the raw master to the Data folder
```{r load BCA assay data}
# Ran on 20231004 - Plate 1 
BCA_1004_plate1      <- read.csv(file="Data/Colorimetric_assays/BCA_MDAcorrection/Runs_20231004/Plate1/Plate1_BCA_MDAcorrection.csv",
                          sep = ",",
                          skip=2,
                          header=TRUE,
                          fileEncoding="latin1")
BCA_1004_plate1_mtx  <- as.matrix(BCA_1004_plate1[c(1:8),c(3:14)])
colnames(BCA_1004_plate1_mtx) = c("1","2","3","4","5","6","7","8","9","10","11","12")
rownames(BCA_1004_plate1_mtx) = c("A","B","C","D","E","F","G","H")
BCA_1004_plate1_table <- as.data.frame.table(BCA_1004_plate1_mtx, responseName = "value") %>% 
                            dplyr::rename(well_row=Var1, well_column=Var2, Abs_562nm=value) %>% 
                            dplyr::mutate(well=paste0(well_row,well_column),
                                          Run_date ="20231004",
                                          Plate="1") %>% 
                            dplyr::select(-c(well_row,well_column))

# Ran on 20231004 - Plate 2
BCA_1004_plate2      <- read.csv(file="Data/Colorimetric_assays/BCA_MDAcorrection/Runs_20231004/Plate2/Plate2_BCA_MDAcorrection.csv",
                          sep = ",",
                          skip=2,
                          header=TRUE,
                          fileEncoding="latin1")
BCA_1004_plate2_mtx  <- as.matrix(BCA_1004_plate2[c(1:8),c(3:14)])
colnames(BCA_1004_plate2_mtx) = c("1","2","3","4","5","6","7","8","9","10","11","12")
rownames(BCA_1004_plate2_mtx) = c("A","B","C","D","E","F","G","H")
BCA_1004_plate2_table <- as.data.frame.table(BCA_1004_plate2_mtx, responseName = "value") %>% 
                            dplyr::rename(well_row=Var1, well_column=Var2, Abs_562nm=value) %>% 
                            dplyr::mutate(well=paste0(well_row,well_column),
                                          Run_date ="20231004",
                                          Plate="2") %>% 
                            dplyr::select(-c(well_row,well_column))

# load metadata

metadata_BCA <- read.csv(file="Data/Colorimetric_assays/BCA_MDAcorrection/Metadata_BCA_MDAcorrection.csv",
                          sep = ",",
                          header=TRUE)

# merge the rbind of all raw data with the metadat 
raw_BCA_master <- merge( (rbind(BCA_1004_plate1_table, 
                         BCA_1004_plate2_table)),
                  metadata_BCA) 
# View(raw_BCA_om)

# write csv
write.csv(raw_BCA_master, file = "Data/Colorimetric_assays/BCA_MDAcorrection/Raw_Master_BCA_MDAcorrection.csv")

```

## BCA raw plots 

- any glaring outliers?

```{r} 
# plot the data to see any glaring outliers 
raw_plot <- raw_BCA_master %>% 
                      dplyr::filter(Type %in% 'Sample') %>% 
                      ggplot(aes(y = Abs_562nm, 
                                 x  = Scallop_ID)) +
                      theme_bw() +
                      ggtitle("BCA -raw") +
                      geom_point()

raw_plot

```

* Load Experiment metadata - merge with the loaded raw colorimetric data

```{r load Experimentl metadata}
Exp_metadata      <- read.csv(file="Data/Experiment_metadata.csv",sep = ",",header=TRUE)
```

# Finalize BCA data 

- Objs: 

  * (1) Merge by the common 'Scallop_ID' and retain all rows in the colorimetric data (all=T)
  - Why? We unfortunately found that that the dewar was not properly unloaded 
  on day 14 of the experiment, below we can reveal replicates that were lost (hence 'NAs' via merge below)
  
  * (2) omit NAs - empty wells (no sample or standard)
  
  * (3) separate standards from samples
  
  * (4) Run standard curve, calculate totalprotein
  
  * (5) Calculate total protien; subtract out background + correct for standard curve +  average
  
```{r Total protein data}

raw_BCA <- read.csv(file = "Data/Colorimetric_assays/BCA_MDAcorrection/Raw_Master_BCA_MDAcorrection.csv", head = T) # the raw_BCA_om file

# * (1) Merge by the common 'Scallop_ID' and retain all rows in the colorimetric data (all=T)
# - Why? We unfortunately found that that the dewar was not properly unloaded 
# on day 14 of the experiment, below we can reveal replicates that were lost (hence 'NAs' via merge below)
raw_BCA_merged    <- merge(raw_BCA, Exp_metadata, by='Scallop_ID',all=TRUE)

# View(raw_BCA_merged)
lost_gill_samples <- raw_BCA_merged %>% dplyr::filter(Abs_562nm %in% NA)
nrow(lost_gill_samples) # 27 -NOTE: NOT ALL of these were lost, some due to low yield of supernatant to run,

# * (2) omit NAs - empty wells (no sample or standard)
raw_BCA_merged_om <- raw_BCA_merged %>% dplyr::filter(!Type %in% NA)
 
# View(raw_BCA_merged_om)

# * (3) separate standards from samples, format the standards
BCA_standards <- raw_BCA_merged_om %>% 
                    dplyr::filter(grepl('Standard', Type)) %>% # grepl for 'contains' string
                    dplyr::mutate(BCA_ug_mL = 
                                    as.numeric(gsub('.*_','',Type))) %>% # (i.e. 25 in 'Standards_25')
                    dplyr::mutate(Unique_ID = paste0('Plate_',Plate,'_', Type))



# * (4) Run standard curve, calculate totalprotein 
BCA_background_zero <- BCA_standards %>% 
                        dplyr::filter(Type %in% 'Standard_0') %>% 
                        dplyr::filter(Abs_562nm < 0.1) %>% # one outlier of 0.4150 -omit that here
                        dplyr::select(Unique_ID,Plate, BCA_ug_mL,Abs_562nm) %>% # select columns of interest
                        dplyr::group_by(Unique_ID, Plate, BCA_ug_mL) %>% # group by to get the means
                        dplyr::summarise_each(funs(mean,sd,se=sd(.)/sqrt(n()))) # get all the stats 
# Plate_1 blank to correct ==	0.0821	
# Plate_2 blank	to correct == 0.0831

# correct standards (subtract out the blank) and average
BCA_standards_means <- BCA_standards %>% 
                        #dplyr::filter(!Type %in% 'Standard_0') %>% 
                        dplyr::mutate(Abs_562nm_cor = 
                                     case_when(Plate == 1 ~ (Abs_562nm-0.0821),
                                               Plate == 2 ~ (Abs_562nm-0.0831) ) ) %>% 
                        dplyr::select(Unique_ID, Plate, BCA_ug_mL, Abs_562nm_cor) %>% # select columns 
                        dplyr::group_by(Unique_ID, Plate, BCA_ug_mL) %>% # group by to get the means
                        dplyr::summarise_each(funs(mean,sd,se=sd(.)/sqrt(n()))) # get all the stats 

# quadratic standard curve
BCA_stand_plots_quadratic <- BCA_standards_means %>% # QUADRATIC SMOOTH LINE WORKS BEST HERE (MANUFACTURERS INSTRUCTIONS)
                     #dplyr::filter(!BCA_ug_mL %in% 25) %>% # hash me out to test
                     ggplot(aes(y=mean, x=BCA_ug_mL)) + 
                        geom_point() +
                        theme_bw() +
                        labs(y= "Net Absorbance at 562nm", x = "Protein Concentration in ug/mL") +
                        #geom_line() +
                        #stat_poly_line(color='red') +
                        #geom_smooth() +
                        stat_smooth(method = "lm", formula = y ~ x + I(x^2), size = 1) +
                        stat_poly_eq(parse=T, aes(label = ..eq.label..), formula=y ~ x + I(x^2)) +
                        ggtitle('Quadratic') +
                        #stat_poly_eq(use_label(c("eq", "R2"))) +
                        facet_wrap(~Plate) 

# Linear standards based on the last few - this is important if we have high unknowns resulting in negative descriminant
BCA_stand_plots_linear <- BCA_standards_means %>% # QUADRATIC SMOOTH LINE WORKS BEST HERE (MANUFACTURERS INSTRUCTIONS)
                     dplyr::filter(!BCA_ug_mL %in% c('0','25','125')) %>% # hash me out to test
                     ggplot(aes(y=mean, x=BCA_ug_mL)) + 
                        geom_point() +
                        theme_bw() +
                        labs(y= "Net Absorbance at 562nm", x = "Protein Concentration in ug/mL") +
                        #geom_line() +
                        #stat_poly_line(color='red') +
                        #geom_smooth() +
                        stat_smooth(method = "lm", formula = y ~ x, size = 1) +
                        stat_poly_eq(parse=T, aes(label = ..eq.label..), formula=y ~ x) +
                        ggtitle('Linear - for negative desriminant') +
                        #stat_poly_eq(use_label(c("eq", "R2"))) +
                        facet_wrap(~Plate) 

#print these standard figures
pdf(paste("Output/Colorimetric_assays/BCA_MDAcorrection/Standard_Curve_BCA_MDAcorrection.pdf", sep =''), 
    width=10, 
    height=7)
print(ggarrange(BCA_stand_plots_quadratic,BCA_stand_plots_linear))
dev.off()

# Note: plates 1 and 2 were completed in quick succession, loaded at the same time with a ~5 minute lag between  them 
# strangely, the standard curve for plate 1 is much different, suggesting possible error? 
# BCA completed for ATP correction found very similar quadratic EQs to the plate 2, we will move forward with ONE 
# curve EQ for all unknowns (plate 2)

# Standard curve, Plate 2 equation y = 0.045 + 0.00125x - 1.3x10^-7x^2 - need to solve for x!

# * (5) Calculate Total protein per sample; subtract out background + correct for standard curve +  average

# Remember!.. from above we have the following blanks to correct unknowns
# Plate_1 blank to correct ==	0.0821	
# Plate_2 blank	to correct == 0.0831

# Quadratic Standard curve, Plate 2 (use for plate 1 also!)
a <- -1.2*10^-7
b <- 0.00125
c <- 0.045
# EQ: (-(b1) + sqrt( (b1^2) - (4*(((a1)-Abs_562nm_cor))*(c1)) ))/(2*a1)

# Linear Standard curve, Plate 2 (use in case of neg discrim, high values undetermined via quadratic
slope = 0.00108
yint  = 0.143

# IMPORTANT! we used 25 ul of the standards and 25 ul of the unknowns (samples) 
# therefore we can interpret the unknown direct to the the standard curve without having 
# to account for addition factors, fot example, if we used 5 ul unknown (sample) we would have to adjust 
# by multiplying by 5 to reach the standard curve 

V = 0.025 # 25 ul or 0.025 mL

TotalProtein_final <- raw_BCA_merged_om %>% 
                      dplyr::filter(Type %in% 'Sample') %>% # call samples
                      dplyr::mutate(Unique_ID = 
                                      paste0('Plate_',Plate,'_', Scallop_ID)) %>% # unique ID t0 group by
                      dplyr::mutate(Abs_562nm_cor = # correct the raw abs, subtract background
                                   case_when(Plate == 1 ~ (Abs_562nm-0.0821), # for plate 1
                                             Plate == 2 ~ (Abs_562nm-0.0831) ) ) %>% # for plate 2 
                      dplyr::mutate(TotalProtein_ug_mL = 
                                      case_when(
                                        # case when abs > 3.3, use the plate 2 linear model to extrapolate 
                                        Abs_562nm_cor > 3.3 ~ ((Abs_562nm-yint)/slope),
                                        # else, run plate 2 quadratic
                                        TRUE ~ ((-(b) + sqrt( (b^2) - (4*a*(c-Abs_562nm_cor)) ) ) / (2*a))),
                                    # convert ug per mL concentration to ug in 25 ul sample 
                                    TotalProtein_ug = TotalProtein_ug_mL*V) %>% 
                      dplyr::group_by(Day,pCO2_history,pCO2_exposure,
                                      Unique_ID, Plate, Scallop_ID) %>% # group by to get the means
                      dplyr::summarise(mean_TotalProtein_ug = mean(TotalProtein_ug),
                                       sd_TotalProtein_ug   = sd(TotalProtein_ug),
                                       n = n(),
                                       se_TotalProtein_ug  = sd_TotalProtein_ug / sqrt(n))

# View(TotalProtein_final)
nrow(TotalProtein_final) # 65


# write csv
write.csv(TotalProtein_final, file = "Output/Colorimetric_assays/BCA_MDAcorrection/Calc_Master_BCA_MDAcorrection.csv")

```


# Finalize MDA data 

- Objs: 

  * (1) Merge by the common 'Scallop_ID' and retain all rows in the colorimetric data (all=T)
  - Why? We unfortunately found that that the dewar was not properly unloaded 
  on day 14 of the experiment, below we can reveal replicates that were lost (hence 'NAs' via merge below)
  
  * (2) omit NAs - empty wells (no sample or standard)
  
  * (3) separate standards from samples
  
  * (4) Run standard curve, calculate totalprotein
  
  * (5) Calculate MDA; subtract out background + correct for standard curve +  average +
  
  
```{r MDA data}

raw_MDA <- read.csv(file = "Data/Colorimetric_assays/MDA/Raw_Master_MDA.csv", head = T)
# * (1) Merge by the common 'Scallop_ID' and retain all rows in the colorimetric data (all=T)
# - Why? We unfortunately found that that the dewar was not properly unloaded 
# on day 14 of the experiment, below we can reveal replicates that were lost (hence 'NAs' via merge below)
raw_MDA_merged    <- merge(raw_MDA, Exp_metadata, by='Scallop_ID', all=TRUE)

lost_gill_samples <- raw_MDA_merged %>% dplyr::filter(Abs_695nm_no_path_correct %in% NA)
nrow(lost_gill_samples) # 26 samples lost
  


# * (2) ommit NAs - empty wells (no sample or standard)
raw_MDA_merged_om <- raw_MDA_merged %>% dplyr::filter(!Type %in% NA)
nrow(raw_MDA_merged_om) # 156


# * (3) separate standards from samples, format the standards
MDA_standards <- raw_MDA_merged_om %>% 
                    dplyr::filter(grepl('Standard', Type)) %>% # grepl for 'contains' string
                    dplyr::mutate(MDA_µmol = 
                                    as.numeric(gsub('.*_','',Type))) %>% # (i.e. 25 in 'Standards_25')
                    dplyr::mutate(Unique_ID = paste0(Run_date,'_', Type))



# * (4) Run standard curve, calculate totalprotein 
MDA_background_zero <- MDA_standards %>% 
                        dplyr::filter(Type %in% 'Standard_0') %>% 
                        dplyr::filter(!Plate == 1) %>% # plate 1 standards were bad - loads of bubbles in pipette error
                        dplyr::select(Unique_ID, Run_date, MDA_µmol, Abs_695nm_no_path_correct) %>% # select columns of interest
                        dplyr::group_by(Unique_ID, Run_date, MDA_µmol) %>% # group by to get the means
                        summarise_each(funs(mean,sd,se=sd(.)/sqrt(n()))) # get all the stats 
# 20231004_Standard_0	20231004	==	0.04155


MDA_standards_means <- MDA_standards %>% 
                        dplyr::filter(!(Type %in% 'Standard_0' & Plate == 1)) %>% # ommit stand 0 for just plate 1
                        dplyr::mutate(Abs_695nm_cor = (Abs_695nm_no_path_correct-0.04155)) %>% 
                        dplyr::select(Unique_ID, Run_date, MDA_µmol, Abs_695nm_cor) %>% # select columns 
                        dplyr::group_by(Unique_ID, Run_date, MDA_µmol) %>% # group by to get the means
                        dplyr::summarise_each(funs(mean,sd,se=sd(.)/sqrt(n()))) # get all the stats 

MDA_stand_plots <- MDA_standards_means %>% # LINEAR WORKS WELL
                     #dplyr::filter(!ATP_nmol %in% 0) %>%  # ommit zeros
                     ggplot(aes(y=mean, x=MDA_µmol)) + 
                        geom_point() +
                        theme_bw() +
                        #geom_line() +
                        stat_poly_line() +
                        labs(y= "OD 695nm", x = "MDA (nmol, known standards)") +
                        stat_poly_eq(use_label(c("eq", "R2"))) +
                        facet_wrap(~Run_date) 
MDA_stand_plots
#print
pdf(paste("Output/Colorimetric_assays/MDA/Standard_Curve_MDA.pdf", sep =''), 
    width=10, 
    height=7)
print(MDA_stand_plots)
dev.off()

# Run_date 20231004, y = 0.000563x - 0.0182



# * (5) Calculate Total protein per sample; subtract out background + correct for standard curve +  average
# Background correction,  blank to correct by is 0.04155

# Standard curve, x = ((Abs_570nm -0.0182)/0.000563) - NOTE, below we have OD and are solving for x (ATP nmol)


# MDA concentration = (B/V * D) * DDF
# * B = the concentration in µmol MDA from the standard curve 
# * V = the volume added to each well 
# * D = dilution volume if sample was diluted to fit the curve (d/n apply here)
# * DDF = the deproteinization dilution factor LOOK THIS OVER WE ADDED 25 ul TO THE SAMPLE

V = 0.0005 # 50 in ul; as liters = 0.0005
# side note: Malondialdehyde molecular weight = 72.0636 g/mol

# IMPORTANT! we used 50 ul of the standards and 50 ul of the unknowns (samples) 
# therefore we can interpret the unknown direct to the the standard curve without having 
# to account for addition factors in order to infer µmol Malondialdehyde 

MDA_final <- raw_MDA_merged_om %>% 
                      dplyr::filter(Type %in% 'Sample') %>% # call samples
                      dplyr::mutate(Unique_ID = 
                                      paste0(Run_date,'_', Type, Scallop_ID)) %>% # unique ID t0 group by
                      dplyr::mutate(Abs_695nm_cor = # correct the raw abs, subtract background
                                   Abs_695nm_no_path_correct - 0.04155) %>% # for all data
                      dplyr::mutate(MDA_µmol = # correct the raw value by stnadard curve
                                      (Abs_695nm_cor - 0.0182) /0.000563) %>% 
                      dplyr::group_by(Day,Run_date,pCO2_history,pCO2_exposure,Scallop_ID) %>% # group by to get the means
                      dplyr::summarise(mean_MDA_µmol = mean(MDA_µmol),
                                       sd_MDA_µmol   = sd(MDA_µmol),
                                       n = n(),
                                       se_MDA_µmol   = sd_MDA_µmol / sqrt(n))
# write csv
write.csv(MDA_final, file = "Output/Colorimetric_assays/MDA/Calc_Master_MDA.csv")

```


Finally we are here... the moment of truth! 

# MERGE MDA WITH TOTAL PROTEIN DATA 
```{r}

MDA_final            <- read.csv(file = "Output/Colorimetric_assays/MDA/Calc_Master_MDA.csv", head = T)
MDA_final_prepmerge  <- MDA_final[,c(2,4:6,7)]# call Day, pH exposures, scallop ID and mean MDA concentration

TotalProtein_final     <- read.csv(file = "Output/Colorimetric_assays/BCA_MDAcorrection/Calc_Master_BCA_MDAcorrection.csv", head = T)
TotalProtein_prepmerge <- TotalProtein_final[,c(2:4,7,8)] # call Day, pH exposures, scallop ID and mean ug total protein

# IMPORTANT! the MDA assay used 50 ul sample whereas BCA used 25 ul of sample
# therefore to relate MDA to total protein we must divide MDA by 2

MERGED_DF <- merge(MDA_final_prepmerge, 
                   TotalProtein_prepmerge, 
                   all=T)  %>% # looks like we have 3 absent values for total protein..
                dplyr::mutate(MDA_µmol_ug_protein = (mean_MDA_µmol/2)/mean_TotalProtein_ug) # 50 ul for ATP well and 25 ul for BCA well
# View(MERGED_DF) # view the file for any NAs


# IMPORTANT! one individual did not have enough supernatant to run total protein, listed below as NAs
# Day 1 ID 33 (moderate history x low exposure)
MERGED_DF %>% dplyr::filter(MDA_µmol_ug_protein %in% NA) # ID 33 whats up????

# lets see the mean_TotalProtein_ug for these treatments  
aggregate(MERGED_DF$mean_TotalProtein_ug, list(MERGED_DF$Day, 
                                               MERGED_DF$pCO2_history,
                                               MERGED_DF$pCO2_exposure
                                               ), FUN=mean, na.rm=TRUE)
# Day 1 moderate history low exposure == 45.97052	(for ID 33)


MASTER_DF <- merge(MDA_final_prepmerge, 
                   TotalProtein_prepmerge, 
                   all=T)  %>% # looks like we have 3 absent values for total protein..
                dplyr::mutate(mean_TotalProtein_ug = 
                                case_when(
                                  Scallop_ID %in% 33 ~ 45.97052, # manually based on treatment averages, no sample for protein 
                                  TRUE ~ mean_TotalProtein_ug),
                              MDA_µmol_µg_protein = (mean_MDA_µmol/2)/mean_TotalProtein_ug)

# View(MASTER_DF)
# write csv
write.csv(MASTER_DF, file = "Output/Colorimetric_assays/MDA/MDA_Master.csv")

```

# FIGURES 


```{r}

MASTER_DF <- read.csv(file = "Output/Colorimetric_assays/MDA/MDA_Master.csv", head = T)

ggplot(MASTER_DF, aes(mean_MDA_µmol,mean_TotalProtein_ug)) +
  geom_point() +
  stat_smooth(method = "lm", formula = y ~ x, size = 1) +
  theme_bw() +
  facet_wrap(~pCO2_history)

ggplot(MASTER_DF, aes(mean_MDA_µmol,mean_TotalProtein_ug)) +
  geom_point()+
  stat_smooth(method = "lm", formula = y ~ x, size = 1) +
  theme_bw() +
  facet_wrap(~pCO2_exposure)

ggplot(MASTER_DF, aes(mean_MDA_µmol,mean_TotalProtein_ug)) +
  geom_point()+
  stat_smooth(method = "lm", formula = y ~ x, size = 1) +
  theme_bw() 
```


* MDA (NOT corrected)
```{r}
MDA_master <- read.csv(file = "Output/Colorimetric_assays/MDA/MDA_Master.csv", head = T)

Day1_MDA_RxnNorm <- MDA_final %>% # data %>%
  dplyr::filter(Day == 1) %>% # filter for desired date of rhte experiment
  dplyr::mutate(mean_MDA_µmol = as.numeric(mean_MDA_µmol)) %>% 
  dplyr::select(c('Day','pCO2_exposure','pCO2_history','mean_MDA_µmol')) %>% 
  na.omit() %>%   
  # we have means (from x2 assay reps per individual), now mean by treatment!
  group_by(pCO2_exposure, pCO2_history) %>% # group by columns for treatment
  dplyr::summarise( # summarise to acquire the mean and SE for plotting
    MDA_mean = mean(mean_MDA_µmol), # mean
    MDA_sd = sd(mean_MDA_µmol), # sd
    MDA_n = n(), # count
    MDA_se = MDA_sd / sqrt(MDA_n)) %>% # SE
  # plot it
  ggplot(aes(x=pCO2_exposure, y=MDA_mean, group=pCO2_history)) + # call the new mean
    geom_line(aes(group = factor(pCO2_history), 
                  linetype = pCO2_history), 
              size = 0.5, 
              position=position_dodge(.4)) +  # connect a line between variables
    scale_linetype_manual(values=c("solid", "dashed", "dotted")) +
    geom_point(aes(shape=pCO2_history, fill=pCO2_history), size = 4.5,position=position_dodge(.4)) + 
    scale_shape_manual(values=c(21, 22, 24)) + # filled circle, filled triangle, and X 
    scale_fill_manual(values=c("#009E73","#E69F00", "#CC79A7")) + # fill circles
    geom_errorbar(aes(ymin=(MDA_mean)-(MDA_se), # new means and se by treatment
                      ymax=(MDA_mean)+(MDA_se)), # new means and se by treatment
                  width=0,position=position_dodge(.4)) + # width determines the length of the end ticks
    theme_classic() +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "none") + 
    ggtitle("MDA (not corrected) Day 1") +
    # scale_y_continuous(expand = c(0, 0), limits = c(0, 4)) + # true 0 origin
    scale_y_continuous(expand = c(0, 0), limits = c(0, 350)) + # true 0 origin
    labs(y= "MDA (µmol)", x = "pCO2 Exposure")
# Day1_MDA_RxnNorm # view the plot


Day14_MDA_RxnNorm <- MDA_final %>% # data %>%
  dplyr::filter(Day == 14) %>% # filter for desired date of rhte experiment
  dplyr::mutate(mean_MDA_nmol = as.numeric(mean_MDA_µmol)) %>% 
  dplyr::select(c('Day','pCO2_exposure','pCO2_history','mean_MDA_µmol')) %>% 
  na.omit() %>%   
  # we have means (from x2 assay reps per individual), now mean by treatment!
  group_by(pCO2_exposure, pCO2_history) %>% # group by columns for treatment
  dplyr::summarise( # summarise to acquire the mean and SE for plotting
    MDA_mean = mean(mean_MDA_µmol), # mean
    MDA_sd = sd(mean_MDA_µmol), # sd
    MDA_n = n(), # count
    MDA_se = MDA_sd / sqrt(MDA_n)) %>% # SE
  # plot it
  ggplot(aes(x=pCO2_exposure, y=MDA_mean, group=pCO2_history)) + # call the new mean
    geom_line(aes(group = factor(pCO2_history), 
                  linetype = pCO2_history), 
              size = 0.5, 
              position=position_dodge(.4)) +  # connect a line between variables
    scale_linetype_manual(values=c("solid", "dashed", "dotted")) +
    geom_point(aes(shape=pCO2_history, fill=pCO2_history), size = 4.5,position=position_dodge(.4)) + 
    scale_shape_manual(values=c(21, 22, 24)) + # filled circle, filled triangle, and X 
    scale_fill_manual(values=c("#009E73","#E69F00", "#CC79A7")) + # fill circles
    geom_errorbar(aes(ymin=(MDA_mean)-(MDA_se), # new means and se by treatment
                      ymax=(MDA_mean)+(MDA_se)), # new means and se by treatment
                  width=0,position=position_dodge(.4)) + # width determines the length of the end ticks
    theme_classic() +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "none") + 
    ggtitle("MDA (not corrected) Day 14") +
    # scale_y_continuous(expand = c(0, 0), limits = c(0, 4)) + # true 0 origin
    scale_y_continuous(expand = c(0, 0), limits = c(0, 350)) + # true 0 origin
    labs(y= "MDA (µmol)", x = "pCO2 Exposure")
# Day14_MDA_RxnNorm # view the plot

# save plots
pdf("Output/Colorimetric_assays/MDA/MDA_uncorrected_RxnNorm.pdf", width = 7, height = 5)
ggarrange(Day1_MDA_RxnNorm,Day14_MDA_RxnNorm, ncol=2)
dev.off()
```


* ATP (corrected for total protein)
```{r}
MASTER_DF <- read.csv(file = "Output/Colorimetric_assays/MDA/MDA_Master.csv", head = T)

Day1_MDA_RxnNorm <- MASTER_DF %>% # data %>%
  dplyr::filter(Day == 1) %>% # filter for desired date of rhte experiment
  dplyr::mutate(MDA_µmol_µg_protein = as.numeric(MDA_µmol_µg_protein)) %>% 
  dplyr::select(c('Day','pCO2_exposure','pCO2_history','MDA_µmol_µg_protein')) %>% 
  na.omit() %>%   
  # we have means (from x2 assay reps per individual), now mean by treatment!
  group_by(pCO2_exposure, pCO2_history) %>% # group by columns for treatment
  dplyr::summarise( # summarise to acquire the mean and SE for plotting
    MDA_mean = mean(MDA_µmol_µg_protein), # mean
    MDA_sd = sd(MDA_µmol_µg_protein), # sd
    MDA_n = n(), # count
    MDA_se = MDA_sd / sqrt(MDA_n)) %>% # SE
  # plot it
  ggplot(aes(x=pCO2_exposure, y=MDA_mean, group=pCO2_history)) + # call the new mean
    geom_line(aes(group = factor(pCO2_history), 
                  linetype = pCO2_history), 
              size = 0.5, 
              position=position_dodge(.4)) +  # connect a line between variables
    scale_linetype_manual(values=c("solid", "dashed", "dotted")) +
    geom_point(aes(shape=pCO2_history, fill=pCO2_history), size = 4.5,position=position_dodge(.4)) + 
    scale_shape_manual(values=c(21, 22, 24)) + # filled circle, filled triangle, and X 
    scale_fill_manual(values=c("#009E73","#E69F00", "#CC79A7")) + # fill circles
    geom_errorbar(aes(ymin=(MDA_mean)-(MDA_se), # new means and se by treatment
                      ymax=(MDA_mean)+(MDA_se)), # new means and se by treatment
                  width=0,position=position_dodge(.4)) + # width determines the length of the end ticks
    theme_classic() +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "none") + 
    ggtitle("MDA, Day 1") +
    # scale_y_continuous(expand = c(0, 0), limits = c(0, 50)) + # true 0 origin
    # scale_y_continuous(expand = c(0, 0), limits = c(0, 2.5)) + # true 0 origin
    labs(y= "MDA (µmol µg protein-1)", x = "pCO2 Exposure")
# Day1_MDA_RxnNorm # view the plot


Day14_MDA_RxnNorm <- MASTER_DF %>% # data %>%
  dplyr::filter(Day == 14) %>% # filter for desired date of rhte experiment
  dplyr::mutate(MDA_µmol_µg_protein = as.numeric(MDA_µmol_µg_protein)) %>% 
  dplyr::select(c('Day','pCO2_exposure','pCO2_history','MDA_µmol_µg_protein')) %>% 
  na.omit() %>%   
  # we have means (from x2 assay reps per individual), now mean by treatment!
  group_by(pCO2_exposure, pCO2_history) %>% # group by columns for treatment
  dplyr::summarise( # summarise to acquire the mean and SE for plotting
    MDA_mean = mean(MDA_µmol_µg_protein), # mean
    MDA_sd = sd(MDA_µmol_µg_protein), # sd
    MDA_n = n(), # count
    MDA_se = MDA_sd / sqrt(MDA_n)) %>% # SE
  # plot it
  ggplot(aes(x=pCO2_exposure, y=MDA_mean, group=pCO2_history)) + # call the new mean
    geom_line(aes(group = factor(pCO2_history), 
                  linetype = pCO2_history), 
              size = 0.5, 
              position=position_dodge(.4)) +  # connect a line between variables
    scale_linetype_manual(values=c("solid", "dashed", "dotted")) +
    geom_point(aes(shape=pCO2_history, fill=pCO2_history), size = 4.5,position=position_dodge(.4)) + 
    scale_shape_manual(values=c(21, 22, 24)) + # filled circle, filled triangle, and X 
    scale_fill_manual(values=c("#009E73","#E69F00", "#CC79A7")) + # fill circles
    geom_errorbar(aes(ymin=(MDA_mean)-(MDA_se), # new means and se by treatment
                      ymax=(MDA_mean)+(MDA_se)), # new means and se by treatment
                  width=0,position=position_dodge(.4)) + # width determines the length of the end ticks
    theme_classic() +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "none") + 
    ggtitle("MDA, Day 14") +
    # scale_y_continuous(expand = c(0, 0), limits = c(0, 50)) + # true 0 origin
    # scale_y_continuous(expand = c(0, 0), limits = c(0, 2.5)) + # true 0 origin
    labs(y= "MDA (µmol µg protein-1)", x = "pCO2 Exposure")
# Day14_MDA_RxnNorm # view the plot

# save plots
pdf("Output/Colorimetric_assays/MDA/MDA_proteincorrect_RxnNorm.pdf", width = 7, height = 5)
ggarrange(Day1_MDA_RxnNorm,Day14_MDA_RxnNorm, ncol=2)
dev.off()

```

```{r pCO2 history match v. mismatch}


LowpCO2_MatchMismatch_RxnNorm <- MASTER_DF %>% # data %>%
  dplyr::filter(pCO2_history == 'low') %>% # filter for desired date of rhte experiment
  dplyr::mutate(MDA_µmol_µg_protein = as.numeric(MDA_µmol_µg_protein)) %>% 
  dplyr::select(c('Day','pCO2_exposure','pCO2_history','MDA_µmol_µg_protein')) %>% 
  na.omit() %>%   
  dplyr::mutate(Match_Mismatch = 
                  case_when(pCO2_exposure == 'low' ~ 'match',
                            TRUE ~ 'mismatch')) %>% 
  # we have means (from x2 assay reps per individual), now mean by treatment!
  group_by(Day, Match_Mismatch) %>% # group by columns for treatment
  dplyr::summarise( # summarise to acquire the mean and SE for plotting
    MDA_mean = mean(MDA_µmol_µg_protein), # mean
    MDA_sd = sd(MDA_µmol_µg_protein), # sd
    MDA_n = n(), # count
    MDA_se = MDA_sd / sqrt(MDA_n)) %>% # SE
  # plot it
  ggplot(aes(x=as.factor(Day), y=MDA_mean, group=Match_Mismatch)) + # call the new mean
    geom_line(aes(group = factor(Match_Mismatch), 
                  linetype = Match_Mismatch), 
              size = 0.5, 
              position=position_dodge(.4)) +  # connect a line between variables
    scale_linetype_manual(values=c("solid", "dashed")) +
    geom_point(aes(shape=Match_Mismatch, fill=Match_Mismatch), size = 4.5,position=position_dodge(.4)) + 
    scale_shape_manual(values=c(21, 22, 24)) + # filled circle, filled triangle, and X 
    scale_fill_manual(values=c("#009E73", "black")) + # fill circles
    geom_errorbar(aes(ymin=(MDA_mean)-(MDA_se), # new means and se by treatment
                      ymax=(MDA_mean)+(MDA_se)), # new means and se by treatment
                  width=0,position=position_dodge(.4)) + # width determines the length of the end ticks
    theme_classic() +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "none") + 
    ggtitle("Low pCO2 history - Match v. mismatch") +
    # scale_y_continuous(expand = c(0, 0), limits = c(10, 40)) + # true 0 origin
    # scale_y_continuous(expand = c(0, 0), limits = c(0, 2.5)) + # true 0 origin
    labs(y= "MDA (umol ug protein-1)", x = "Time exposed (days)")

ModeratepCO2_MatchMismatch_RxnNorm <- MASTER_DF %>% # data %>%
  dplyr::filter(pCO2_history == 'moderate') %>% # filter for desired date of rhte experiment
  dplyr::mutate(ATP_nmol_ng_protein = as.numeric(ATP_nmol_ng_protein)) %>% 
  dplyr::select(c('Day','pCO2_exposure','pCO2_history','ATP_nmol_ng_protein')) %>% 
  na.omit() %>%   
  dplyr::mutate(Match_Mismatch = 
                  case_when(pCO2_exposure == 'moderate' ~ 'match',
                            TRUE ~ 'mismatch')) %>% 
  # we have means (from x2 assay reps per individual), now mean by treatment!
  group_by(Day, Match_Mismatch) %>% # group by columns for treatment
  dplyr::summarise( # summarise to acquire the mean and SE for plotting
    ATP_mean = mean(ATP_nmol_ng_protein), # mean
    ATP_sd = sd(ATP_nmol_ng_protein), # sd
    ATP_n = n(), # count
    ATP_se = ATP_sd / sqrt(ATP_n)) %>% # SE
  # plot it
  ggplot(aes(x=as.factor(Day), y=ATP_mean, group=Match_Mismatch)) + # call the new mean
    geom_line(aes(group = factor(Match_Mismatch), 
                  linetype = Match_Mismatch), 
              size = 0.5, 
              position=position_dodge(.4)) +  # connect a line between variables
    scale_linetype_manual(values=c("solid", "dashed")) +
    geom_point(aes(shape=Match_Mismatch, fill=Match_Mismatch), size = 4.5,position=position_dodge(.4)) + 
    scale_shape_manual(values=c(21, 22, 24)) + # filled circle, filled triangle, and X 
    scale_fill_manual(values=c("#E69F00", "black")) + # fill circles
    geom_errorbar(aes(ymin=(ATP_mean)-(ATP_se), # new means and se by treatment
                      ymax=(ATP_mean)+(ATP_se)), # new means and se by treatment
                  width=0,position=position_dodge(.4)) + # width determines the length of the end ticks
    theme_classic() +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "none") + 
    ggtitle("Moderate pCO2 history - Match v. mismatch") +
    scale_y_continuous(expand = c(0, 0), limits = c(10, 40)) + # true 0 origin
    # scale_y_continuous(expand = c(0, 0), limits = c(0, 2.5)) + # true 0 origin
    labs(y= "ATP (nmol ng protein-1)", x = "Time exposed (days)")


HighpCO2_MatchMismatch_RxnNorm <- MASTER_DF %>% # data %>%
  dplyr::filter(pCO2_history == 'severe') %>% # filter for desired date of rhte experiment
  dplyr::mutate(ATP_nmol_ng_protein = as.numeric(ATP_nmol_ng_protein)) %>% 
  dplyr::select(c('Day','pCO2_exposure','pCO2_history','ATP_nmol_ng_protein')) %>% 
  na.omit() %>%   
  dplyr::mutate(Match_Mismatch = 
                  case_when(pCO2_exposure == 'severe' ~ 'match',
                            TRUE ~ 'mismatch')) %>% 
  # we have means (from x2 assay reps per individual), now mean by treatment!
  group_by(Day, Match_Mismatch) %>% # group by columns for treatment
  dplyr::summarise( # summarise to acquire the mean and SE for plotting
    ATP_mean = mean(ATP_nmol_ng_protein), # mean
    ATP_sd = sd(ATP_nmol_ng_protein), # sd
    ATP_n = n(), # count
    ATP_se = ATP_sd / sqrt(ATP_n)) %>% # SE
  # plot it
  ggplot(aes(x=as.factor(Day), y=ATP_mean, group=Match_Mismatch)) + # call the new mean
    geom_line(aes(group = factor(Match_Mismatch), 
                  linetype = Match_Mismatch), 
              size = 0.5, 
              position=position_dodge(.4)) +  # connect a line between variables
    scale_linetype_manual(values=c("solid", "dashed")) +
    geom_point(aes(shape=Match_Mismatch, fill=Match_Mismatch), size = 4.5,position=position_dodge(.4)) + 
    scale_shape_manual(values=c(21, 22, 24)) + # filled circle, filled triangle, and X 
    scale_fill_manual(values=c("#CC79A7", "black")) + # fill circles
    geom_errorbar(aes(ymin=(ATP_mean)-(ATP_se), # new means and se by treatment
                      ymax=(ATP_mean)+(ATP_se)), # new means and se by treatment
                  width=0,position=position_dodge(.4)) + # width determines the length of the end ticks
    theme_classic() +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "none") + 
    ggtitle("High pCO2 history - Match v. mismatch") +
    scale_y_continuous(expand = c(0, 0), limits = c(10, 40)) + # true 0 origin
    # scale_y_continuous(expand = c(0, 0), limits = c(0, 2.5)) + # true 0 origin
    labs(y= "ATP (nmol ng protein-1)", x = "Time exposed (days)")

ggarrange(LowpCO2_MatchMismatch_RxnNorm,
          ModeratepCO2_MatchMismatch_RxnNorm,
          HighpCO2_MatchMismatch_RxnNorm,
          nrow=3)
```


* Total Protein 
```{r}

MASTER_DF <- read.csv(file = "Output/Colorimetric_assays/ATP/ATP_Master.csv", head = T)


Day1_TotalProtein_RxnNorm <- MASTER_DF %>% # data %>%
  dplyr::filter(Day == 1) %>% # filter for desired date of rhte experiment
  dplyr::mutate(mean_TotalProtein_ng = as.numeric(mean_TotalProtein_ng)) %>% 
  dplyr::select(c('Day','pCO2_exposure','pCO2_history','mean_TotalProtein_ng')) %>% 
  na.omit() %>%   
  # we have means (from x2 assay reps per individual), now mean by treatment!
  group_by(pCO2_exposure, pCO2_history) %>% # group by columns for treatment
  dplyr::summarise( # summarise to acquire the mean and SE for plotting
    TP_mean = mean(mean_TotalProtein_ng), # mean
    TP_sd = sd(mean_TotalProtein_ng), # sd
    TP_n = n(), # count
    TP_se = TP_sd / sqrt(TP_n)) %>% # SE
  # plot it
  ggplot(aes(x=pCO2_exposure, y=TP_mean, group=pCO2_history)) + # call the new mean
    geom_line(aes(group = factor(pCO2_history), 
                  linetype = pCO2_history), 
              size = 0.5, 
              position=position_dodge(.4)) +  # connect a line between variables
    scale_linetype_manual(values=c("solid", "dashed", "dotted")) +
    geom_point(aes(shape=pCO2_history, fill=pCO2_history), size = 4.5,position=position_dodge(.4)) + 
    scale_shape_manual(values=c(21, 22, 24)) + # filled circle, filled triangle, and X 
    scale_fill_manual(values=c("#009E73","#E69F00", "#CC79A7")) + # fill circles
    geom_errorbar(aes(ymin=(TP_mean)-(TP_se), # new means and se by treatment
                      ymax=(TP_mean)+(TP_se)), # new means and se by treatment
                  width=0,position=position_dodge(.4)) + # width determines the length of the end ticks
    theme_classic() +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "none") + 
    # scale_y_continuous(expand = c(0, 0), limits = c(0, 3)) + # true 0 origin
    scale_y_continuous(expand = c(0, 0), limits = c(0, 0.15)) + # true 0 origin
    ggtitle("Total Protein, Day 1") +
    labs(y= "Total Protie (ng mL)", x = "Days")
# Day1_TotalProtein_RxnNorm # view the plot


Day14_TotalProtein_RxnNorm <- MASTER_DF %>% # data %>%
  dplyr::filter(Day == 14) %>% # filter for desired date of rhte experiment
  dplyr::mutate(mean_TotalProtein_ng = as.numeric(mean_TotalProtein_ng)) %>% 
  dplyr::select(c('Day','pCO2_exposure','pCO2_history','mean_TotalProtein_ng')) %>% 
  na.omit() %>%   
  # we have means (from x2 assay reps per individual), now mean by treatment!
  group_by(pCO2_exposure, pCO2_history) %>% # group by columns for treatment
  dplyr::summarise( # summarise to acquire the mean and SE for plotting
    TP_mean = mean(mean_TotalProtein_ng), # mean
    TP_sd = sd(mean_TotalProtein_ng), # sd
    TP_n = n(), # count
    TP_se = TP_sd / sqrt(TP_n)) %>% # SE
  # plot it
  ggplot(aes(x=pCO2_exposure, y=TP_mean, group=pCO2_history)) + # call the new mean
    geom_line(aes(group = factor(pCO2_history), 
                  linetype = pCO2_history), 
              size = 0.5, 
              position=position_dodge(.4)) +  # connect a line between variables
    scale_linetype_manual(values=c("solid", "dashed", "dotted")) +
    geom_point(aes(shape=pCO2_history, fill=pCO2_history), size = 4.5,position=position_dodge(.4)) + 
    scale_shape_manual(values=c(21, 22, 24)) + # filled circle, filled triangle, and X 
    scale_fill_manual(values=c("#009E73","#E69F00", "#CC79A7")) + # fill circles
    geom_errorbar(aes(ymin=(TP_mean)-(TP_se), # new means and se by treatment
                      ymax=(TP_mean)+(TP_se)), # new means and se by treatment
                  width=0,position=position_dodge(.4)) + # width determines the length of the end ticks
    theme_classic() +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "none") + 
    # scale_y_continuous(expand = c(0, 0), limits = c(0, 3)) + # true 0 origin
    scale_y_continuous(expand = c(0, 0), limits = c(0, 0.15)) + # true 0 origin
    ggtitle("Total Protein, Day 14") +
    labs(y= "Total Protien (ng mL)", x = "pCO2 Exposure")
# Day14_TotalProtein_RxnNorm # view the plot

# save plots
pdf("Output/Colorimetric_assays/BCA_ATPcorrection/TotalProtein_RxnNorm.pdf", width = 7, height = 5)
ggarrange(Day1_TotalProtein_RxnNorm,Day14_TotalProtein_RxnNorm, ncol=2)
dev.off()


```



```{r stats - for loop for pCO2 history}

MASTER_DF <- read.csv(file = "Output/Colorimetric_assays/ATP/ATP_Master.csv", head = T)

# for loop d
Day  <- as.data.frame(list(unique(as.character(MASTER_DF$Day))))

# for loop i
pCO2history_treatments  <- as.data.frame(list(unique(paste(MASTER_DF$pCO2_history))))

# for loop m
Colorimetric_assays          <- as.data.frame(list(c('ATP_nmol_ng_protein',
                                                'mean_TotalProtein_ng')))

# prepare data for analysis
data <- MASTER_DF %>% 
  dplyr::select(c("Day","pCO2_history","pCO2_exposure",
                  "ATP_nmol_ng_protein","mean_TotalProtein_ng")) 

# Call the cumulative dataframe that we will write to in the for loop below
df_total              <- data.frame() # start dataframe 
stats.table           <- data.frame(matrix(nrow = 1, ncol = 10)) # create dataframe to save cumunalitively during for loop
colnames(stats.table) <- c('Day', 
                          'pCO2_history',
                          'Colorimetric_assays', 
                          'Test', 
                          'Shapiro', 
                          'Levenes',
                          'DF',
                          'Fvalue',
                          'chisquared',
                          'Pvalue') # names for comuns in the for loop


# RUN TE FOR LOOP!

for (d in 1:nrow(Day)) {
  
  x <- (Day[d,])
  data_by_Day <- data %>% 
        dplyr::filter(Day %in% x)
  
  for (i in 1:nrow(pCO2history_treatments)) {
    
    # filter the dataset 
    data_by_history <- data_by_Day %>% 
      dplyr::filter(pCO2_history %in% pCO2history_treatments[i,1]) 
      #dplyr::filter(pCO2_exposure %in% gsub('.* ', '', treatments[i,1])) 
    
      for (m in 1:nrow(Colorimetric_assays)) {
        
        # if loop for probe type-speicif testing based on the naure of the data..
          
        colNum   <- which( colnames(data_by_history)==Colorimetric_assays[m,])
        data_by_history[,colNum] = as.numeric(data_by_history[,colNum])
        modAOV   <- aov(lm(data_by_history[,colNum]~pCO2_exposure, data = data_by_history))
        shapTEST <- shapiro.test(resid(modAOV))
        levTEST  <- leveneTest(modAOV)
        
            # within continuous data.. run either ANOVA or Kruskal Wallis based on normality testing..
            if(shapTEST$p.value> 0.05 & levTEST$`Pr(>F)`[1] > 0.05) { # if normal - run anova
              
              modSUMMARY     <- summary(modAOV) # create anova table summary
              modSUMMARYDF   <- signif(modSUMMARY[[1]][["Df"]][1], 2) # cal p value for anova table - 2 sig figs
              modSUMMARYFval <- signif(modSUMMARY[[1]][["F value"]][1], 4) # cal p value for anova table - 2 sig figs
              modSUMMARYchi  <- NA  
              modSUMMARYPval <- signif(modSUMMARY[[1]][["Pr(>F)"]][1], 4) # cal p value for anova table - 2 sig figs
              testRun        <- "One-way ANOVA"
              
            } else { # if non-normal (either shapiro OR levenes defied) - run the Kruskal Wallis
              
              modSUMMARY     <- kruskal.test(data_by_history[,colNum] ~ pCO2_exposure, data = data_by_history) 
              modSUMMARYDF   <- signif(modSUMMARY[[2]], 2) # cal p value for Kruskal wallis test table - 2 sig figs
              modSUMMARYFval <- NA
              modSUMMARYchi  <- signif(modSUMMARY[[1]], 4) # cal p value for Kruskal wallis test table - 2 sig figs
              modSUMMARYPval <- signif(modSUMMARY[[3]], 4) # cal p value for Kruskal wallis test table - 2 sig figs
              testRun        <- "Kruskal Wallis"
            } # close the if else loop for probe type-specific testing (we are still in the the 'm' for loop!)
        
        stats.table$Day           <- data_by_history$Day[1]
        stats.table$pCO2_history  <- pCO2history_treatments[i,]
        stats.table$Colorimetric_assays   <- Colorimetric_assays[m,]
        stats.table$Test          <- testRun
        if (shapTEST[1] == 'NA') {
          stats.table$Shapiro = 'NA'} else {stats.table$Shapiro <- shapTEST$p.value}
        if (levTEST[1,1] == 'NA') {
          stats.table$Levenes = 'NA'} else {stats.table$Levenes <- levTEST$`Pr(>F)`[1]}
        stats.table$DF            <- modSUMMARYDF
        stats.table$Fvalue        <- modSUMMARYFval
        stats.table$chisquared    <- modSUMMARYchi
        stats.table$Pvalue        <- modSUMMARYPval
        
        df       <- data.frame(stats.table) # name dataframe for this single row
        df_total <- rbind(df_total,df) #bind to a cumulative list dataframe
        # print(df_total) # print to monitor progress      
        
          } # close 'm' for loop - through each flow cy probe
    
    } # close 'i' for loop - through each pCO2 history (low, moderate, severe)
  
} # close 'd' for loop - through each sampling data (5/2/2023 and 5/16/2023)

# View(df_total)
df_total
  # summary(aov(lm(SYBR_PI_count_dead~pCO2_`exposure,data=low)))
```



```{r stats run Two-Way tests}
library(rcompanion) # to run the Schrier -Ray-Hare non parametric 2 way 

# Day 1 data
MASTER_DF_d1 <- MASTER_DF %>% dplyr::filter(Day %in% 1)

# test ATP
Day1_ATP_AOV <- aov(lm(ATP_nmol_ng_protein ~ pCO2_history*pCO2_exposure, data=MASTER_DF_d1))
shapiro.test(resid(Day1_ATP_AOV)) # 0.0001624- non normal
leveneTest(Day1_ATP_AOV) # 0.5982 PASS variance test
Day1_ATP_AOV_SRH <- scheirerRayHare(ATP_nmol_ng_protein ~ pCO2_history*pCO2_exposure, data=MASTER_DF_d1)
Day1_ATP_AOV_SRH
#                            Df Sum Sq      H p.value
# pCO2_history                2  229.7 1.3318 0.51381
# pCO2_exposure               2  252.1 1.4616 0.48151
# pCO2_history:pCO2_exposure  4 1293.3 7.4976 0.11182
# Residuals                  36 5814.8


# Day 14 data
MASTER_DF_d14 <- MASTER_DF %>% dplyr::filter(Day %in% 14)

# test ATP
Day14_ATP_AOV <- aov(lm(ATP_nmol_ng_protein ~ pCO2_history*pCO2_exposure, data=MASTER_DF_d14))
shapiro.test(resid(Day14_ATP_AOV)) # 0.9328 normal
leveneTest(Day14_ATP_AOV) # 9.574e-07 *** NO PASS variance test
Day14_ATP_AOV_SRH <- scheirerRayHare(ATP_nmol_ng_protein ~ pCO2_history*pCO2_exposure, data=MASTER_DF_d14)
Day14_ATP_AOV_SRH
#                            Df Sum Sq      H p.value
# pCO2_history                2  49.80 1.4229 0.49094
# pCO2_exposure               2  26.25 0.7500 0.68729
# pCO2_history:pCO2_exposure  4 142.20 4.0629 0.39757
# Residuals                  11 446.75


```

# one way anovas within history, exposure effect
```{r, one way ANOVA effects of exposure}
library(rcompanion) # to run the Schrier -Ray-Hare non parametric 2 way 

# Day 1 data
MASTER_DF_d1 <- MASTER_DF %>% dplyr::filter(Day %in% 1)

MASTER_DF_d1_LOW <- MASTER_DF_d1 %>% dplyr::filter(pCO2_history %in% 'low')
Day1_ATP_AOV_LOW <- aov(lm(ATP_nmol_ng_protein ~ pCO2_exposure, data=MASTER_DF_d1_LOW))
shapiro.test(resid(Day1_ATP_AOV_LOW)) # 0.7476 normal
leveneTest(Day1_ATP_AOV_LOW) #  0.6173  PASS variance test
summary(Day1_ATP_AOV_LOW)
#               Df Sum Sq Mean Sq F value Pr(>F)  
# pCO2_exposure  2  308.7  154.35   3.846 0.0512 .
# Residuals     12  481.5   40.13

MASTER_DF_d1_MOD <- MASTER_DF_d1 %>% dplyr::filter(pCO2_history %in% 'moderate')
Day1_ATP_AOV_MOD <- aov(lm(ATP_nmol_ng_protein ~ pCO2_exposure, data=MASTER_DF_d1_MOD))
shapiro.test(resid(Day1_ATP_AOV_MOD)) # 0.09701 normal
leveneTest(Day1_ATP_AOV_MOD) #  0.5746  PASS variance test
summary(Day1_ATP_AOV_MOD)
#               Df Sum Sq Mean Sq F value Pr(>F)
# pCO2_exposure  2   71.2    35.6   0.273  0.766
# Residuals     12 1565.0   130.4

MASTER_DF_d1_SEV <- MASTER_DF_d1 %>% dplyr::filter(pCO2_history %in% 'severe')
Day1_ATP_AOV_SEV <- aov(lm(ATP_nmol_ng_protein ~ pCO2_exposure, data=MASTER_DF_d1_SEV))
shapiro.test(resid(Day1_ATP_AOV_SEV)) # 0.005418 NON normal
leveneTest(Day1_ATP_AOV_SEV) #  0.3667 PASS variance test
Day1_ATP_SEV_KW <- kruskal.test(ATP_nmol_ng_protein ~ pCO2_exposure, data=MASTER_DF_d1_SEV)
Day1_ATP_SEV_KW
# Kruskal-Wallis chi-squared = 0.96, df = 2, p-value = 0.6188






# Day 14 data
MASTER_DF_d14 <- MASTER_DF %>% dplyr::filter(Day %in% 14)

MASTER_DF_d14_LOW <- MASTER_DF_d14 %>% dplyr::filter(pCO2_history %in% 'low')
Day14_ATP_AOV_LOW <- aov(lm(ATP_nmol_ng_protein ~ pCO2_exposure, data=MASTER_DF_d14_LOW))
shapiro.test(resid(Day14_ATP_AOV_LOW)) # 0.5464 normal
leveneTest(Day14_ATP_AOV_LOW) #   < 2.2e-16 *** NO PASS variance test
Day14_ATP_LOW_KW <- kruskal.test(ATP_nmol_ng_protein ~ pCO2_exposure, data=MASTER_DF_d14_LOW)
Day14_ATP_LOW_KW
# Kruskal-Wallis chi-squared = 0.4, df = 2, p-value = 0.8187

MASTER_DF_d14_MOD <- MASTER_DF_d14 %>% dplyr::filter(pCO2_history %in% 'moderate')
Day14_ATP_AOV_MOD <- aov(lm(ATP_nmol_ng_protein ~ pCO2_exposure, data=MASTER_DF_d14_MOD))
shapiro.test(resid(Day14_ATP_AOV_MOD)) # 0.1213 normal
leveneTest(Day14_ATP_AOV_MOD) #  < 2.2e-16 ***  NO PASS variance test
Day14_ATP_MOD_KW <- kruskal.test(ATP_nmol_ng_protein ~ pCO2_exposure, data=MASTER_DF_d14_MOD)
Day14_ATP_MOD_KW
# Kruskal-Wallis chi-squared = 3.6, df = 2, p-value = 0.1653

MASTER_DF_d14_SEV <- MASTER_DF_d14 %>% dplyr::filter(pCO2_history %in% 'severe')
Day14_ATP_AOV_SEV <- aov(lm(ATP_nmol_ng_protein ~ pCO2_exposure, data=MASTER_DF_d14_SEV))
shapiro.test(resid(Day14_ATP_AOV_SEV)) # 0.792 normal
leveneTest(Day14_ATP_AOV_SEV) #  0.01186 *  PASS variance test
Day14_ATP_SEV_KW <- kruskal.test(ATP_nmol_ng_protein ~ pCO2_exposure, data=MASTER_DF_d14_SEV)
Day14_ATP_SEV_KW
# Kruskal-Wallis chi-squared = 2.9182, df = 2, p-value = 0.2324

```

# one way anovas within exposure, history effect
```{r, one way ANOVA effects of history}
library(rcompanion) # to run the Schrier -Ray-Hare non parametric 2 way 

# Day 1 data
MASTER_DF_d1 <- MASTER_DF %>% dplyr::filter(Day %in% 1)

MASTER_DF_d1_LOW <- MASTER_DF_d1 %>% dplyr::filter(pCO2_exposure %in% 'low')
Day1_ATP_AOV_LOW <- aov(lm(ATP_nmol_ng_protein ~ pCO2_history, data=MASTER_DF_d1_LOW))
shapiro.test(resid(Day1_ATP_AOV_LOW)) # 0.8536 normal
leveneTest(Day1_ATP_AOV_LOW) #  0.5721  PASS variance test
summary(Day1_ATP_AOV_LOW)
#              Df Sum Sq Mean Sq F value Pr(>F)  
# pCO2_history  2  341.0  170.48   4.706  0.031 *
# Residuals    12  434.7   36.23
TukeyHSD(Day1_ATP_AOV_LOW)
#                      diff        lwr       upr     p adj
# moderate-low    11.313717   1.157924 21.469509 0.0291432
# severe-low       8.164200  -1.991592 18.319993 0.1222530
# severe-moderate -3.149516 -13.305309  7.006276 0.6938877


MASTER_DF_d1_MOD <- MASTER_DF_d1 %>% dplyr::filter(pCO2_exposure %in% 'moderate')
Day1_ATP_AOV_MOD <- aov(lm(ATP_nmol_ng_protein ~ pCO2_history, data=MASTER_DF_d1_MOD))
shapiro.test(resid(Day1_ATP_AOV_MOD)) # 0.009256 NON normal
leveneTest(Day1_ATP_AOV_MOD) #  0.567  PASS variance test
Day1_ATP_MOD_KW <- kruskal.test(ATP_nmol_ng_protein ~ pCO2_history, data=MASTER_DF_d1_MOD)
Day1_ATP_MOD_KW
# Kruskal-Wallis chi-squared = 0.98, df = 2, p-value = 0.6126

MASTER_DF_d1_SEV <- MASTER_DF_d1 %>% dplyr::filter(pCO2_exposure %in% 'severe')
Day1_ATP_AOV_SEV <- aov(lm(ATP_nmol_ng_protein ~ pCO2_history, data=MASTER_DF_d1_SEV))
shapiro.test(resid(Day1_ATP_AOV_SEV)) # 0.258 NON normal
leveneTest(Day1_ATP_AOV_SEV) #  0.4152 PASS variance test
summary(Day1_ATP_AOV_SEV)
#              Df Sum Sq Mean Sq F value Pr(>F)
# pCO2_history  2   20.2   10.11    0.15  0.863
# Residuals    12  810.0   67.50 





# Day 14 data
MASTER_DF_d14 <- MASTER_DF %>% dplyr::filter(Day %in% 14)

MASTER_DF_d14_LOW <- MASTER_DF_d14 %>% dplyr::filter(pCO2_exposure %in% 'low')
Day14_ATP_AOV_LOW <- aov(lm(ATP_nmol_ng_protein ~ pCO2_history, data=MASTER_DF_d14_LOW))
shapiro.test(resid(Day14_ATP_AOV_LOW)) # 0.8218 normal
leveneTest(Day14_ATP_AOV_LOW) #    0.001459 ** NO PASS variance test
Day14_ATP_LOW_KW <- kruskal.test(ATP_nmol_ng_protein ~ pCO2_history, data=MASTER_DF_d14_LOW)
Day14_ATP_LOW_KW
# Kruskal-Wallis chi-squared = 0.5, df = 2, p-value = 0.7788

MASTER_DF_d14_MOD <- MASTER_DF_d14 %>% dplyr::filter(pCO2_exposure %in% 'moderate')
Day14_ATP_AOV_MOD <- aov(lm(ATP_nmol_ng_protein ~ pCO2_history, data=MASTER_DF_d14_MOD))
shapiro.test(resid(Day14_ATP_AOV_MOD)) # 0.683 normal
leveneTest(Day14_ATP_AOV_MOD) #   < 2.2e-16 *** NO PASS variance test
Day14_ATP_MOD_KW <- kruskal.test(ATP_nmol_ng_protein ~ pCO2_history, data=MASTER_DF_d14_MOD)
Day14_ATP_MOD_KW
# Kruskal-Wallis chi-squared = 1.8, df = 2, p-value = 0.4066

MASTER_DF_d14_SEV <- MASTER_DF_d14 %>% dplyr::filter(pCO2_exposure %in% 'severe')
Day14_ATP_AOV_SEV <- aov(lm(ATP_nmol_ng_protein ~ pCO2_history, data=MASTER_DF_d14_SEV))
shapiro.test(resid(Day14_ATP_AOV_SEV)) # 0.3469 normal
leveneTest(Day14_ATP_AOV_SEV) #  0.0001975 *** NO  PASS variance test
Day14_ATP_SEV_KW <- kruskal.test(ATP_nmol_ng_protein ~ pCO2_history, data=MASTER_DF_d14_SEV)
Day14_ATP_SEV_KW
# Kruskal-Wallis chi-squared = 2.8333, df = 2, p-value = 0.2425

```

