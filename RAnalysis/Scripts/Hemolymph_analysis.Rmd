---
title: "Hemolymph_analysis"
author: "Samuel Gurr"
date: "2023-05-09"
output: html_notebook
---

-   Last updates: May 5/9/2023

# OA Reexposure Challenge

### May 2023: F2 Adult Bay scallops exposed to a two-week full-reciprocal pCO2 challenge

### Objective: plot and analyze flow cytometry data for (a) SYBR green and propidium iodide - cell viability (b) MitoSox gree - mitochondrial ROS (c) JC-10 - mitochondrial membrane potential corrected for CCCP

## Load Libraries

```{r startup, include=FALSE}


library(betareg) # runs a beta regression model suotable for proportion (percent data) between 0 and 1 (our live and dead cells data)
library(lmtest) # to receive p value from betareg model
library(FSA) # for the Dun test post hoc for SRH non-parametric 2 way anova]
library(emmeans)
library(ggplot2)
library(dplyr)
library(tidyverse)
library(car)
library(lmerTest)
library(tidyr)
library(reshape2)
library(ggpubr)
library(nlme)
library(rcompanion) # to run the Schrier -Ray-Hare non parametric 2 way 
knitr::opts_knit$set(root.dir = "C:/Users/samjg/Documents/Github_repositories/Airradians_Reexposure_OA/RAnalysis") # sets the working directory for the entire R markdown file - no need to reload the wd
```

## Load flow cytometry data

**NOTE**: the statistics option ion C6 PLus software was used to compile the data (i.e. mean FL1) - the following loaded data file was assembled manually to include the sample metadata (i.e. data, treatments, etc.) as well as these flow cytometry data

```{r load data}
getwd()
# read data 
data  <- read.csv(file="../Data/FlowCytometry/Hemolymph_data_raw.csv", header = TRUE) %>% 
  dplyr::mutate(Scallop_ID = as.character(Scallop_ID))

# filter out data points based on visual diagnositcs of flow cytometry data 
# criterion being, but not limited to, uninterpretable clouds showing no biological importance
# these data were (in most cases) specific to a probe and not the whole individual across all measurements

data_filt <- data %>%
  
# PERCENT/PROPORTION LIVE AND DEAD CELLS 
    # first denote NAs for SYBR + PI = 51 and 59 and 60
    dplyr::mutate(SYBR_PI_count_alive= #as.numeric(sub(",", "", SYBR_PI_count_alive))) %>% 
            # ifelse(Scallop_ID %in% c('20', '51', '59', '56', '60', '70', '87', '89'), 
              ifelse(Scallop_ID %in% 5,
                     NA, as.numeric(sub(",", "", SYBR_PI_count_alive)))) %>% # for #s insert Na, else insert oG data

    dplyr::mutate(SYBR_PI_count_dead= #as.numeric(sub(",", "", SYBR_PI_count_dead))) %>% 
            # ifelse(Scallop_ID %in% c('20', '51', '59', '56', '60', '70', '87', '89'), 
              ifelse(Scallop_ID %in% 5,
                     NA, as.numeric(sub(",", "", SYBR_PI_count_dead)))) %>% # for #s insert Na, else insert oG data 
  
# MITOCHONDRIAL SUPEROXIDE DISMUTASE 
    # NA for mitosox green data day 1: = #s 24 and 74
    # NA for mitosox green data day 14: 50 (no events), 27 (no/minimal events), 56 (cont. likely), 87 (strange density), 90 (cut off, but okay)
    dplyr::mutate(MitoSoxGreen_Mean_FL1 = #as.numeric(sub(",", "", MitoSoxGreen_Mean_FL1))) %>% 
             # ifelse(Scallop_ID %in% c('24', '74', '27','50','56','87'), 
              ifelse(Scallop_ID %in% 5,
                     NA, as.numeric(sub(",", "", MitoSoxGreen_Mean_FL1)))) %>% # for #s insert Na, else insert oG data 
  
# MITOCHONDRIAL MEMBRANE POTENTIAL DATA 
    # NA for JC-10 = 12,13, 51, 74
    dplyr::mutate(JC10_FL1_monomer=
            ifelse(Scallop_ID %in% c('12', '13', '51', '74'), NA, JC10_FL1_monomer)) %>% # for #s insert Na, else insert oG data insert oG data 
    dplyr::mutate(JC10_FL2_Jaggregate=
            ifelse(Scallop_ID %in% c('12', '13', '51', '74'), NA, JC10_FL2_Jaggregate)) %>% # for #s insert Na, else insert oG data insert oG data
    # calculate the FL2:FL1 ratio - this is our core data for this metric!
    dplyr::mutate(JC10_FL2_FL1_Ratio = ( (as.numeric(sub(",", "", JC10_FL2_Jaggregate))) / 
                             (as.numeric(sub(",", "", JC10_FL1_monomer))) ))  %>% 

# ADJUSTED PERCENT DATA - CHANGE TO PROPORTION 0-1
    # the current precent alive and dead is proportion to ALL events of the cytogram - including those NOT dyed by SYBR and PI
    # here we do an ADJ percent calc through sum of ONLY the live and dead events for a new 100
    # second, adjusted 100% for ONLY counts live and dead
    dplyr::mutate(SYBR_PI_prop_alive_ADJ = (SYBR_PI_count_alive/(SYBR_PI_count_alive+SYBR_PI_count_dead))) %>% 
    dplyr::mutate(SYBR_PI_prop_dead_ADJ = (SYBR_PI_count_dead/(SYBR_PI_count_alive+SYBR_PI_count_dead))) 


# FILTER DATA FOR THE DAY 1 AND DAY 14 DATA 
Day1_datafilt  <- data_filt %>% dplyr::filter(Date %in% 20230502)
Day14_datafilt <- data_filt %>% dplyr::filter(Date %in% 20230516)
 
# View(data)
# View(data_filt)
```

## Plot data 

### Cell viability (Live vs. dead)

* SYBRgreen + propidium iodide, gated using the FL2 to reveal true peaks (PE-H) 

* data comprised of percent live and dead

```{r plot live dead}


# 24 HOURS 

# stacked proportion plot



Day1_PropLive_RxnNorm <- data_filt %>% # data %>%
  # edit data to suit out needs
  dplyr::filter(Date %in% 20230502) %>% # filter for desired date of rhte experiment
  dplyr::select(c('Date','pCO2_exposure','pCO2_history','SYBR_PI_prop_alive_ADJ')) %>% 
  na.omit() %>%  
  group_by(pCO2_exposure, pCO2_history) %>% # group by columns for treatment
  dplyr::summarise( # summarise to aquire the mean and SE for plotting
    PercLive_mean = mean(SYBR_PI_prop_alive_ADJ), # mean
    PercLive_sd = sd(SYBR_PI_prop_alive_ADJ), # sd
    n = n(), # count
    PercLive_se = PercLive_sd / sqrt(n)) %>% # SE
  # plot it
  ggplot(aes(x=pCO2_exposure, y=PercLive_mean, group=pCO2_history)) + 
    geom_line(aes(group = factor(pCO2_history), linetype = pCO2_history), size = 0.5, position=position_dodge(.4)) +  # connect a line between variables
    scale_linetype_manual(values=c("solid", "dashed", "dotted")) +
    geom_point(aes(shape=pCO2_history, fill=pCO2_history), size = 4,position=position_dodge(.4)) + 
    scale_shape_manual(values=c(16, 17, 4)) + # filled circle, filled triangle, and X 
    scale_fill_manual(values=c('white','white', 'black')) + # fill cicle white, triangle white, and jsut black for the X
    geom_errorbar(aes(ymin=(PercLive_mean)-(PercLive_se), 
                      ymax=(PercLive_mean)+(PercLive_se)), 
                  width=.2,position=position_dodge(.4)) +
    # geom_jitter() +
    theme_classic() +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + 
    ggtitle("Percent alive cells - 24 hours") +
    labs(y= "Percent alive cells (%)", x = "pCO2 Exposure") # +
   # facet_wrap(~pCO2_history)
Day1_PropLive_RxnNorm





Day1_PropDead_RxnNorm <- data_filt %>% # data %>%
  # edit data to suit out needs
  dplyr::filter(Date %in% 20230502) %>% # filter for desired date of rhte experiment
  dplyr::select(c('Date','pCO2_exposure','pCO2_history','SYBR_PI_prop_dead_ADJ')) %>% 
  na.omit() %>%  
  group_by(pCO2_exposure, pCO2_history) %>% # group by columns for treatment
  dplyr::summarise( # summarise to aquire the mean and SE for plotting
    PercDead_mean = mean(SYBR_PI_prop_dead_ADJ), # mean
    PercDead_sd = sd(SYBR_PI_prop_dead_ADJ), # sd
    n = n(), # count
    PercDead_se = PercDead_sd / sqrt(n)) %>% # SE
  # plot it
  ggplot(aes(x=pCO2_exposure, y=PercDead_mean, group=pCO2_history)) + 
    geom_line(aes(group = factor(pCO2_history), linetype = pCO2_history), size = 0.5, position=position_dodge(.4)) +  # connect a line between variables
    scale_linetype_manual(values=c("solid", "dashed", "dotted")) +
    geom_point(aes(shape=pCO2_history, fill=pCO2_history), size = 4,position=position_dodge(.4)) + 
    scale_shape_manual(values=c(16, 17, 4)) + # filled circle, filled triangle, and X 
    scale_fill_manual(values=c('white','white', 'black')) + # fill cicle white, triangle white, and jsut black for the X
    geom_errorbar(aes(ymin=(PercDead_mean)-(PercDead_se), 
                      ymax=(PercDead_mean)+(PercDead_se)), 
                  width=.2,position=position_dodge(.4)) +
    # geom_jitter() +
    theme_classic() +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + 
    ggtitle("Percent dead cells - 24 hours") +
    labs(y= "Percent dead cells (%)", x = "pCO2 Exposure") #+
   # facet_wrap(~pCO2_history)
Day1_PropDead_RxnNorm


ggarrange(Day1_PropLive_RxnNorm, Day1_PropDead_RxnNorm)


# DAY 14 OF EXPERIMENT 



Day14_PropLive_RxnNorm <- data_filt %>% # data %>%
  # edit data to suit out needs
  dplyr::filter(Date %in% 20230516) %>% # filter for desired date of rhte experiment
  dplyr::select(c('Date','pCO2_exposure','pCO2_history','SYBR_PI_prop_alive_ADJ')) %>% 
  na.omit() %>%  
  group_by(pCO2_exposure, pCO2_history) %>% # group by columns for treatment
  dplyr::summarise( # summarise to aquire the mean and SE for plotting
    PercLive_mean = mean(SYBR_PI_prop_alive_ADJ), # mean
    PercLive_sd = sd(SYBR_PI_prop_alive_ADJ), # sd
    n = n(), # count
    PercLive_se = PercLive_sd / sqrt(n)) %>% # SE
  # plot it
  ggplot(aes(x=pCO2_exposure, y=PercLive_mean, group=pCO2_history)) + 
    geom_line(aes(group = factor(pCO2_history), linetype = pCO2_history), size = 0.5, position=position_dodge(.4)) +  # connect a line between variables
    scale_linetype_manual(values=c("solid", "dashed", "dotted")) +
    geom_point(aes(shape=pCO2_history, fill=pCO2_history), size = 4,position=position_dodge(.4)) + 
    scale_fill_manual(values=c('white','white', 'black')) + # fill cicle white, triangle white, and jsut black for the X
    geom_errorbar(aes(ymin=(PercLive_mean)-(PercLive_se), 
                      ymax=(PercLive_mean)+(PercLive_se)), 
                  width=.2,position=position_dodge(.4)) +
    # geom_jitter() +
    theme_classic() +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + 
    scale_shape_manual(values=c(16, 17, 4)) + # filled circle, filled triangle, and X 
    ggtitle("Percent alive cells - 14 days") +
    labs(y= "Percent alive cells (%)", x = "pCO2 Exposure") #+
    #facet_wrap(~pCO2_history)
Day14_PropLive_RxnNorm



Day14_PropDead_RxnNorm <- data_filt %>% # data %>%
  # edit data to suit out needs
  dplyr::filter(Date %in% 20230516) %>% # filter for desired date of rhte experiment
  dplyr::select(c('Date','pCO2_exposure','pCO2_history','SYBR_PI_prop_dead_ADJ')) %>% 
  na.omit() %>%  
  group_by(pCO2_exposure, pCO2_history) %>% # group by columns for treatment
  dplyr::summarise( # summarise to aquire the mean and SE for plotting
    PercDead_mean = mean(SYBR_PI_prop_dead_ADJ), # mean
    PercDead_sd = sd(SYBR_PI_prop_dead_ADJ), # sd
    n = n(), # count
    PercDead_se = PercDead_sd / sqrt(n)) %>% # SE
  # plot it
  ggplot(aes(x=pCO2_exposure, y=PercDead_mean, group=pCO2_history)) + 
    geom_line(aes(group = factor(pCO2_history), linetype = pCO2_history), size = 0.5, position=position_dodge(.4)) +  # connect a line between variables
    scale_linetype_manual(values=c("solid", "dashed", "dotted")) +
    geom_point(aes(shape=pCO2_history, fill=pCO2_history), size = 4,position=position_dodge(.4)) + 
    theme_classic() +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + 
    scale_shape_manual(values=c(16, 17, 4)) + # filled circle, filled triangle, and X 
    scale_fill_manual(values=c('white','white', 'black')) + # fill cicle white, triangle white, and jsut black for the X
    geom_errorbar(aes(ymin=(PercDead_mean)-(PercDead_se), 
                      ymax=(PercDead_mean)+(PercDead_se)), 
                  width=.2,position=position_dodge(.4)) +
    theme_classic() +
    ggtitle("Percent dead cells - 14 days") +
    labs(y= "Percent dead cells (%)", x = "pCO2 Exposure")# +
   # facet_wrap(~pCO2_history)
Day14_PropDead_RxnNorm

ggarrange(Day14_PropLive_RxnNorm, Day14_PropDead_RxnNorm)




library(ggrepel)
data_filt %>% # data %>%
  # edit data to suit out needs
  dplyr::filter(Date %in% 20230516) %>% # filter for desired date of rhte experiment
  dplyr::select(c('Date','Scallop_ID','pCO2_exposure','pCO2_history','SYBR_PI_prop_alive_ADJ')) %>% 
  na.omit() %>% 
  dplyr::filter(!Scallop_ID %in% 5) %>% 
 # dplyr::filter(!Scallop_ID %in% 5) 
  ggplot(aes(x=pCO2_exposure, y=SYBR_PI_prop_alive_ADJ, label=Scallop_ID)) + 
      geom_boxplot(alpha = 0.5) +
      #geom_dotplot(binaxis = 'y', stackdir='center', dotsize=1) +
      #geom_text_repel(arrow = arrow(length=unit(0.2,"npc")),box.padding=1) +
      theme_bw()+
      geom_text(aes(label=Scallop_ID), size = 3.5) +
     # #scale_color_manual(values = c("#0072B2", "#D55E00")) + # colorblindness palette blue and orange
     #  theme_classic() +
     #  theme(legend.position = "none") +
      facet_wrap(~pCO2_history)


# STACKED BAR PLOTS - i thin this is the best way to display the data 
pd <- position_dodge2(width = 0.2)
Day1_StackedBar <- data_filt %>% # data %>%
    # edit data to suit out needs
    dplyr::filter(Date %in% 20230502) %>% # filter for desired date of rhte experiment
    dplyr::select(c('Date','pCO2_exposure','pCO2_history','SYBR_PI_prop_alive_ADJ', 'SYBR_PI_prop_dead_ADJ')) %>% 
    na.omit() %>%
    tidyr::pivot_longer(!c(Date,pCO2_exposure,pCO2_history), names_to = "Type", values_to = "Proportion") %>% 
    group_by(pCO2_exposure, pCO2_history, Type) %>% # group by columns for treatment
    dplyr::summarise( # summarise to aquire the mean and SE for plotting
    Perc_mean = mean(Proportion), # mean
    Perc_sd = sd(Proportion), # sd
    n = n(), # count
    Perc_se = Perc_sd / sqrt(n)) %>% # SE
    dplyr::mutate(y_pos = cumsum(Perc_mean)) %>% 
    dplyr::mutate(Type = factor(Type, levels=c('SYBR_PI_prop_dead_ADJ','SYBR_PI_prop_alive_ADJ'))) %>% #reorder for stacks
      ggplot(aes(x = pCO2_exposure, 
                 y = Perc_mean, 
                 fill = pCO2_history,
                 #group= pCO2_exposure,
                 alpha = Type)) + 
      geom_bar(stat = "identity", 
               width=0.7) + 
      scale_fill_manual(values = c("#009E73","#E69F00", "#CC79A7")) +
      #scale_fill_manual(values = c("#0072B2", "#D55E00")) + # colorblindness palette blue and orange
      geom_errorbar(aes(ymax = y_pos + Perc_se, 
                        ymin=  y_pos - Perc_se), 
                    stat = "identity", 
                    width = 0.1, # removed the error bar ticks
                    alpha = 0.7, 
                    position = pd) + 
      facet_wrap(~pCO2_history) + 
      scale_alpha_manual(values=c(seq(0.3,1, length.out = 3))) + 
      theme_classic() + 
      scale_y_continuous(breaks = seq(from = 0, to = 1, by = 0.10)) + 
      ylim(0,1.1)+
      theme(legend.position = "none") +
      ylab("Percent live v. dead hemocytes") +
      ggtitle("Day 1: Cell Viability") 
Day1_StackedBar



Day14_StackedBar <- data_filt %>% # data %>%
    # edit data to suit out needs
    dplyr::filter(Date %in% 20230516) %>% # filter for desired date of rhte experiment
    dplyr::select(c('Date','pCO2_exposure','pCO2_history','SYBR_PI_prop_alive_ADJ', 'SYBR_PI_prop_dead_ADJ')) %>% 
    na.omit() %>%
    tidyr::pivot_longer(!c(Date,pCO2_exposure,pCO2_history), names_to = "Type", values_to = "Proportion") %>% 
    group_by(pCO2_exposure, pCO2_history, Type) %>% # group by columns for treatment
    dplyr::summarise( # summarise to aquire the mean and SE for plotting
    Perc_mean = mean(Proportion), # mean
    Perc_sd = sd(Proportion), # sd
    n = n(), # count
    Perc_se = Perc_sd / sqrt(n)) %>% # SE
    dplyr::mutate(y_pos = cumsum(Perc_mean)) %>% 
    dplyr::mutate(Type = factor(Type, levels=c('SYBR_PI_prop_dead_ADJ','SYBR_PI_prop_alive_ADJ'))) %>% #reorder for stacks
      ggplot(aes(x = pCO2_exposure, 
                 y = Perc_mean, 
                 fill = pCO2_history,
                 #group= pCO2_exposure,
                 alpha = Type)) + 
      geom_bar(stat = "identity", 
               width=0.7) + 
      scale_fill_manual(values = c("#009E73","#E69F00", "#CC79A7")) +
      #scale_fill_manual(values = c("#0072B2", "#D55E00")) + # colorblindness palette blue and orange
      geom_errorbar(aes(ymax = y_pos + Perc_se, 
                        ymin=  y_pos - Perc_se), 
                    stat = "identity", 
                    width = 0.1, # removed the error bar ticks
                    alpha = 0.7, 
                    position = pd) + 
      facet_wrap(~pCO2_history) + 
      scale_alpha_manual(values=c(seq(0.3,1, length.out = 3))) + 
      theme_classic() + 
      scale_y_continuous(breaks = seq(from = 0, to = 1.1, by = 0.10)) + 
      ylim(0,1.1)+
      theme(legend.position = "none") +
      ylab("Percent live v. dead hemocytes") +
      ggtitle("Day 14: Cell Viability") 
Day14_StackedBar
```


### Mitochondrial reactive oxygen species 

* MitoSox Green, gated using the FL1 (FITC-H) and FL1 vs. FL2 to truncate cells (FITC-H v. PE-H)

* data is the Mean FL1 

```{r plot Mitochondrial ROS}

# 24 hours 

Day1_MitoROS_RxnNorm <- data_filt %>% # data %>%
  # edit data to suit out needs
  dplyr::filter(Date %in% 20230502) %>% # filter for desired date of rhte experiment
  dplyr::mutate(MitoSoxGreen_Mean_FL1 = as.numeric(MitoSoxGreen_Mean_FL1)) %>% 
  dplyr::select(c('Date','pCO2_exposure','pCO2_history','MitoSoxGreen_Mean_FL1')) %>% 
  na.omit() %>%   
  group_by(pCO2_exposure, pCO2_history) %>% # group by columns for treatment
  dplyr::summarise( # summarise to aquire the mean and SE for plotting
    MitROS_mean = mean(MitoSoxGreen_Mean_FL1), # mean
    MitROS_sd = sd(MitoSoxGreen_Mean_FL1), # sd
    n = n(), # count
    MitROS_se = MitROS_sd / sqrt(n)) %>% # SE
  # plot it
  ggplot(aes(x=pCO2_exposure, y=MitROS_mean, group=pCO2_history)) + 
    geom_line(aes(group = factor(pCO2_history), linetype = pCO2_history), size = 0.5, position=position_dodge(.4)) +  # connect a line between variables
    scale_linetype_manual(values=c("solid", "dashed", "dotted")) +
    geom_point(aes(shape=pCO2_history, fill=pCO2_history), size = 4.5,position=position_dodge(.4)) + 
    scale_shape_manual(values=c(21, 22, 24)) + # filled circle, filled triangle, and X 
    scale_fill_manual(values=c("#009E73","#E69F00", "#CC79A7")) + # fill cicle white, triangle white, and jsut black for the X
    geom_errorbar(aes(ymin=(MitROS_mean)-(MitROS_se), 
                      ymax=(MitROS_mean)+(MitROS_se)), 
                  width=0,position=position_dodge(.4)) + # width dtermines the length of the end ticks
    # geom_jitter() +
    theme_classic() +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "none") + 
    ggtitle("Mitochondrial ROS") +
    labs(y= "A.U.", x = "pCO2 Exposure") #+
    #facet_wrap(~pCO2_history)
Day1_MitoROS_RxnNorm


#  14 days

Day14_MitoROS_RxnNorm <- data_filt %>% # data %>%
  # edit data to suit out needs
  dplyr::filter(Date %in% 20230516) %>% # filter for desired date of rhte experiment
  dplyr::mutate(MitoSoxGreen_Mean_FL1 = as.numeric(sub(",", "", MitoSoxGreen_Mean_FL1))) %>% # the % sign is included making this a character, omit the percent and make numeric!
  dplyr::select(c('Date','pCO2_exposure','pCO2_history','MitoSoxGreen_Mean_FL1')) %>% 
  na.omit() %>%   
  group_by(pCO2_exposure, pCO2_history) %>% # group by columns for treatment
  dplyr::summarise( # summarise to aquire the mean and SE for plotting
    MitROS_mean = mean(MitoSoxGreen_Mean_FL1), # mean
    MitROS_sd = sd(MitoSoxGreen_Mean_FL1), # sd
    n = n(), # count
    MitROS_se = MitROS_sd / sqrt(n)) %>% # SE
  # plot it
  ggplot(aes(x=pCO2_exposure, y=MitROS_mean, group=pCO2_history)) + 
    geom_line(aes(group = factor(pCO2_history), linetype = pCO2_history), size = 0.5, position=position_dodge(.4)) +  # connect a line between variables
    scale_linetype_manual(values=c("solid", "dashed", "dotted")) +
    geom_point(aes(shape=pCO2_history, fill=pCO2_history), size = 4.5,position=position_dodge(.4)) + 
    scale_shape_manual(values=c(21, 22, 24)) + # filled circle, filled triangle, and X 
    scale_fill_manual(values=c("#009E73","#E69F00", "#CC79A7")) + # fill cicle white, triangle white, and jsut black for the X
    geom_errorbar(aes(ymin=(MitROS_mean)-(MitROS_se), 
                      ymax=(MitROS_mean)+(MitROS_se)), 
                  width=0,position=position_dodge(.4)) + # width dtermines the length of the end ticks
    # geom_jitter() +
    theme_classic() +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "none") + 
    ggtitle("Mitochondrial ROS") +
    labs(y= "A.U.", x = "pCO2 Exposure")# +
    #facet_wrap(~pCO2_history)
Day14_MitoROS_RxnNorm


data_filt %>% # data %>%
  # edit data to suit out needs
  dplyr::filter(Date %in% 20230516) %>% # filter for desired date of rhte experiment
  dplyr::select(c('Date','Scallop_ID','pCO2_exposure','pCO2_history','MitoSoxGreen_Mean_FL1')) %>% 
  na.omit() %>% 
  #dplyr::filter(!Scallop_ID %in% 5) %>% 
 # dplyr::filter(!Scallop_ID %in% 5) 
  ggplot(aes(x=pCO2_exposure, y=MitoSoxGreen_Mean_FL1, label=Scallop_ID)) + 
      geom_boxplot(alpha = 0.5) +
      #geom_dotplot(binaxis = 'y', stackdir='center', dotsize=1) +
      #geom_text_repel(arrow = arrow(length=unit(0.2,"npc")),box.padding=1) +
      theme_bw()+
      geom_text(aes(label=Scallop_ID), size = 3.5) +
     # #scale_color_manual(values = c("#0072B2", "#D55E00")) + # colorblindness palette blue and orange
     #  theme_classic() +
     #  theme(legend.position = "none") +
      facet_wrap(~pCO2_history)


ggarrange(Day1_MitoROS_RxnNorm, Day14_MitoROS_RxnNorm, nrow=2)

```

### Mitochondrial membrane potential

* JC-10 (compensated for CCCP), gated using the FL1 (FITC-H) and FL1 vs. FL2 to truncate cells (FITC-H v. PE-H)

* data is the ratio of 'red to gree' as the Jaggregate (positive membrane potential) : Monomer (low memrane potential) or the FL 2 : FL 1 

```{r plot Mitochondrial membrane potential}



# 24 hours
  
Day1_MitoMemPot_RxnNorm <- data_filt %>% # data %>%
  # edit data to suit out needs
  dplyr::filter(Date %in% 20230502) %>% # filter for desired date of rhte experiment
  dplyr::select(c('Date','pCO2_exposure','pCO2_history','JC10_FL2_FL1_Ratio')) %>% 
  na.omit() %>%  # omitts sample ID 64 that did not have sufficient hemolymph for this assay 
  #dplyr::select(c('pCO2_exposure', 'pCO2_history','SYBR_PI_count_alive')) %>%  # select desired columns
  group_by(pCO2_exposure, pCO2_history) %>% # group by columns for treatment
  dplyr::summarise( # summarise to aquire the mean and SE for plotting
    JC10_mean = mean(JC10_FL2_FL1_Ratio), # mean
    JC10_sd = sd(JC10_FL2_FL1_Ratio), # sd
    n = n(), # count
    JC10_se = JC10_sd / sqrt(n)) %>% # SE
  # plot it
  ggplot(aes(x=pCO2_exposure, y=JC10_mean, group=pCO2_history)) + 
    geom_line(aes(group = factor(pCO2_history), linetype = pCO2_history), size = 0.5, position=position_dodge(.4)) +  # connect a line between variables
    scale_linetype_manual(values=c("solid", "dashed", "dotted")) +
    geom_point(aes(shape=pCO2_history, fill=pCO2_history), size = 4.5,position=position_dodge(.4)) + 
    scale_shape_manual(values=c(21, 22, 24)) + # filled circle, filled triangle, and X 
    scale_fill_manual(values=c("#009E73","#E69F00", "#CC79A7")) + # fill cicle white, triangle white, and jsut black for the X
    geom_errorbar(aes(ymin=(JC10_mean)-(JC10_se), 
                      ymax=(JC10_mean)+(JC10_se)), 
                  width=.2,position=position_dodge(.4)) +
    # geom_jitter() +
    theme_classic() +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "none") + 
    ggtitle("Mitochondrial membrane potential") +
    labs(y= "A.U.", x = "pCO2 Exposure")# +
    #facet_wrap(~pCO2_history)
Day1_MitoMemPot_RxnNorm



# 14 days
  
Day14_MitoMemPot_RxnNorm <- data_filt %>% # data %>%
  # edit data to suit out needs
  dplyr::filter(Date %in% 20230516) %>% # filter for desired date of rhte experiment
  dplyr::select(c('Date','pCO2_exposure','pCO2_history','JC10_FL2_FL1_Ratio')) %>% 
  na.omit() %>%  # omitts sample ID 64 that did not have sufficient hemolymph for this assay 
  #dplyr::select(c('pCO2_exposure', 'pCO2_history','SYBR_PI_count_alive')) %>%  # select desired columns
  group_by(pCO2_exposure, pCO2_history) %>% # group by columns for treatment
  dplyr::summarise( # summarise to aquire the mean and SE for plotting
    JC10_mean = mean(JC10_FL2_FL1_Ratio), # mean
    JC10_sd = sd(JC10_FL2_FL1_Ratio), # sd
    n = n(), # count
    JC10_se = JC10_sd / sqrt(n)) %>% # SE
  # plot it
  ggplot(aes(x=pCO2_exposure, y=JC10_mean, group=pCO2_history)) + 
    geom_line(aes(group = factor(pCO2_history), linetype = pCO2_history), size = 0.5, position=position_dodge(.4)) +  # connect a line between variables
    scale_linetype_manual(values=c("solid", "dashed", "dotted")) +
    geom_point(aes(shape=pCO2_history, fill=pCO2_history), size = 4.5,position=position_dodge(.4)) + 
    scale_shape_manual(values=c(21, 22, 24)) + # filled circle, filled triangle, and X 
    scale_fill_manual(values=c("#009E73","#E69F00", "#CC79A7")) + # fill cicle white, triangle white, and jsut black for the X
    geom_errorbar(aes(ymin=(JC10_mean)-(JC10_se), 
                      ymax=(JC10_mean)+(JC10_se)), 
                  width=.2,position=position_dodge(.4)) +
    # geom_jitter() +
    theme_classic() +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "none") + 
    ggtitle("Mitochondrial membrane potential") +
    labs(y= "A.U.", x = "pCO2 Exposure") # +
    #facet_wrap(~pCO2_history)
Day14_MitoMemPot_RxnNorm

ggarrange(Day1_MitoMemPot_RxnNorm, Day14_MitoMemPot_RxnNorm, nrow= 2)



# data_filt %>% # data %>%
#   # edit data to suit out needs
#   dplyr::filter(Date %in% 20230516) %>% # filter for desired date of rhte experiment
#   dplyr::filter(!Scallop_ID %in% 5) %>% 
#   dplyr::select(c('Date','Scallop_ID','pCO2_exposure','pCO2_history','JC10_FL2_FL1_Ratio')) %>% 
#   na.omit() %>% 
#   ggplot(aes(x=pCO2_exposure, y=JC10_FL2_FL1_Ratio, label=Scallop_ID)) + 
#       geom_boxplot(alpha = 0.5) +
#       theme_bw()+
#       geom_text(aes(label=Scallop_ID), size = 3.5) +
#       facet_wrap(~pCO2_history)
# # 5 is an outlier for these data 
```

```{r output plots by date} 


# all 24 hours
Day1_Mitochondria_RxnNorm <- ggarrange(Day1_MitoROS_RxnNorm, Day1_MitoMemPot_RxnNorm, nrow =1)
pdf(paste0("C:/Users/samjg/Documents/Github_repositories/Airradians_CellularMolecular_OA/RAnalysis/Output/FlowCytometry/Day1_All_Plots.pdf"), height = 8, width = 8)
ggarrange(Day1_StackedBar, Day1_Mitochondria_RxnNorm, ncol=1)
dev.off()

# all day 14
Day14_Mitochondria_RxnNorm <- ggarrange(Day14_MitoROS_RxnNorm, Day14_MitoMemPot_RxnNorm, nrow =1)
pdf(paste0("C:/Users/samjg/Documents/Github_repositories/Airradians_CellularMolecular_OA/RAnalysis/Output/FlowCytometry/Day14_All_Plots.pdf"), height = 8, width = 8)
ggarrange(Day14_StackedBar, Day14_Mitochondria_RxnNorm, ncol=1)
dev.off()


# cell viability
pdf(paste0("C:/Users/samjg/Documents/Github_repositories/Airradians_CellularMolecular_OA/RAnalysis/Output/FlowCytometry/CellViability_StackedBar.pdf"), height = 8)
ggarrange(Day1_StackedBar, Day14_StackedBar, ncol=1)
dev.off()


# mitochondrialsuperoxide
pdf(paste0("C:/Users/samjg/Documents/Github_repositories/Airradians_CellularMolecular_OA/RAnalysis/Output/FlowCytometry/MitoSox_RxnNorm.pdf"), height = 8)
ggarrange(Day1_MitoROS_RxnNorm, Day14_MitoROS_RxnNorm, ncol=1)
dev.off()


# itochondrial membrane potential
pdf(paste0("C:/Users/samjg/Documents/Github_repositories/Airradians_CellularMolecular_OA/RAnalysis/Output/FlowCytometry/MembranePotential_RxnNorm.pdf"), height = 8)
ggarrange(Day1_MitoMemPot_RxnNorm, Day14_MitoMemPot_RxnNorm,ncol=1)
dev.off()
```


## Statistical analysis

```{r stats}

# for loop d
Dates  <- as.data.frame(list(unique(paste(data_filt$Date))))

# for loop i
pCO2history_treatments  <- as.data.frame(list(unique(paste(data_filt$pCO2_history))))

# for loop m
FlowCy_probes           <- as.data.frame(list(c('SYBR_PI_prop_alive_ADJ',
                                                'SYBR_PI_prop_dead_ADJ',
                                                'MitoSoxGreen_Mean_FL1',
                                                'JC10_FL2_FL1_Ratio')))

# prepare data for analysis
data2 <- data_filt %>% 
  dplyr::select(c("Date","pCO2_history","pCO2_exposure",
                  "SYBR_PI_prop_alive_ADJ","SYBR_PI_prop_dead_ADJ",
                  "MitoSoxGreen_Mean_FL1", "JC10_FL2_FL1_Ratio")) 

# Call the cumulative dataframe that we will write to in the for loop below
df_total              <- data.frame() # start dataframe 
stats.table           <- data.frame(matrix(nrow = 1, ncol = 10)) # create dataframe to save cumunalitively during for loop
colnames(stats.table) <- c('Date', 
                          'pCO2_history',
                          'FlowCyProbe', 
                          'Test', 
                          'Shapiro', 
                          'Levenes',
                          'DF',
                          'Fvalue',
                          'chisquared',
                          'Pvalue') # names for comuns in the for loop


# RUN TE FOR LOOP!

for (d in 1:nrow(Dates)) {
  
  data_by_date <- data2 %>% 
        dplyr::filter(Date %in% Dates[d,1])
  
  for (i in 1:nrow(pCO2history_treatments)) {
    
    # filter the dataset 
    data_by_history <- data_by_date %>% 
      dplyr::filter(pCO2_history %in% pCO2history_treatments[i,1]) 
      #dplyr::filter(pCO2_exposure %in% gsub('.* ', '', treatments[i,1])) 
    
      for (m in 1:nrow(FlowCy_probes)) {
        
        # if loop for probe type-speicif testing based on the naure of the data..
        
        if (substr(FlowCy_probes[m,],1,4) == 'SYBR') { # if proportion data (0-1) we want to run beta regression models
          
        colNum   <- which( colnames(data_by_history)==FlowCy_probes[m,])
        data_by_history[,colNum] = as.numeric(data_by_history[,colNum])
        modBetaReg     <- betareg(data_by_history[,colNum]~pCO2_exposure, data = data_by_history) # beta reg model suitable for prop data
        modSUMMARY     <- joint_tests(modBetaReg) # use 'emmeans' pavkage for an anova-like table
        modSUMMARYDF   <- signif(modSUMMARY[["df1"]][1], 2) # cal p value for anova table - 2 sig figs
        modSUMMARYFval <- signif(modSUMMARY[["F.ratio"]][1], 4) # cal p value for anova table - 2 sig figs
        modSUMMARYchi  <- NA  
        modSUMMARYPval <- signif(modSUMMARY[["p.value"]][1], 4) # cal p value for anova table - 2 sig figs
        testRun        <- "Beta regression model"        
        
        shapTEST       <- 'NA' # proportion data between 0-1 is non parametric
        levTEST        <- as.data.frame('NA','NA') # proportion data between 0-1 is non parametric, need to make table for if/else below
        
        } else { # for the continuous data run ANOVA or Kruskal Wallis for norm/non-param. models
          
        colNum   <- which( colnames(data_by_history)==FlowCy_probes[m,])
        data_by_history[,colNum] = as.numeric(data_by_history[,colNum])
        modAOV   <- aov(lm(data_by_history[,colNum]~pCO2_exposure, data = data_by_history))
        shapTEST <- shapiro.test(resid(modAOV))
        levTEST  <- leveneTest(modAOV)
        
            # within continuous data.. run either ANOVA or Kruskal Wallis based on normality testing..
            if(shapTEST$p.value> 0.05 & levTEST$`Pr(>F)`[1] > 0.05) { # if normal - run anova
              
              modSUMMARY     <- summary(modAOV) # create anova table summary
              modSUMMARYDF   <- signif(modSUMMARY[[1]][["Df"]][1], 2) # cal p value for anova table - 2 sig figs
              modSUMMARYFval <- signif(modSUMMARY[[1]][["F value"]][1], 4) # cal p value for anova table - 2 sig figs
              modSUMMARYchi  <- NA  
              modSUMMARYPval <- signif(modSUMMARY[[1]][["Pr(>F)"]][1], 4) # cal p value for anova table - 2 sig figs
              testRun        <- "One-way ANOVA"
              
            } else { # if non-normal (either shapiro OR levenes defied) - run the Kruskal Wallis
              
              modSUMMARY     <- kruskal.test(data_by_history[,colNum] ~ pCO2_exposure, data = data_by_history) 
              modSUMMARYDF   <- signif(modSUMMARY[[2]], 2) # cal p value for Kruskal wallis test table - 2 sig figs
              modSUMMARYFval <- NA
              modSUMMARYchi  <- signif(modSUMMARY[[1]], 4) # cal p value for Kruskal wallis test table - 2 sig figs
              modSUMMARYPval <- signif(modSUMMARY[[3]], 4) # cal p value for Kruskal wallis test table - 2 sig figs
              testRun        <- "Kruskal Wallis"
              
            } # end of if loop WITHIN the 'else' for probe type-specif testing
        } # close the if else loop for probe type-specific testing (we are still in the the 'm' for loop!)
        stats.table$Date          <- data_by_history$Date[1]
        stats.table$pCO2_history  <- pCO2history_treatments[i,]
        stats.table$FlowCyProbe   <- FlowCy_probes[m,]
        stats.table$Test          <- testRun
        if (shapTEST[1] == 'NA') {
          stats.table$Shapiro = 'NA'} else {stats.table$Shapiro <- shapTEST$p.value}
        if (levTEST[1,1] == 'NA') {
          stats.table$Levenes = 'NA'} else {stats.table$Levenes <- levTEST$`Pr(>F)`[1]}
        stats.table$DF            <- modSUMMARYDF
        stats.table$Fvalue        <- modSUMMARYFval
        stats.table$chisquared    <- modSUMMARYchi
        stats.table$Pvalue        <- modSUMMARYPval
        
        df       <- data.frame(stats.table) # name dataframe for this single row
        df_total <- rbind(df_total,df) #bind to a cumulative list dataframe
        print(df_total) # print to monitor progress      
        
          } # close 'm' for loop - through each flow cy probe
    
    } # close 'i' for loop - through each pCO2 history (low, moderate, severe)
  
} # close 'd' for loop - through each sampling data (5/2/2023 and 5/16/2023)

View(df_total)
df_total

df_total %>% dplyr::filter(!Pvalue > 0.1) 

  low <- data_filt %>% 
     dplyr::filter(Date %in% 20230516) %>% 
     dplyr::filter(pCO2_history %in% 'low') 

modBetaReg     <- betareg(SYBR_PI_prop_dead_ADJ~pCO2_exposure, data = low) # beta reg model suitable for prop data
joint_tests(modBetaReg) # use 'emmeans' pavkage for an anova-like table
summary(modBetaReg)
lrtest(modBetaReg)    
Anova(modBetaReg)
  # summary(aov(lm(SYBR_PI_count_dead~pCO2_`exposure,data=low)))
```

```{r analysis live dead}
library(multcomp)


# 24 HOUR DATA - history x exposure tests



# live cells proportion
Day1_PropLive_betareg <- betareg(SYBR_PI_prop_alive_ADJ ~ pCO2_history*pCO2_exposure, data=Day1_datafilt)
lrtest(Day1_PropLive_betareg) #  using lrtests from the 'lmtests' package
joint_tests(Day1_PropLive_betareg) # using joint_tests from 'emmeans' package
# model term                 df1 df2 F.ratio p.value
#  pCO2_history                 2 Inf   1.354  0.2582
#  pCO2_exposure                2 Inf   0.680  0.5066
#  pCO2_history:pCO2_exposure   4 Inf   2.198  0.0665
Anova(Day1_PropLive_betareg) # using Anova fro 'car' package
# Response: SYBR_PI_prop_alive_ADJ
#                            Df  Chisq Pr(>Chisq)  
# pCO2_history                2 2.3096    0.31511  
# pCO2_exposure               2 1.3562    0.50757  
# pCO2_history:pCO2_exposure  4 8.0755    0.08885 .






# dead cells proportion - notice results are the exact same becasue values are dependent on one another (i..e 75% for A_alive is 25% for A_dead)
Day1_PropDead_betareg <- betareg(SYBR_PI_prop_dead_ADJ ~ pCO2_history*pCO2_exposure, data=Day1_datafilt)
lrtest(Day1_PropDead_betareg) #  using lrtests from the 'lmtests' package
joint_tests(Day1_PropDead_betareg) # using joint_tests from 'emmeans' package
# model term                 df1 df2 F.ratio p.value
#  pCO2_history                 2 Inf   1.354  0.2582
#  pCO2_exposure                2 Inf   0.680  0.5066
#  pCO2_history:pCO2_exposure   4 Inf   2.198  0.0665
summary(emmeans(Day1_PropDead_betareg, pairwise ~ pCO2_history|pCO2_exposure))
# under severe exposure, low history have higher survival than severe and moderate history




# follow up on a one way anova effect - severe was significat
Day1_PropLive_Severe <- Day1_datafilt %>% filter(pCO2_history %in% 'severe')
Day1_PropLive_Severe_mod <- betareg(SYBR_PI_prop_alive_ADJ~pCO2_exposure,data=Day1_PropLive_Severe)
joint_tests(Day1_PropLive_Severe_mod)
# model term    df1 df2 F.ratio p.value
#  pCO2_exposure   2 Inf   4.522  0.0109
Day1_PropLive_Severe_modMEANS <- emmeans::emmeans(object = Day1_PropLive_Severe_mod,
                                    pairwise ~ "pCO2_exposure",
                                    adjust = "tukey")
multcomp::cld(object = Day1_PropLive_Severe_modMEANS$emmeans,Letters = letters)
#  pCO2_exposure emmean     SE  df asymp.LCL asymp.UCL .group
#  severe         0.630 0.0370 Inf     0.557     0.702  a    
#  low            0.723 0.0382 Inf     0.648     0.797  ab   
#  moderate       0.776 0.0317 Inf     0.713     0.838   b






# 14 DAY EXPOSURE DATA  - history x exposure tests





# live cells proportion
Day14_PropLive_betareg <- betareg(SYBR_PI_prop_alive_ADJ ~ pCO2_history*pCO2_exposure, data=Day14_datafilt)
lrtest(Day14_PropLive_betareg) #  using lrtests from the 'lmtests' package
joint_tests(Day14_PropLive_betareg) # using joint_tests from 'emmeans' package
 # model term                 df1 df2 F.ratio p.value
 # pCO2_history                 2 Inf   3.946  0.0193
 # pCO2_exposure                2 Inf   2.272  0.1032
 # pCO2_history:pCO2_exposure   4 Inf   1.306  0.2650
summary(emmeans(Day14_PropLive_betareg, pairwise ~ pCO2_history))
# low has significantly lower survival than moderate regardless of subseqent exposure
mod_means_contr <- emmeans::emmeans(object = Day14_PropLive_betareg,
                                    pairwise ~ "pCO2_history",
                                    adjust = "tukey")
mod_means <- multcomp::cld(object = mod_means_contr$emmeans,
                           Letters = letters)
mod_means
# pCO2_history emmean     SE  df asymp.LCL asymp.UCL .group
#  low           0.774 0.0227 Inf     0.730     0.819  a    
#  severe        0.830 0.0203 Inf     0.790     0.869  ab   
#  moderate      0.856 0.0188 Inf     0.819     0.893   b


# follow up on a one way anova effect - severe was significat
Day14_PropLive_Severe <- Day14_datafilt %>% filter(pCO2_history %in% 'severe')
Day14_PropLive_Severe_mod <- betareg(SYBR_PI_prop_alive_ADJ~pCO2_exposure,data=Day14_PropLive_Severe)
shapiro.test(resid(Day14_PropLive_Severe_mod)) # 0.5218
joint_tests(Day14_PropLive_Severe_mod)
# model term    df1 df2 F.ratio p.value
#  pCO2_exposure   2 Inf   3.149  0.0429
Day14_PropLive_Severe_modMEANS <- emmeans::emmeans(object = Day14_PropLive_Severe_mod,
                                    pairwise ~ "pCO2_exposure",
                                    adjust = "tukey")
multcomp::cld(object = Day14_PropLive_Severe_modMEANS$emmeans,Letters = letters)
# pCO2_exposure emmean     SE  df asymp.LCL asymp.UCL .group
#  moderate       0.793 0.0242 Inf     0.746     0.841  a    
#  low            0.858 0.0208 Inf     0.817     0.898  ab   
#  severe         0.868 0.0201 Inf     0.828     0.907   b 

  
```

```{r analysis Mitochondrial ROS}



# 24 HOUR DATA - history x exposure tests



Day1_MitoSox_AOV <- aov(lm(MitoSoxGreen_Mean_FL1 ~ pCO2_history*pCO2_exposure, data=Day1_datafilt))
shapiro.test(resid(Day1_MitoSox_AOV)) # normal 0.4232
leveneTest(Day1_MitoSox_AOV) # 0.6705 PASS variance test
summary(Day1_MitoSox_AOV)
#                            Df Sum Sq Mean Sq F value Pr(>F)
# pCO2_history                2   71.2   35.59   0.683  0.512
# pCO2_exposure               2   63.6   31.79   0.610  0.549
# pCO2_history:pCO2_exposure  4  224.3   56.08   1.076  0.383
# Residuals                  36 1876.7   52.13



# 14 DAY EXPOSURE DATA  - history x exposure tests



Day14_MitoSox_AOV <- aov(lm(MitoSoxGreen_Mean_FL1 ~ pCO2_history*pCO2_exposure, data=Day14_datafilt))
shapiro.test(resid(Day14_MitoSox_AOV)) # normal 0.6608
leveneTest(Day14_MitoSox_AOV) # 0.2396 PASS variance test
summary(Day14_MitoSox_AOV)
#                             Df   Sum Sq Mean Sq F value   Pr(>F)    
# pCO2_history                2 11336397 5668198  11.232 0.000162 ***
# pCO2_exposure               2  6723335 3361668   6.661 0.003456 ** 
# pCO2_history:pCO2_exposure  4  3810366  952591   1.888 0.133824  
TukeyHSD(Day14_MitoSox_AOV)


# lets get them letters
mod_means_contr <- emmeans::emmeans(object = Day14_MitoSox_AOV,
                                    pairwise ~ "pCO2_exposure",
                                    adjust = "tukey")
mod_means <- multcomp::cld(object = mod_means_contr$emmeans,
                           Letters = letters)
 # pCO2_history emmean  SE df lower.CL upper.CL .group
 # low            4023 183 36     3651     4395  a    
 # moderate       4603 183 36     4231     4975  a    
 # severe         5252 183 36     4880     5624   b 

 # pCO2_exposure emmean  SE df lower.CL upper.CL .group
 # moderate        4085 183 36     3713     4457  a    
 # low             4823 183 36     4451     5195   b   
 # severe          4968 183 36     4596     5340   b 

mitosoxDay14 <- data_filt %>% # data %>%
  # edit data to suit out needs
  dplyr::filter(Date %in% 20230516) %>% # filter for desired date of rhte experiment
  dplyr::select(c('Date','Scallop_ID','pCO2_exposure','pCO2_history','MitoSoxGreen_Mean_FL1')) %>% 
  na.omit() %>%
  dplyr::filter(pCO2_history %in% 'low') %>% 
  dplyr::filter(!Scallop_ID %in% 5)


Day14_MitoSox_AOV_LOW <- aov(lm(MitoSoxGreen_Mean_FL1 ~ pCO2_exposure, data=mitosoxDay14))
shapiro.test(resid(Day14_MitoSox_AOV_LOW)) # normal 0.792
leveneTest(Day14_MitoSox_AOV_LOW) # 0.04912 * PASS variance test
qqnorm(resid(Day14_MitoSox_AOV_LOW))
TukeyHSD(Day14_MitoSox_AOV_LOW)
Day14_MitoSox_KW_LOW <- kruskal.test(MitoSoxGreen_Mean_FL1 ~ pCO2_exposure, data=mitosoxDay14)
Day14_MitoSox_KW_LOW # p-value = 0.03175
# Kruskal-Wallis chi-squared = 6.9, df = 2, p-value = 0.03175
Day14_SRH_Dunns <- dunnTest(MitoSoxGreen_Mean_FL1 ~ pCO2_exposure,
              data=mitosoxDay14,
              method="bh")      # Adjusts p-values for multiple comparisons;
Day14_SRH_Dunns
# low - moderate	2.3697163	0.01780174	0.05340521	
# low - severe	0.3741657	0.70828101	0.70828101	
# moderate - severe	-2.1166010	0.03429372	0.05144058
```

```{r analysis Mitochondrial membrane potential}

# 24 HOUR DATA - history x exposure tests


Day1_MitoMemPot_AOV <- aov(lm(JC10_FL2_FL1_Ratio ~ pCO2_history*pCO2_exposure, data=Day1_datafilt))
shapiro.test(resid(Day1_MitoMemPot_AOV)) #  normal 0.1992
leveneTest(Day1_MitoMemPot_AOV) # 0.7438 PASS variance test
summary(Day1_MitoMemPot_AOV)
#                             Df Sum Sq Mean Sq F value Pr(>F)  
# pCO2_history                2   4126  2062.8   2.841 0.0736 .
# pCO2_exposure               2    677   338.4   0.466 0.6318  
# pCO2_history:pCO2_exposure  4   1404   351.1   0.484 0.7476  
# Residuals                  31  22507   726.0 
TukeyHSD(Day1_MitoMemPot_AOV)
# $pCO2_history
#                      diff        lwr      upr     p adj
# moderate-low    24.221604  -1.321011 49.76422 0.0658178
# severe-low      16.972800  -9.038526 42.98413 0.2582674
# severe-moderate -7.248805 -32.791420 18.29381 0.7661487


Day1_MitoMemPot_SRH <- scheirerRayHare(JC10_FL2_FL1_Ratio ~ pCO2_history*pCO2_exposure, data=Day1_datafilt)
Day1_MitoMemPot_SRH
#                             Df Sum Sq      H p.value
# pCO2_history                2  972.9 7.1187 0.02846
# pCO2_exposure               2  245.0 1.7926 0.40808
# pCO2_history:pCO2_exposure  4  229.7 1.6804 0.79427
# Residuals                  31 3958.9



# 14 DAY EXPOSURE DATA  - history x exposure tests




Day14_MitoMemPot_AOV <- aov(lm(JC10_FL2_FL1_Ratio ~ pCO2_history*pCO2_exposure, data=Day14_datafilt))
shapiro.test(resid(Day14_MitoMemPot_AOV)) #  non-normal 0.0006415
leveneTest(Day14_MitoMemPot_AOV) # 0.6969 PASS variance test
Day14_MitoMemPot_SRH <- scheirerRayHare(JC10_FL2_FL1_Ratio ~ pCO2_history*pCO2_exposure, data=Day14_datafilt)
Day14_MitoMemPot_SRH
#                             Df Sum Sq      H  p.value
# pCO2_history                2  588.0 3.7297 0.154920
# pCO2_exposure               2  963.8 6.1131 0.047051 * significant!
# pCO2_history:pCO2_exposure  4  975.4 6.1868 0.185627
# Residuals                  34 4070.8
Day14_SRH_Dunns <- dunnTest(JC10_FL2_FL1_Ratio ~ pCO2_exposure,
              data=Day14_datafilt,
              method="bh")      # Adjusts p-values for multiple comparisons;
                                # See ?dunnTest for options
Day14_SRH_Dunns
# low - moderate    	-2.355507	0.01849744	0.05549231	
# low - severe      	-1.876431	0.06059618	0.09089426	
# moderate - severe	   0.393393	0.69402926	0.69402926


# follow up on a one way anova effect - severe was significat
Day14_MitoPot_Low <- Day14_datafilt %>% filter(pCO2_history %in% 'low')
Day14_MitoPot_Low_mod <- kruskal.test(JC10_FL2_FL1_Ratio~pCO2_exposure,data=Day14_MitoPot_Low) # we know its non normal
# Kruskal-Wallis chi-squared = 8.88, df = 2, p-value = 0.0118
Day14_KW_low_Dunns <- dunnTest(JC10_FL2_FL1_Ratio ~ pCO2_exposure,
              data=Day14_MitoPot_Low,
              method="bh")      # Adjusts p-values for multiple comparisons;
                                # See ?dunnTest for options
Day14_KW_low_Dunns
# low - moderate	-2.969848	0.002979467	0.0089384	***
# low - severe	-1.697056	0.089686022	0.1345290	
# moderate - severe	1.272792	0.203091788	0.2030918	
```
