---
title: "Hemolymph_analysis"
author: "Samuel Gurr"
date: "2023-05-09"
output: html_notebook
---

-   Last updates: May 9/21/2023

# OA Reexposure Challenge

### May 2023: F2 Adult Bay scallops exposed to a two-week full-reciprocal pCO2 challenge

### Objective: plot and analyze flow cytometry data for (a) SYBR green and propidium iodide - cell viability (b) MitoSox gree - mitochondrial ROS (c) JC-10 - mitochondrial membrane potential corrected for CCCP

## Load Libraries

```{r set up, include=FALSE}

library(betareg) # runs a beta regression model suotable for proportion (percent data) between 0 and 1 (our live and dead cells data)
library(lmtest) # to receive p value from betareg model
library(FSA) # for the Dun test post hoc for SRH non-parametric 2 way anova]
library(emmeans)
library(ggplot2)
library(dplyr)
library(tidyverse)
library(car)
library(lmerTest)
library(tidyr)
library(reshape2)
library(ggpubr)
library(nlme)
library(rcompanion) # to run the Schrier -Ray-Hare non parametric 2 way 
knitr::opts_knit$set(root.dir = "C:/Users/samjg/Documents/Github_repositories/Airradians_CellularMolecular_OA/RAnalysis") # sets the working directory for the entire R markdown file - no need to reload the wd
```

## Load flow cytometry data

**NOTE**: the statistics option ion C6 PLus software was used to compile the data (i.e. mean FL1) - the following loaded data file was assembled manually to include the sample metadata (i.e. data, treatments, etc.) as well as these flow cytometry data

```{r load data}
# getwd()
# read data 
data  <- read.csv(file="../Data/FlowCytometry/Hemolymph_data_raw.csv", header = TRUE) %>% 
            dplyr::mutate(Scallop_ID = as.character(Scallop_ID))

# notes: the dissection team and hemolymph extration team were given 
# sheet to note if/when there was a sampling error with individuals 

# of particular interest was notes of 'hitting the gut' from the appearance of 
# extracted hemolymph - this was particularly confined to scallops # 5 with 'some gonad for scallop #s 56 and 87

# filter out data points based on visual diagnositcs of flow cytometry data 
# criterion being, but not limited to, uninterpretable clouds showing no biological importance
# these data were (in most cases) specific to a probe and not the whole individual across all measurements

data_filt <- data %>%
  
# PERCENT/PROPORTION LIVE AND DEAD CELLS 
    # first note NAs for SYBR + PI = 51 and 59 and 60
    dplyr::mutate(SYBR_PI_count_alive= #as.numeric(sub(",", "", SYBR_PI_count_alive))) %>% 
            # ifelse(Scallop_ID %in% 5, 
            ifelse(Scallop_ID %in% c('5', '56', '87'),
            # ifelse(Scallop_ID %in% c('5', '20', '51', '59', '60', '56','87'),
            # ifelse(Scallop_ID %in% c('5', '51', '59', '60'),
                     NA, as.numeric(SYBR_PI_count_alive))) %>%  # for #s insert Na, else insert oG data

    dplyr::mutate(SYBR_PI_count_dead = #as.numeric(sub(",", "", SYBR_PI_count_dead))) %>% 
            # ifelse(Scallop_ID %in% 5, 
            ifelse(Scallop_ID %in% c('5', '56', '87'),
            # ifelse(Scallop_ID %in% c('5', '20', '51', '59', '60', '56','87'),
            # ifelse(Scallop_ID %in% c('5', '51', '59', '60'),
                     NA, as.numeric(SYBR_PI_count_dead))) %>%  # for #s insert Na, else insert oG data 
  
# MITOCHONDRIAL SUPEROXIDE DISMUTASE 
    # NA for mitosox green data day 1: = #s 5 (cotaminated 24 (24  abnormal count of events, very low) 
    # 74 recomemnded but seems ok
    # NA for mitosox green data day 14: 50 (no events), 27 (less events but not different from others), 
    # 56 (gonad cont.), 87 (strange density gonad cont.), 90 (cut off, but okay)
    dplyr::mutate(MitoSoxGreen_Mean_FL1 = #as.numeric(sub(",", "", MitoSoxGreen_Mean_FL1))) %>% 
             # ifelse(Scallop_ID %in% c('5', '24', '74', '27','50','56', '87','90'), 
             # ifelse(Scallop_ID %in% 5,
             ifelse(Scallop_ID %in% c('5','56','24','87'),
                     NA, as.numeric(MitoSoxGreen_Mean_FL1))) %>% # for #s insert NA, else insert oG data 
  
# MITOCHONDRIAL MEMBRANE POTENTIAL DATA 
    # NA for JC-10 = 12,13, 51, 74
    dplyr::mutate(JC10_FL1_monomer =  #as.numeric(JC10_FL1_monomer)) %>%
            ifelse(Scallop_ID %in% c('12', '13', '51', '74', # day 1 data that was marked as error
                                     '5','56', '87'), # outliers in day 14 data
                   NA, JC10_FL1_monomer)) %>% # for #s insert Na, else insert oG data insert oG data 

    dplyr::mutate(JC10_FL2_Jaggregate =  #as.numeric(JC10_FL2_Jaggregate)) %>%
            ifelse(Scallop_ID %in% c('12', '13', '51', '74', # day 1 data that was marked as error
                                     '5','56', '87'), # outliers in day 14 data
                                     NA, JC10_FL2_Jaggregate)) %>% # for #s insert Na, else insert oG data insert oG data

    # calculate the FL2:FL1 ratio - this is our core data for this metric!
    dplyr::mutate(JC10_FL2_FL1_Ratio = 
                    ( (as.numeric(JC10_FL2_Jaggregate)) / 
                             (as.numeric(JC10_FL1_monomer)) )) %>%

# ADJUSTED PERCENT DATA - CHANGE TO PROPORTION 0-1
    # the current precent alive and dead is proportion to ALL events of the cytogram - including those NOT dyed by SYBR and PI
    # here we do an ADJ percent calc through sum of ONLY the live and dead events for a new 100
    # second, adjusted 100% for ONLY counts live and dead
    dplyr::mutate(SYBR_PI_prop_alive_ADJ = 
                    (SYBR_PI_count_alive/(SYBR_PI_count_alive+SYBR_PI_count_dead))) %>%
  
    dplyr::mutate(SYBR_PI_prop_dead_ADJ = 
                    (SYBR_PI_count_dead/(SYBR_PI_count_alive+SYBR_PI_count_dead))) %>%
  
    dplyr::mutate(pCO2_baseline_change = 
                       case_when( 
                         (pCO2_history == 'low'      & pCO2_exposure == 'low') ~ 'baseline',
                         (pCO2_history == 'moderate' & pCO2_exposure == 'moderate') ~ 'baseline',
                         (pCO2_history == 'severe'   & pCO2_exposure == 'severe') ~ 'baseline',
                         .default = 'change'
                         ))

#write csv for filtered data 
data_filt %>% dplyr::filter(JC10_FL2_Jaggregate %in% NA) # as 5 12 13 51 64 74 56 and 87 

write.csv(data_filt, file = "../Data/FlowCytometry/Hemolymph_data_filtered.csv")


# FILTER DATA FOR THE DAY 1 AND DAY 14 DATA 
Day1_datafilt  <- data_filt %>% dplyr::filter(Date %in% 20230502)
Day14_datafilt <- data_filt %>% dplyr::filter(Date %in% 20230516)
 
# View(Day14_datafilt)
# View(data)
```

## Plot data 

### Cell viability (Live vs. dead)

* SYBRgreen + propidium iodide, gated using the FL2 to reveal true peaks (PE-H) 

* data comprised of percent live and dead

```{r plot live dead}


# 24 HOURS 

# stacked proportion plot

    
Day1_PropLive_RxnNorm <- data_filt %>% # data %>%
  # edit data to suit out needs
  dplyr::filter(Date %in% 20230502) %>% # filter for desired date of rhte experiment
  dplyr::select(c('Date','pCO2_exposure','pCO2_history','SYBR_PI_prop_alive_ADJ')) %>% 
  na.omit() %>%  
  group_by(pCO2_exposure, pCO2_history) %>% # group by columns for treatment
  dplyr::summarise( # summarise to aquire the mean and SE for plotting
    PercLive_mean = mean(SYBR_PI_prop_alive_ADJ), # mean
    PercLive_sd = sd(SYBR_PI_prop_alive_ADJ), # sd
    n = n(), # count
    PercLive_se = PercLive_sd / sqrt(n)) %>% # SE
  # plot it
  ggplot(aes(x=pCO2_exposure, y=PercLive_mean, group=pCO2_history)) + 
    geom_line(aes(group = factor(pCO2_history), linetype = pCO2_history), size = 0.5, position=position_dodge(.4)) +  # connect a line between variables
    scale_linetype_manual(values=c("solid", "dashed", "dotted")) +
    geom_point(aes(shape=pCO2_history, fill=pCO2_history), size = 4,position=position_dodge(.4)) + 
    scale_shape_manual(values=c(21, 22, 24)) + # filled circle, filled triangle, and X 
    scale_fill_manual(values = c("#009E73","#E69F00", "#CC79A7")) +
    geom_errorbar(aes(ymin=(PercLive_mean)-(PercLive_se), 
                      ymax=(PercLive_mean)+(PercLive_se)), 
                  width=.2,position=position_dodge(.4)) +
    # geom_jitter() +
    theme_classic() +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + 
    ggtitle("Percent alive cells - 24 hours") +
    labs(y= "Percent alive cells (%)", x = "pCO2 Exposure") # +
   # facet_wrap(~pCO2_history)
Day1_PropLive_RxnNorm





Day1_PropDead_RxnNorm <- data_filt %>% # data %>%
  # edit data to suit out needs
  dplyr::filter(Date %in% 20230502) %>% # filter for desired date of rhte experiment
  dplyr::select(c('Date','pCO2_exposure','pCO2_history','SYBR_PI_prop_dead_ADJ')) %>% 
  na.omit() %>%  
  group_by(pCO2_exposure, pCO2_history) %>% # group by columns for treatment
  dplyr::summarise( # summarise to aquire the mean and SE for plotting
    PercDead_mean = mean(SYBR_PI_prop_dead_ADJ), # mean
    PercDead_sd = sd(SYBR_PI_prop_dead_ADJ), # sd
    n = n(), # count
    PercDead_se = PercDead_sd / sqrt(n)) %>% # SE
  # plot it
  ggplot(aes(x=pCO2_exposure, y=PercDead_mean, group=pCO2_history, fill =pCO2_history)) + 
    geom_line(aes(group = factor(pCO2_history), linetype = pCO2_history), size = 0.5, position=position_dodge(.4)) +  # connect a line between variables
    scale_linetype_manual(values=c("solid", "dashed", "dotted")) +
    geom_point(aes(shape=pCO2_history, fill=pCO2_history), size = 4,position=position_dodge(.4)) + 
    scale_shape_manual(values=c(21, 22, 24)) + # filled circle, filled triangle, and X 
    scale_fill_manual(values = c("#009E73","#E69F00", "#CC79A7")) +
    geom_errorbar(aes(ymin=(PercDead_mean)-(PercDead_se), 
                      ymax=(PercDead_mean)+(PercDead_se)), 
                  width=.2,position=position_dodge(.4)) +
    # geom_jitter() +
    theme_classic() +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + 
    ggtitle("Percent dead cells - 24 hours") +
    labs(y= "Percent dead cells (%)", x = "pCO2 Exposure") #+
   # facet_wrap(~pCO2_history)
Day1_PropDead_RxnNorm


ggarrange(Day1_PropLive_RxnNorm, Day1_PropDead_RxnNorm)


# DAY 14 OF EXPERIMENT 



Day14_PropLive_RxnNorm <- data_filt %>% # data %>%
  # edit data to suit out needs
  dplyr::filter(Date %in% 20230516) %>% # filter for desired date of rhte experiment
  dplyr::select(c('Date','pCO2_exposure','pCO2_history','SYBR_PI_prop_alive_ADJ')) %>% 
  na.omit() %>%  
  group_by(pCO2_exposure, pCO2_history) %>% # group by columns for treatment
  dplyr::summarise( # summarise to aquire the mean and SE for plotting
    PercLive_mean = mean(SYBR_PI_prop_alive_ADJ), # mean
    PercLive_sd = sd(SYBR_PI_prop_alive_ADJ), # sd
    n = n(), # count
    PercLive_se = PercLive_sd / sqrt(n)) %>% # SE
  # plot it
  ggplot(aes(x=pCO2_exposure, y=PercLive_mean, group=pCO2_history)) + 
    geom_line(aes(group = factor(pCO2_history), linetype = pCO2_history), size = 0.5, position=position_dodge(.4)) +  # connect a line between variables
    scale_linetype_manual(values=c("solid", "dashed", "dotted")) +
    geom_point(aes(shape=pCO2_history, fill=pCO2_history), size = 4,position=position_dodge(.4)) + 
    scale_fill_manual(values = c("#009E73","#E69F00", "#CC79A7")) +
    geom_errorbar(aes(ymin=(PercLive_mean)-(PercLive_se), 
                      ymax=(PercLive_mean)+(PercLive_se)), 
                  width=.2,position=position_dodge(.4)) +
    # geom_jitter() +
    theme_classic() +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + 
    scale_shape_manual(values=c(21, 22, 24)) + # filled circle, filled triangle, and X 
    ggtitle("Percent alive cells - 14 days") +
    labs(y= "Percent alive cells (%)", x = "pCO2 Exposure") #+
    #facet_wrap(~pCO2_history)
Day14_PropLive_RxnNorm



Day14_PropDead_RxnNorm <- data_filt %>% # data %>%
  # edit data to suit out needs
  dplyr::filter(Date %in% 20230516) %>% # filter for desired date of rhte experiment
  dplyr::select(c('Date','pCO2_exposure','pCO2_history','SYBR_PI_prop_dead_ADJ')) %>% 
  na.omit() %>%  
  group_by(pCO2_exposure, pCO2_history) %>% # group by columns for treatment
  dplyr::summarise( # summarise to aquire the mean and SE for plotting
    PercDead_mean = mean(SYBR_PI_prop_dead_ADJ), # mean
    PercDead_sd = sd(SYBR_PI_prop_dead_ADJ), # sd
    n = n(), # count
    PercDead_se = PercDead_sd / sqrt(n)) %>% # SE
  # plot it
  ggplot(aes(x=pCO2_exposure, y=PercDead_mean, group=pCO2_history)) + 
    geom_line(aes(group = factor(pCO2_history), linetype = pCO2_history), size = 0.5, position=position_dodge(.4)) +  # connect a line between variables
    scale_linetype_manual(values=c("solid", "dashed", "dotted")) +
    geom_point(aes(shape=pCO2_history, fill=pCO2_history), size = 4,position=position_dodge(.4)) + 
    theme_classic() +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + 
    scale_shape_manual(values=c(21, 22, 24)) + # filled circle, filled triangle, and X 
    scale_fill_manual(values = c("#009E73","#E69F00", "#CC79A7")) +
    geom_errorbar(aes(ymin=(PercDead_mean)-(PercDead_se), 
                      ymax=(PercDead_mean)+(PercDead_se)), 
                  width=.2,position=position_dodge(.4)) +
    theme_classic() +
    ggtitle("Percent dead cells - 14 days") +
    labs(y= "Percent dead cells (%)", x = "pCO2 Exposure")# +
   # facet_wrap(~pCO2_history)
Day14_PropDead_RxnNorm
 
ggarrange(Day14_PropLive_RxnNorm, Day14_PropDead_RxnNorm)

```

```{r, Cell Viability - stacked bar bplot}


library(ggrepel)
data_filt %>% # data %>%
  # edit data to suit out needs
  dplyr::filter(Date %in% 20230516) %>% # filter for desired date of rhte experiment
  dplyr::select(c('Date','Scallop_ID','pCO2_exposure','pCO2_history','SYBR_PI_prop_alive_ADJ')) %>% 
  na.omit() %>% 
  dplyr::filter(!Scallop_ID %in% 5) %>% 
 # dplyr::filter(!Scallop_ID %in% 5) 
  ggplot(aes(x=pCO2_exposure, y=SYBR_PI_prop_alive_ADJ, label=Scallop_ID)) + 
      geom_boxplot(alpha = 0.5) +
      #geom_dotplot(binaxis = 'y', stackdir='center', dotsize=1) +
      #geom_text_repel(arrow = arrow(length=unit(0.2,"npc")),box.padding=1) +
      theme_bw()+
      geom_text(aes(label=Scallop_ID), size = 3.5) +
     # #scale_color_manual(values = c("#0072B2", "#D55E00")) + # colorblindness palette blue and orange
     #  theme_classic() +
     #  theme(legend.position = "none") +
      facet_wrap(~pCO2_history)


# STACKED BAR PLOTS - i thin this is the best way to display the data 
pd <- position_dodge2(width = 0.2)
Day1_StackedBar <- data_filt %>% # data %>%
    # edit data to suit out needs
    dplyr::filter(Date %in% 20230502) %>% # filter for desired date of rhte experiment
    dplyr::select(c('Date','pCO2_exposure','pCO2_history','SYBR_PI_prop_alive_ADJ', 'SYBR_PI_prop_dead_ADJ')) %>% 
    na.omit() %>%
    tidyr::pivot_longer(!c(Date,pCO2_exposure,pCO2_history), names_to = "Type", values_to = "Proportion") %>% 
    group_by(pCO2_exposure, pCO2_history, Type) %>% # group by columns for treatment
    dplyr::summarise( # summarise to aquire the mean and SE for plotting
    Perc_mean = mean(Proportion), # mean
    Perc_sd = sd(Proportion), # sd
    n = n(), # count
    Perc_se = Perc_sd / sqrt(n)) %>% # SE
    dplyr::mutate(y_pos = cumsum(Perc_mean)) %>% 
    dplyr::mutate(Type = factor(Type, levels=c('SYBR_PI_prop_dead_ADJ','SYBR_PI_prop_alive_ADJ'))) %>% #reorder for stacks
      ggplot(aes(x = pCO2_exposure, 
                 y = Perc_mean, 
                 fill = pCO2_history,
                 #group= pCO2_exposure,
                 alpha = Type)) + 
      geom_bar(stat = "identity", 
               width=0.7) + 
      scale_fill_manual(values = c("#009E73","#E69F00", "#CC79A7")) +
      #scale_fill_manual(values = c("#0072B2", "#D55E00")) + # colorblindness palette blue and orange
      geom_errorbar(aes(ymax = y_pos + Perc_se, 
                        ymin=  y_pos - Perc_se), 
                    stat = "identity", 
                    width = 0.1, # removed the error bar ticks
                    alpha = 0.7, 
                    position = pd) + 
      facet_wrap(~pCO2_history) + 
      scale_alpha_manual(values=c(seq(0.3,1, length.out = 3))) + 
      theme_classic() + 
      scale_y_continuous(breaks = seq(from = 0, to = 1, by = 0.10)) + 
      ylim(0,1.1)+
      theme(legend.position = "none") +
      ylab("Percent live v. dead hemocytes") +
      ggtitle("Day 1: Cell Viability") 
Day1_StackedBar



Day14_StackedBar <- data_filt %>% # data %>%
    # edit data to suit out needs
    dplyr::filter(Date %in% 20230516) %>% # filter for desired date of rhte experiment
    dplyr::select(c('Date', 'Scallop_ID', 'pCO2_exposure','pCO2_history','SYBR_PI_prop_alive_ADJ', 'SYBR_PI_prop_dead_ADJ')) %>% 
    na.omit() %>%
    tidyr::pivot_longer(!c(Date,pCO2_exposure,pCO2_history), names_to = "Type", values_to = "Proportion") %>% 
    group_by(pCO2_exposure, pCO2_history, Type) %>% # group by columns for treatment
    dplyr::summarise( # summarise to aquire the mean and SE for plotting
    Perc_mean = mean(Proportion), # mean
    Perc_sd = sd(Proportion), # sd
    n = n(), # count
    Perc_se = Perc_sd / sqrt(n)) %>% # SE
    dplyr::mutate(y_pos = cumsum(Perc_mean)) %>% 
    dplyr::mutate(Type = factor(Type, levels=c('SYBR_PI_prop_dead_ADJ','SYBR_PI_prop_alive_ADJ'))) %>% #reorder for stacks
      ggplot(aes(x = pCO2_exposure, 
                 y = Perc_mean, 
                 fill = pCO2_history,
                 #group= pCO2_exposure,
                 alpha = Type)) + 
      geom_bar(stat = "identity", 
               width=0.7) + 
      scale_fill_manual(values = c("#009E73","#E69F00", "#CC79A7")) +
      #scale_fill_manual(values = c("#0072B2", "#D55E00")) + # colorblindness palette blue and orange
      geom_errorbar(aes(ymax = y_pos + Perc_se, 
                        ymin=  y_pos - Perc_se), 
                    stat = "identity", 
                    width = 0.1, # removed the error bar ticks
                    alpha = 0.7, 
                    position = pd) + 
      facet_wrap(~pCO2_history) + 
      scale_alpha_manual(values=c(seq(0.3,1, length.out = 3))) + 
      theme_classic() + 
      scale_y_continuous(breaks = seq(from = 0, to = 1.1, by = 0.10)) + 
      ylim(0,1.1)+
      theme(legend.position = "none") +
      ylab("Percent live v. dead hemocytes") +
      ggtitle("Day 14: Cell Viability") 
Day14_StackedBar
```

### Mitochondrial reactive oxygen species 

* MitoSox Green, gated using the FL1 (FITC-H) and FL1 vs. FL2 to truncate cells (FITC-H v. PE-H)

* data is the Mean FL1 

```{r plot Mitochondrial ROS}

# 24 hours 

Day1_MitoROS_RxnNorm <- data_filt %>% # data %>%
  # edit data to suit out needs
  dplyr::filter(Date %in% 20230502) %>% # filter for desired date of rhte experiment
  dplyr::mutate(MitoSoxGreen_Mean_FL1 = as.numeric(MitoSoxGreen_Mean_FL1)) %>% 
  dplyr::select(c('Date','pCO2_exposure','pCO2_history','MitoSoxGreen_Mean_FL1')) %>% 
  na.omit() %>%   
  group_by(pCO2_exposure, pCO2_history) %>% # group by columns for treatment
  dplyr::summarise( # summarise to aquire the mean and SE for plotting
    MitROS_mean = mean(MitoSoxGreen_Mean_FL1), # mean
    MitROS_sd = sd(MitoSoxGreen_Mean_FL1), # sd
    n = n(), # count
    MitROS_se = MitROS_sd / sqrt(n)) %>% # SE
  # plot it
  ggplot(aes(x=pCO2_exposure, y=MitROS_mean, group=pCO2_history)) + 
    geom_line(aes(group = factor(pCO2_history), linetype = pCO2_history), size = 0.5, position=position_dodge(.4)) +  # connect a line between variables
    scale_linetype_manual(values=c("solid", "dashed", "dotted")) +
    geom_point(aes(shape=pCO2_history, fill=pCO2_history), size = 4.5,position=position_dodge(.4)) + 
    scale_shape_manual(values=c(21, 22, 24)) + # filled circle, filled triangle, and X 
    scale_fill_manual(values=c("#009E73","#E69F00", "#CC79A7")) + # fill cicle white, triangle white, and jsut black for the X
    geom_errorbar(aes(ymin=(MitROS_mean)-(MitROS_se), 
                      ymax=(MitROS_mean)+(MitROS_se)), 
                  width=0,position=position_dodge(.4)) + # width dtermines the length of the end ticks
    # geom_jitter() +
    theme_classic() +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "none") + 
    ggtitle("Mitochondrial ROS") +
    labs(y= "A.U.", x = "pCO2 Exposure") #+
    #facet_wrap(~pCO2_history)
Day1_MitoROS_RxnNorm


#  14 days

Day14_MitoROS_RxnNorm <- data_filt %>% # data %>%
                          # edit data to suit out needs
                          dplyr::filter(Date %in% 20230516) %>% # filter for desired date of rhte experiment
                          dplyr::mutate(MitoSoxGreen_Mean_FL1 = 
                                          as.numeric(sub(",", "", MitoSoxGreen_Mean_FL1))) %>% 
                          # the % sign is included making this a character, omit the percent and make numeric!
                          dplyr::select(c('Date','pCO2_exposure','pCO2_history','MitoSoxGreen_Mean_FL1')) %>% 
                          na.omit() %>%   
                          group_by(pCO2_exposure, pCO2_history) %>% # group by columns for treatment
                          dplyr::summarise( # summarise to aquire the mean and SE for plotting
                            MitROS_mean = mean(MitoSoxGreen_Mean_FL1), # mean
                            MitROS_sd = sd(MitoSoxGreen_Mean_FL1), # sd
                            n = n(), # count
                            MitROS_se = MitROS_sd / sqrt(n)) %>% # SE
                          # plot it
                          ggplot(aes(x=pCO2_exposure, y=MitROS_mean, group=pCO2_history)) + 
                            geom_line(aes(group = factor(pCO2_history), 
                                          linetype = pCO2_history), 
                                      size = 0.5, 
                                      position=position_dodge(.4)) +  # connect a line between variables
                            scale_linetype_manual(values=c("solid", "dashed", "dotted")) +
                            geom_point(aes(shape=pCO2_history, fill=pCO2_history), 
                                       size = 4.5,position=position_dodge(.4)) + 
                            scale_shape_manual(values=c(21, 22, 24)) + # filled circle, filled triangle, and X 
                            scale_fill_manual(values=
                                                c("#009E73","#E69F00", "#CC79A7")) + 
                            # fill cicle white, triangle white, and jsut black for the X
                            geom_errorbar(aes(ymin=(MitROS_mean)-(MitROS_se), 
                                              ymax=(MitROS_mean)+(MitROS_se)), 
                                          width=0,position=position_dodge(.4)) + 
                            # width dtermines the length of the end ticks
                            # geom_jitter() +
                            theme_classic() +
                            theme(panel.grid.major = element_blank(), 
                                  panel.grid.minor = element_blank(),
                                  legend.position = "none") + 
                            ggtitle("Mitochondrial ROS") +
                            labs(y= "A.U.", x = "pCO2 Exposure")# +
                            #facet_wrap(~pCO2_history)
Day14_MitoROS_RxnNorm


ggarrange(Day1_MitoROS_RxnNorm, Day14_MitoROS_RxnNorm, nrow=2)






# porototype thenormalization of AUs 
# 0-1 normalization == (x-min(x))/(max(x)-min(x))

# get min
D1_min_mtROS <- min((data_filt %>% # data %>%
                    # edit data to suit out needs
                    dplyr::filter(Date %in% 20230516) %>% # filter for desired date of rhte experiment
                    dplyr::mutate(MitoSoxGreen_Mean_FL1 = as.numeric(sub(",", "", MitoSoxGreen_Mean_FL1))) %>% # the % sign is included making this a character, omit the percent and make numeric!
                    dplyr::select(c('Date','pCO2_exposure','pCO2_history','MitoSoxGreen_Mean_FL1')) %>% 
                    na.omit())$MitoSoxGreen_Mean_FL1)
# get max
D1_max_mtROS <- max((data_filt %>% # data %>%
                    # edit data to suit out needs
                    dplyr::filter(Date %in% 20230516) %>% # filter for desired date of rhte experiment
                    dplyr::mutate(MitoSoxGreen_Mean_FL1 = as.numeric(sub(",", "", MitoSoxGreen_Mean_FL1))) %>% # the % sign is included making this a character, omit the percent and make numeric!
                    dplyr::select(c('Date','pCO2_exposure','pCO2_history','MitoSoxGreen_Mean_FL1')) %>% 
                    na.omit())$MitoSoxGreen_Mean_FL1)

# figure with this normalization
Day14_MitoROS_RxnNorm_NORMALIZED <- data_filt %>% # data %>%
                              # edit data to suit out needs
                              dplyr::filter(Date %in% 20230516) %>% # filter for desired date of rhte experiment
                              dplyr::mutate(MitoSoxGreen_Mean_FL1 = as.numeric(sub(",", "", MitoSoxGreen_Mean_FL1))) %>% # the % sign is included making this a character, omit the percent and make numeric!
                              dplyr::select(c('Date','pCO2_exposure','pCO2_history','MitoSoxGreen_Mean_FL1')) %>% 
                              na.omit() %>%   
                              dplyr::mutate(mtROS_normalized = 
                                              (MitoSoxGreen_Mean_FL1-D1_min_mtROS)/(D1_max_mtROS-D1_min_mtROS)) %>% # 0-1 normalization normalized = (x-min(x))/(max(x)-min(x))
                              group_by(pCO2_exposure, pCO2_history) %>% # group by columns for treatment
                              dplyr::summarise( # summarise to aquire the mean and SE for plotting
                                MitROS_mean = mean(mtROS_normalized), # mean
                                MitROS_sd = sd(mtROS_normalized), # sd
                                n = n(), # count
                                MitROS_se = MitROS_sd / sqrt(n)) %>% # SE
                              # plot it
                              ggplot(aes(x=pCO2_exposure, y=MitROS_mean, group=pCO2_history)) + 
                                geom_line(aes(group = factor(pCO2_history), linetype = pCO2_history), size = 0.5, position=position_dodge(.4)) +  # connect a line between variables
                                scale_linetype_manual(values=c("solid", "dashed", "dotted")) +
                                geom_point(aes(shape=pCO2_history, fill=pCO2_history), size = 4.5,position=position_dodge(.4)) + 
                                scale_shape_manual(values=c(21, 22, 24)) + # filled circle, filled triangle, and X 
                                scale_fill_manual(values=c("#009E73","#E69F00", "#CC79A7")) + # fill cicle white, triangle white, and jsut black for the X
                                geom_errorbar(aes(ymin=(MitROS_mean)-(MitROS_se), 
                                                  ymax=(MitROS_mean)+(MitROS_se)), 
                                              width=0,position=position_dodge(.4)) + # width dtermines the length of the end ticks
                                # geom_jitter() +
                                theme_classic() +
                                theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "none") + 
                                ggtitle("Mitochondrial ROS") +
                                labs(y= "A.U.", x = "pCO2 Exposure")# +

ggarrange(Day14_MitoROS_RxnNorm, Day14_MitoROS_RxnNorm_NORMALIZED, nrow=2)



data_filt %>% # data %>%
  # edit data to suit out needs
  dplyr::filter(Date %in% 20230516) %>% # filter for desired date of rhte experiment
  dplyr::select(c('Date','Scallop_ID','pCO2_exposure','pCO2_history','MitoSoxGreen_Mean_FL1')) %>% 
  na.omit() %>% 
  #dplyr::filter(!Scallop_ID %in% 5) %>% 
 # dplyr::filter(!Scallop_ID %in% 5) 
  ggplot(aes(x=pCO2_exposure, y=MitoSoxGreen_Mean_FL1, label=Scallop_ID)) + 
      geom_boxplot(alpha = 0.5) +
      #geom_dotplot(binaxis = 'y', stackdir='center', dotsize=1) +
      #geom_text_repel(arrow = arrow(length=unit(0.2,"npc")),box.padding=1) +
      theme_bw()+
      geom_text(aes(label=Scallop_ID), size = 3.5) +
     # #scale_color_manual(values = c("#0072B2", "#D55E00")) + # colorblindness palette blue and orange
     #  theme_classic() +
     #  theme(legend.position = "none") +
      facet_wrap(~pCO2_history)
```

### Mitochondrial membrane potential

* JC-10 (compensated for CCCP), gated using the FL1 (FITC-H) and FL1 vs. FL2 to truncate cells (FITC-H v. PE-H)

* data is the ratio of 'red to gree' as the Jaggregate (positive membrane potential) : Monomer (low memrane potential) or the FL 2 : FL 1 

```{r plot Mitochondrial membrane potential}



# 24 hours
  
Day1_MitoMemPot_RxnNorm <- data_filt %>% # data %>%
  # edit data to suit out needs
  dplyr::filter(Date %in% 20230502) %>% # filter for desired date of rhte experiment
  #dplyr::filter(!JC10_FL2_Jaggregate >1000000) %>%  
  dplyr::select(c('Date','pCO2_exposure','pCO2_history','JC10_FL2_FL1_Ratio')) %>% 
  na.omit() %>%  # omitts sample ID 64 that did not have sufficient hemolymph for this assay 
  #dplyr::select(c('pCO2_exposure', 'pCO2_history','SYBR_PI_count_alive')) %>%  # select desired columns
  group_by(pCO2_exposure, pCO2_history) %>% # group by columns for treatment
  dplyr::summarise( # summarise to aquire the mean and SE for plotting
    JC10_mean = mean(JC10_FL2_FL1_Ratio), # mean
    JC10_sd = sd(JC10_FL2_FL1_Ratio), # sd
    n = n(), # count
    JC10_se = JC10_sd / sqrt(n)) %>% # SE
  # plot it
  ggplot(aes(x=pCO2_exposure, y=JC10_mean, group=pCO2_history)) + 
    geom_line(aes(group = factor(pCO2_history), linetype = pCO2_history), size = 0.5, position=position_dodge(.4)) +  # connect a line between variables
    scale_linetype_manual(values=c("solid", "dashed", "dotted")) +
    geom_point(aes(shape=pCO2_history, fill=pCO2_history), size = 4.5,position=position_dodge(.4)) + 
    scale_shape_manual(values=c(21, 22, 24)) + # filled circle, filled triangle, and X 
    scale_fill_manual(values=c("#009E73","#E69F00", "#CC79A7")) + # fill cicle white, triangle white, and jsut black for the X
    geom_errorbar(aes(ymin=(JC10_mean)-(JC10_se), 
                      ymax=(JC10_mean)+(JC10_se)), 
                  width=.2,position=position_dodge(.4)) +
    # geom_jitter() +
    theme_classic() +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "none") + 
    ggtitle("Mitochondrial membrane potential") +
    labs(y= "A.U.", x = "pCO2 Exposure")# +
    #facet_wrap(~pCO2_history)
# Day1_MitoMemPot_RxnNorm



# 14 days

Day14_MitoMemPot_RxnNorm <- data_filt %>% # data %>%
  # edit data to suit out needs
  dplyr::filter(Date %in% 20230516) %>% # filter for desired date of rhte experiment
  # dplyr::filter(!JC10_FL2_Jaggregate >1000000) %>%  
  # dplyr::select(c('Date','pCO2_exposure','pCO2_history','JC10_FL2_FL1_Ratio')) %>% 
  # na.omit() %>%  # omitts sample ID 64 that did not have sufficient hemolymph for this assay 
  # #dplyr::select(c('pCO2_exposure', 'pCO2_history','SYBR_PI_count_alive')) %>%  # select desired columns
  # group_by(pCO2_exposure, pCO2_history) %>% # group by columns for treatment
  # dplyr::summarise( # summarise to aquire the mean and SE for plotting
  #   JC10_mean = mean(JC10_FL2_FL1_Ratio), # mean
  #   JC10_sd = sd(JC10_FL2_FL1_Ratio), # sd
  #   n = n(), # count
  #   JC10_se = JC10_sd / sqrt(n)) %>% # SE
  # plot it
  ggplot(aes(x=pCO2_exposure, 
             y=JC10_FL2_FL1_Ratio, 
             group=pCO2_history),
         stat="idenity") + 
                         geom_point(aes(colour = pCO2_history), 
                                        position = position_dodge2(width = 0.2)) + 
                       stat_summary(fun.y="mean", size = 0.8,
                                          position = position_dodge2(width = 1)) +
                       stat_summary(fun.min = function(x) mean(x) - sd(x)/sqrt(length(x)), 
                                          fun.max = function(x) mean(x) + sd(x)/sqrt(length(x)),
                                          geom = 'errorbar', width = 0.25, size = 1,
                                          position = position_dodge2(width = 0.2))
    geom_line(aes(group = factor(pCO2_history), linetype = pCO2_history), size = 0.5, position=position_dodge(.4)) +  # connect a line between variables
    scale_linetype_manual(values=c("solid", "dashed", "dotted")) +
    geom_point(aes(shape=pCO2_history, fill=pCO2_history), size = 4.5,position=position_dodge(.4)) + 
    scale_shape_manual(values=c(21, 22, 24)) + # filled circle, filled triangle, and X 
    scale_fill_manual(values=c("#009E73","#E69F00", "#CC79A7")) + # fill cicle white, triangle white, and jsut black for the X
    geom_errorbar(aes(ymin=(JC10_mean)-(JC10_se), 
                      ymax=(JC10_mean)+(JC10_se)), 
                  width=.2,position=position_dodge(.4)) +
    # geom_jitter() +
    theme_classic() +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "none") + 
    ggtitle("Mitochondrial membrane potential") +
    labs(y= "A.U.", x = "pCO2 Exposure") # +
    #facet_wrap(~pCO2_history)
# Day14_MitoMemPot_RxnNorm
Day14_MitoMemPot_RxnNorm

library(ggplot2)



## some data alterations - assign dodge by subsetting with named vector



Day14_MitoMemPotdodge_vec <- seq(-.25, .25, length = 9)
names(Day14_MitoMemPotdodge_vec) <- unique(with(data_filt_test, paste(pCO2_baseline_change,pCO2_history, pCO2_exposure, sep = "_")))


Day14_filt <- data_filt %>%
    dplyr::filter(Date %in% 20230516) %>% 
    mutate(cut_col = dodge_vec[paste(pCO2_baseline_change, pCO2_history, pCO2_exposure, sep = "_")]) %>% 
    mutate(line_group = paste0(pCO2_history, pCO2_exposure))
## summarise for your lines 

Day14_MitoMemPot_df_line <- 
  Day14_filt %>%
  dplyr::select(JC10_FL2_FL1_Ratio, pCO2_baseline_change, pCO2_history, pCO2_exposure, line_group, cut_col) %>% 
  na.omit() %>% 
  dplyr::group_by(pCO2_baseline_change, pCO2_history, pCO2_exposure, line_group, cut_col) %>%
  summarise(mean_JC10_FL2_FL1_Ratio = mean(JC10_FL2_FL1_Ratio))
#> `summarise()` has grouped output by 'clarity', 'cut', 'color'. You can override
#> using the `.groups` argument.

## need to pass your original x as an integer and add your new doding column
Day14_MitoMemPot_RxnNorm <- ggplot(Day14_filt, 
                             aes(x = as.integer(factor(pCO2_baseline_change)) + 
                                         cut_col, 
                                       y =JC10_FL2_FL1_Ratio, 
                                       color=pCO2_history, 
                                       fill= pCO2_history,
                                       shape=pCO2_exposure)) +
                             geom_line(data = Day14_MitoMemPot_df_line, 
                                        aes(y = mean_JC10_FL2_FL1_Ratio, 
                                            group = interaction(line_group)),
                                            # group = interaction(pCO2_history, pCO2_exposure)),
                                            # group = interaction(as.integer(pCO2_baseline_change), pCO2_history)
                                            size = 2,
                                            alpha = 0.1) +
                              stat_summary(fun.data= mean_se, geom="errorbar", width=0) +
                              stat_summary(fun=mean, geom="point", size=5) +
                              ## add lines with your new data, using an interaction variable
                              scale_x_continuous(breaks = 1:2, labels = unique(Day14_filt$pCO2_baseline_change)) + 
                              scale_shape_manual(values=c(21, 22, 24)) +
                              scale_colour_manual(values=c("grey20","grey20", "grey20")) +
                              scale_fill_manual(values=c("#009E73","#E69F00", "#CC79A7")) + 
                              xlab('pCO2 Exposure') +
                              theme_classic() +
                              theme(legend.position="none")
                            #> Warning: Using shapes for an ordinal variable is not advised





Day14_Perc_Alive_df_line <- 
  Day14_filt %>%
  dplyr::select(SYBR_PI_prop_alive_ADJ, pCO2_baseline_change, pCO2_history, pCO2_exposure, line_group, cut_col) %>% 
  na.omit() %>% 
  dplyr::group_by(pCO2_baseline_change, pCO2_history, pCO2_exposure, line_group, cut_col) %>%
  summarise(mean_SYBR_PI_prop_alive_ADJ= mean(SYBR_PI_prop_alive_ADJ))


Day14_PercAlive_RxnNorm <- ggplot(Day14_filt, 
                             aes(x = as.integer(factor(pCO2_baseline_change)) + 
                                         cut_col, 
                                       y =SYBR_PI_prop_alive_ADJ, 
                                       color=pCO2_history, 
                                       fill= pCO2_history,
                                       shape=pCO2_exposure)) +
                             geom_line(data = Day14_Perc_Alive_df_line, 
                                        aes(y = mean_SYBR_PI_prop_alive_ADJ, 
                                            group = interaction(line_group)),
                                            # group = interaction(pCO2_history, pCO2_exposure)),
                                            # group = interaction(as.integer(pCO2_baseline_change), pCO2_history)
                                            size = 2,
                                            alpha = 0.1) +
                              stat_summary(fun.data= mean_se, geom="errorbar", width=0) +
                              stat_summary(fun=mean, geom="point", size=5) +
                              ## add lines with your new data, using an interaction variable
                              scale_x_continuous(breaks = 1:2, labels = unique(Day14_filt$pCO2_baseline_change)) + 
                              scale_shape_manual(values=c(21, 22, 24)) +
                              scale_colour_manual(values=c("grey20","grey20", "grey20")) +
                              scale_fill_manual(values=c("#009E73","#E69F00", "#CC79A7")) + 
                              xlab('pCO2 Exposure') +
                              theme_classic() +
                              theme(legend.position="none")
                            #> Warning: Using shapes for an ordinal variable is not advised



Day14_MitSox_df_line <- 
  Day14_filt %>%
  dplyr::select(MitoSoxGreen_Mean_FL1, pCO2_baseline_change, pCO2_history, pCO2_exposure, line_group, cut_col) %>% 
  na.omit() %>% 
  dplyr::group_by(pCO2_baseline_change, pCO2_history, pCO2_exposure, line_group, cut_col) %>%
  summarise(mean_MitoSoxGreen_Mean_FL1= mean(MitoSoxGreen_Mean_FL1))


Day14_MitoSox_RxnNorm <- ggplot(Day14_filt, 
                             aes(x = as.integer(factor(pCO2_baseline_change)) + 
                                         cut_col, 
                                       y =MitoSoxGreen_Mean_FL1, 
                                       color=pCO2_history, 
                                       fill= pCO2_history,
                                       shape=pCO2_exposure)) +
                             geom_line(data = Day14_MitSox_df_line, 
                                        aes(y = mean_MitoSoxGreen_Mean_FL1, 
                                            group = interaction(line_group)),
                                            # group = interaction(pCO2_history, pCO2_exposure)),
                                            # group = interaction(as.integer(pCO2_baseline_change), pCO2_history)
                                            size = 2,
                                            alpha = 0.1) +
                              stat_summary(fun.data= mean_se, geom="errorbar", width=0) +
                              stat_summary(fun=mean, geom="point", size=5) +
                              ## add lines with your new data, using an interaction variable
                              scale_x_continuous(breaks = 1:2, labels = unique(Day14_filt$pCO2_baseline_change)) + 
                              scale_shape_manual(values=c(21, 22, 24)) +
                              scale_colour_manual(values=c("grey20","grey20", "grey20")) +
                              scale_fill_manual(values=c("#009E73","#E69F00", "#CC79A7")) + 
                              xlab('pCO2 Exposure') +
                              theme_classic() +
                              theme(legend.position="none")
                            #> Warning: Using shapes for an ordinal variable is not advise

ggarrange(Day14_PercAlive_RxnNorm,
          Day14_MitoSox_RxnNorm,
          Day14_MitoMemPot_RxnNorm, ncol=3)
```

```{r output plots by date} 


# all 24 hours
Day1_Mitochondria_RxnNorm <- ggarrange(Day1_MitoROS_RxnNorm, Day1_MitoMemPot_RxnNorm, nrow =1)
pdf(paste0("C:/Users/samjg/Documents/Github_repositories/Airradians_CellularMolecular_OA/RAnalysis/Output/FlowCytometry/Day1_All_Plots.pdf"), height = 8, width = 8)
ggarrange(Day1_StackedBar, Day1_Mitochondria_RxnNorm, ncol=1)
dev.off()

# all day 14
Day14_Mitochondria_RxnNorm <- ggarrange(Day14_MitoROS_RxnNorm, Day14_MitoMemPot_RxnNorm, nrow =1)
pdf(paste0("C:/Users/samjg/Documents/Github_repositories/Airradians_CellularMolecular_OA/RAnalysis/Output/FlowCytometry/Day14_All_Plots.pdf"), height = 8, width = 8)
ggarrange(Day14_StackedBar, Day14_Mitochondria_RxnNorm, ncol=1)
dev.off()


pdf(paste0("C:/Users/samjg/Documents/Github_repositories/Airradians_CellularMolecular_OA/RAnalysis/Output/FlowCytometry/Day14_RxnNorm_Plots.pdf"), height = 3, width = 8)
ggarrange(Day14_PercAlive_RxnNorm,
          Day14_MitoSox_RxnNorm,
          Day14_MitoMemPot_RxnNorm, ncol=3)
dev.off()






# cell viability

pdf(paste0("C:/Users/samjg/Documents/Github_repositories/Airradians_CellularMolecular_OA/RAnalysis/Output/FlowCytometry/CellViability_StackedBar.pdf"), height = 8)
ggarrange(Day1_StackedBar, Day14_StackedBar, ncol=1)
dev.off()


pdf(paste0("C:/Users/samjg/Documents/Github_repositories/Airradians_CellularMolecular_OA/RAnalysis/Output/FlowCytometry/CellViability_RxnNorm.pdf"), height = 8)
ggarrange(Day1_PropLive_RxnNorm, Day14_PropDead_RxnNorm, ncol=1)
dev.off()

# mitochondrialsuperoxide
pdf(paste0("C:/Users/samjg/Documents/Github_repositories/Airradians_CellularMolecular_OA/RAnalysis/Output/FlowCytometry/MitoSox_RxnNorm.pdf"), height = 8)
ggarrange(Day1_MitoROS_RxnNorm, Day14_MitoROS_RxnNorm, ncol=1)
dev.off()


# itochondrial membrane potential
pdf(paste0("C:/Users/samjg/Documents/Github_repositories/Airradians_CellularMolecular_OA/RAnalysis/Output/FlowCytometry/MembranePotential_RxnNorm.pdf"), height = 8)
ggarrange(Day1_MitoMemPot_RxnNorm, Day14_MitoMemPot_RxnNorm,ncol=1)
dev.off()
```




## Statistical analysis


### PERMANOVA 
```{r, metadata}
library(vegan)
# METADATA
D1_metadata   <- Day1_datafilt  %>% 
                      dplyr::select(Scallop_ID, pCO2_history, pCO2_exposure, SYBR_PI_prop_alive_ADJ, MitoSoxGreen_Mean_FL1, JC10_FL2_FL1_Ratio) %>% 
                      dplyr::rename(sample.id = Scallop_ID) %>% 
                      na.omit() %>% # takeso out smaple Ids that had even one NA in the DV data 
                      dplyr::select(-c(SYBR_PI_prop_alive_ADJ, MitoSoxGreen_Mean_FL1, JC10_FL2_FL1_Ratio))
  
D14_metadata  <- Day14_datafilt %>%
                      dplyr::select(Scallop_ID, pCO2_history, pCO2_exposure, SYBR_PI_prop_alive_ADJ, MitoSoxGreen_Mean_FL1, JC10_FL2_FL1_Ratio) %>% 
                      dplyr::rename(sample.id = Scallop_ID) %>% 
                      na.omit() %>%  # takeso out smaple Ids that had even one NA in the DV data 
                      dplyr::select(-c(SYBR_PI_prop_alive_ADJ, MitoSoxGreen_Mean_FL1, JC10_FL2_FL1_Ratio))

# CALL JUST THE DVs FOR THE MATRIX
D1_depvars        <- Day1_datafilt[, c('SYBR_PI_prop_alive_ADJ', 'MitoSoxGreen_Mean_FL1', 'JC10_FL2_FL1_Ratio'), drop = FALSE]
D1_depvars_OM     <- na.omit(D1_depvars)
D1_distance_euc   <- vegdist(D1_depvars_OM, "euclidean")

D14_depvars       <- Day14_datafilt[, c('SYBR_PI_prop_alive_ADJ', 'MitoSoxGreen_Mean_FL1', 'JC10_FL2_FL1_Ratio'), drop = FALSE]
D14_depvars_OM    <- na.omit(D14_depvars)
D14_distance_euc  <- vegdist(D14_depvars_OM, "euclidean")

# CREATE SQUARE MATRIX ASSIGN ROW NAMES AND COLUMN NAMES AS THE GROUP VAR
D1_scallop_IDs_OM          <- (Day1_datafilt %>% 
                                 dplyr::select(c('Scallop_ID', 'SYBR_PI_prop_alive_ADJ', 'MitoSoxGreen_Mean_FL1', 'JC10_FL2_FL1_Ratio')) %>% 
                                 na.omit())$Scallop_ID # omit NAs as we did for the euclidean dist amtrix data and call just the IDs
D1_distance_mtx            <- as.matrix(D1_distance_euc)
rownames(D1_distance_mtx)  <- D1_scallop_IDs_OM
colnames(D1_distance_mtx)  <- D1_scallop_IDs_OM

D14_scallop_IDs_OM          <- (Day14_datafilt %>% 
                                 dplyr::select(c('Scallop_ID', 'SYBR_PI_prop_alive_ADJ', 'MitoSoxGreen_Mean_FL1', 'JC10_FL2_FL1_Ratio')) %>% 
                                 na.omit())$Scallop_ID # omit NAs as we did for the euclidean dist amtrix data and call just the IDs
D14_distance_mtx           <- as.matrix(D14_distance_euc)
rownames(D14_distance_mtx) <- D14_scallop_IDs_OM
colnames(D14_distance_mtx) <- D14_scallop_IDs_OM


# Then...
# CONVERT THE ROWNAME TO FIRST COLUMN, CONVERT TO DATAFRAME TO DO SO
D1_distance  <- tibble::rownames_to_column(as.data.frame(D1_distance_mtx), "sample.id")
D14_distance  <- tibble::rownames_to_column(as.data.frame(D14_distance_mtx), "sample.id")


# NOW USE INNER_JOIN TO MERGE THE METADATA 
D1_meta_distance   <- inner_join(D1_distance,  D1_metadata, by = "sample.id")
D14_meta_distance  <- inner_join(D14_distance,  D14_metadata, by = "sample.id")


# get the dist matrix
# * isolate the distance data - for the LHS (DV) of adonis!
D1_dist   <- D1_meta_distance  %>% dplyr::select(all_of(D1_meta_distance$sample.id)) %>% as.dist() 
D14_dist  <- D14_meta_distance  %>% dplyr::select(all_of(D14_meta_distance$sample.id)) %>% as.dist() 


# RUN ADONIS
# formula as () LHS (disc required!) ~ RHS (your metadata), data = metadata, perms)
permutations = 10000
D1_adonis_run   <- adonis2(D1_dist  ~ pCO2_history*pCO2_exposure, data=D1_meta_distance, perms = permutations) 
D14_adonis_run  <- adonis2(D14_dist ~ pCO2_history*pCO2_exposure, data=D14_meta_distance, perms = permutations) 



# Paiwrise DAY 14
# METADATA (IV)
D14_HxL_history_metadata <- D14_meta_distance %>% dplyr::filter(pCO2_history %in% c('severe', 'low'))
D14_HxM_history_metadata <- D14_meta_distance %>% dplyr::filter(pCO2_history %in% c('severe', 'moderate'))
D14_LxM_history_metadata <- D14_meta_distance %>% dplyr::filter(pCO2_history %in% c('low', 'moderate'))
# DISTANCE (DV)
D14_HxL_history_dist    <- D14_meta_distance %>% 
                            dplyr::filter(sample.id %in% D14_HxL_history_metadata$sample.id) %>% 
                            dplyr::select(D14_HxL_history_metadata$sample.id) %>% 
                            as.dist() 
D14_HxM_history_dist   <- D14_meta_distance %>% 
                            dplyr::filter(sample.id %in% D14_HxM_history_metadata$sample.id) %>% 
                            dplyr::select(D14_HxM_history_metadata$sample.id) %>% 
                            as.dist() 
D14_LxM_history_dist   <- D14_meta_distance %>% 
                            dplyr::filter(sample.id %in% D14_LxM_history_metadata$sample.id) %>% 
                            dplyr::select(D14_LxM_history_metadata$sample.id) %>% 
                            as.dist() 
# RUN ADONIS FOR EACH PAIR
D14_adonis_HxL_history   <- adonis2(D14_HxL_history_dist  ~ pCO2_history, data=D14_HxL_history_metadata, perms = permutations) 
D14_adonis_HxM_history   <- adonis2(D14_HxM_history_dist  ~ pCO2_history, data=D14_HxM_history_metadata, perms = permutations) 
D14_adonis_LxM_history   <- adonis2(D14_LxM_history_dist  ~ pCO2_history, data=D14_LxM_history_metadata, perms = permutations) 
```

### ANOVAs 

* Run two way model for pCO2 history x pCO2 exposure effects 
* Then explore within history for effects of pCO2 exposure

```{r ANOVAs - Cell viability}

library(FSA)
library(rcompanion)



# Day 1


D1_PropAlive_Twoway <- (glm(SYBR_PI_prop_alive_ADJ ~ 
                              pCO2_history*pCO2_exposure, 
                            family = binomial(link = 'logit'),
                            data = Day1_datafilt))
shapiro.test(resid(aov(D1_PropAlive_Twoway))) # 0.4984
leveneTest(D1_PropAlive_Twoway) # 0.5645
summary(aov(D1_PropAlive_Twoway)) # no effect
#                            Df Sum Sq Mean Sq F value Pr(>F)
# pCO2_history                2 0.0341 0.01707   0.897  0.417
# pCO2_exposure               2 0.0352 0.01762   0.926  0.406
# pCO2_history:pCO2_exposure  4 0.1180 0.02951   1.551  0.209
# Residuals                  35 0.6661 0.01903               
# 1 observation deleted due to missingness
D1_PropAlive_Twoway$model
em <- emmeans(D1_PropAlive_Twoway, "pCO2_exposure")
contrast(em, "pairwise", adjust = "Tukey")
#                            Df Sum Sq Mean Sq F value Pr(>F)
# pCO2_history                2 0.0341 0.01707   0.897  0.417
# pCO2_exposure               2 0.0352 0.01762   0.926  0.406
# pCO2_history:pCO2_exposure  4 0.1180 0.02951   1.551  0.209
# Residuals                  35 0.6661 0.01903 

D1_PropAlive_Low <- (glm(SYBR_PI_prop_alive_ADJ ~ pCO2_exposure, 
                         family = binomial(link = 'logit'),
                         data = (Day1_datafilt %>%  
                                   dplyr::select(SYBR_PI_prop_alive_ADJ,pCO2_exposure,pCO2_history) %>% 
                                   na.omit() %>% 
                                   dplyr::filter(pCO2_history %in% 'low'))))
shapiro.test(resid((D1_PropAlive_Low))) # 0.8451
leveneTest(D1_PropAlive_Low) # 0.9756
summary(aov(D1_PropAlive_Low)) # no effect 



D1_PropAlive_Mod <- (glm(SYBR_PI_prop_alive_ADJ ~ pCO2_exposure, 
                         family = binomial(link = 'logit'),
                         data = (Day1_datafilt %>%  dplyr::filter(pCO2_history %in% 'moderate'))))
shapiro.test(resid((D1_PropAlive_Mod))) # 0.2201
leveneTest(D1_PropAlive_Mod) # 0.9391
summary(aov(D1_PropAlive_Mod)) # no effect 



D1_PropAlive_Sev <- (glm(SYBR_PI_prop_alive_ADJ ~ 
                           pCO2_exposure, 
                         family = binomial(link = 'logit'),
                         data = (Day1_datafilt %>%  dplyr::filter(pCO2_history %in% 'severe'))))
shapiro.test(resid((D1_PropAlive_Sev))) # 0.002987
leveneTest(D1_PropAlive_Sev) # 0.1222
summary(aov(D1_PropAlive_Sev)) # pCO2_exposure 0.0507 .
D1_PropAlive_Sev_KW <- kruskal.test(SYBR_PI_prop_alive_ADJ ~ 
                                       pCO2_exposure,
                         data = (Day1_datafilt %>%  
                                   dplyr::select(SYBR_PI_prop_alive_ADJ, pCO2_history,pCO2_exposure) %>% 
                                   dplyr::filter(pCO2_history %in% 'severe') %>% 
                                   na.omit()))
D1_PropAlive_Sev_KW
# Kruskal-Wallis chi-squared = 6.1229, df = 2, p-value = 0.04682


proplive_means <- Day1_datafilt %>% 
                          dplyr::select(pCO2_exposure,pCO2_history,SYBR_PI_prop_alive_ADJ) %>% 
                          na.omit() %>% 
                          dplyr::filter(pCO2_history %in% 'severe') %>% 
                          dplyr::group_by(pCO2_exposure) %>% 
                          dplyr::summarise(mean_proplive = mean(SYBR_PI_prop_alive_ADJ), 
                                           n           = n(),
                                           sd_proplive   = sd(SYBR_PI_prop_alive_ADJ),
                                           se_proplive   = sd_proplive/(sqrt(n)))






# Day 14



D14_PropAlive_Twoway <- (glm(SYBR_PI_prop_alive_ADJ ~ 
                               pCO2_history*pCO2_exposure, 
                             family = binomial(link = 'logit'),
                            data = Day14_datafilt))
shapiro.test(resid(aov(D14_PropAlive_Twoway))) # 0.6175
leveneTest(D14_PropAlive_Twoway) # 0.02092 *
summary(aov(D14_PropAlive_Twoway)) # 
#                            Df  Sum Sq  Mean Sq F value Pr(>F)  
# pCO2_history                2 0.04448 0.022241   2.684 0.0832 .
# pCO2_exposure               2 0.04238 0.021189   2.557 0.0928 .
# pCO2_history:pCO2_exposure  4 0.05923 0.014806   1.787 0.1550  
# Residuals                  33 0.27347 0.008287


proplive_means <- Day14_datafilt %>% 
                          dplyr::select(pCO2_exposure,pCO2_history,SYBR_PI_prop_alive_ADJ) %>% 
                          na.omit() %>% 
                          dplyr::group_by(pCO2_history,pCO2_exposure) %>% 
                          dplyr::summarise(mean_proplive = mean(SYBR_PI_prop_alive_ADJ), 
                                           n           = n(),
                                           sd_proplive   = sd(SYBR_PI_prop_alive_ADJ),
                                           se_proplive   = sd_proplive/(sqrt(n)))



D14_PropAlive_Baseline <- (glm(as.numeric(SYBR_PI_prop_alive_ADJ)  ~ 
                            pCO2_history, 
                          family = binomial(link = 'logit'),
                          data = (Day14_datafilt %>%  dplyr::filter(pCO2_baseline_change %in% 'baseline'))))
shapiro.test(resid(aov(D14_PropAlive_Baseline))) # 0.6495
leveneTest(D14_PropAlive_Baseline) # 0.319 
summary(aov(D14_PropAlive_Baseline)) # 
#              Df  Sum Sq   Mean Sq F value Pr(>F)
# pCO2_history  2 0.00129 0.0006451   0.322  0.732
# Residuals    10 0.02004 0.0020038


D14_PropAlive_Baseline_modBetaReg     <- betareg(SYBR_PI_prop_alive_ADJ~pCO2_history, 
                                                 data = (Day14_datafilt %>%  dplyr::filter(pCO2_baseline_change %in% 'baseline'))
                                                 )
joint_tests(D14_PropAlive_Baseline_modBetaReg)
 # model term   df1 df2 F.ratio Chisq p.value
 # pCO2_history   2 Inf   0.322 0.644  0.7250




D14_PropAlive_Low <- (glm(as.numeric(SYBR_PI_prop_alive_ADJ)  ~ 
                            pCO2_exposure, 
                          family = binomial(link = 'logit'),
                          data = (Day14_datafilt %>%  dplyr::filter(pCO2_history %in% 'low'))))
shapiro.test(resid(aov(D14_PropAlive_Low))) # 0.5705
leveneTest(D14_PropAlive_Low) # 0.05436 
summary(aov(D14_PropAlive_Low)) # 0.093  marginal effect
TukeyHSD(aov(D14_PropAlive_Low))



D14_PropAlive_Low_modBetaReg  <- betareg(SYBR_PI_prop_alive_ADJ~pCO2_exposure, 
                                                 data = (Day14_datafilt %>%  dplyr::filter(pCO2_history %in% 'low'))
                                                 )
joint_tests(D14_PropAlive_Low_modBetaReg)
 # model term    df1 df2 F.ratio Chisq p.value
 # pCO2_exposure   2 Inf   3.538 7.076  0.0291
library(multcomp)
linearHypothesis(D14_PropAlive_Low_modBetaReg, "pCO2_exposuresevere = pCO2_exposuremoderate")
linearHypothesis(D14_PropAlive_Low_modBetaReg, "(Intercept) = pCO2_exposuremoderate")
linearHypothesis(D14_PropAlive_Low_modBetaReg, "(Intercept) = pCO2_exposuresevere")
summary(glht(D14_PropAlive_Low_modBetaReg, linfct = c("pCO2_exposuresevere = 0", "pCO2_exposuremoderate = 0")))






D14_PropAlive_Mod <- (glm(as.numeric(SYBR_PI_prop_alive_ADJ) ~ 
                            pCO2_exposure, 
                          family = binomial(link = 'logit'),
                         data = (Day14_datafilt %>%  dplyr::filter(pCO2_history %in% 'moderate'))))
shapiro.test(resid(aov(D14_PropAlive_Mod))) # 0.5876
leveneTest(D14_PropAlive_Mod) # 0.6611
summary(aov(D14_PropAlive_Mod)) # no effect


D14_PropAlive_Mod_modBetaReg  <- betareg(SYBR_PI_prop_alive_ADJ~pCO2_exposure, 
                                                 data = (Day14_datafilt %>%  dplyr::filter(pCO2_history %in% 'moderate'))
                                                 )
joint_tests(D14_PropAlive_Mod_modBetaReg)
 # model term    df1 df2 F.ratio Chisq p.value
 # pCO2_exposure   2 Inf   0.094 0.188  0.9106







D14_PropAlive_Sev <- (glm(as.numeric(SYBR_PI_prop_alive_ADJ)
                              ~ pCO2_exposure, 
                              family = binomial(link = 'logit'),
                              data = (Day14_datafilt %>%  dplyr::filter(pCO2_history %in% 'severe'))))
shapiro.test(resid(D14_PropAlive_Sev)) # 0.3883
leveneTest(D14_PropAlive_Sev) # 0.3777
summary(aov(D14_PropAlive_Sev)) #  0.126


D14_PropAlive_Sev_modBetaReg  <- betareg(SYBR_PI_prop_alive_ADJ~pCO2_exposure, 
                                                 data = (Day14_datafilt %>%  dplyr::filter(pCO2_history %in% 'severe'))
                                                 )
joint_tests(D14_PropAlive_Sev_modBetaReg)
 # model term    df1 df2 F.ratio Chisq p.value
 # pCO2_exposure   2 Inf   2.834 5.668  0.0588


D14_PropAlive_Sev_modBetaReg  <- betareg(SYBR_PI_prop_alive_ADJ~pCO2_exposure, 
                                                 data = (Day14_datafilt %>%  dplyr::filter(pCO2_history %in% 'severe'))
                                                 )
joint_tests(D14_PropAlive_Sev_modBetaReg)
 # model term    df1 df2 F.ratio Chisq p.value
 # pCO2_exposure   2 Inf   2.834 5.668  0.0588












D14_PropAlive_LowExp <- (glm(as.numeric(SYBR_PI_prop_alive_ADJ)  ~ 
                            pCO2_history, 
                          family = binomial(link = 'logit'),
                          data = (Day14_datafilt %>%  dplyr::filter(pCO2_exposure %in% 'low'))))
shapiro.test(resid(aov(D14_PropAlive_LowExp))) # 0.333
leveneTest(D14_PropAlive_LowExp) # 0.9028 
summary(aov(D14_PropAlive_LowExp)) # 0.426



D14_PropAlive_ModExp <- (glm(as.numeric(SYBR_PI_prop_alive_ADJ) ~ 
                            pCO2_history, 
                          family = binomial(link = 'logit'),
                         data = (Day14_datafilt %>%  dplyr::filter(pCO2_exposure %in% 'moderate'))))
shapiro.test(resid(aov(D14_PropAlive_ModExp))) # 0.4475
leveneTest(D14_PropAlive_ModExp) # 0.4033
summary(aov(D14_PropAlive_ModExp)) # marginal effect 0.0885 .
TukeyHSD(aov(D14_PropAlive_ModExp))
# moderate-low     0.16047507 -0.01467893 0.33562906 0.0737852

D14_PropAlive_SevExp <- (glm(as.numeric(SYBR_PI_prop_alive_ADJ)
                              ~ pCO2_history, 
                              family = binomial(link = 'logit'),
                              data = (Day14_datafilt %>%  dplyr::filter(pCO2_exposure %in% 'severe'))))
shapiro.test(resid(D14_PropAlive_SevExp)) # 0.6402
leveneTest(D14_PropAlive_SevExp) # 0.0603 .
summary(aov(D14_PropAlive_SevExp)) # n.s.
```

```{r ANOVAs - mtROS}

library(FSA)
library(rcompanion)



# Day 1


D1_mtROS_Twoway <- (lm(MitoSoxGreen_Mean_FL1 ~ pCO2_history*pCO2_exposure, data = Day1_datafilt))
shapiro.test(resid(aov(D1_mtROS_Twoway))) # 0.6764
leveneTest(D1_mtROS_Twoway) # 0.6313
summary(aov(D1_mtROS_Twoway)) # marginal effect of history
#                            Df Sum Sq Mean Sq F value Pr(>F)
# pCO2_history                2   47.3   23.63   0.536  0.590
# pCO2_exposure               2   68.0   34.00   0.771  0.470
# pCO2_history:pCO2_exposure  4  277.0   69.26   1.571  0.204
# Residuals                  34 1498.7   44.08

D1_mtROS_Low <- (lm(MitoSoxGreen_Mean_FL1 ~ pCO2_exposure, 
                    data = (Day1_datafilt %>%  dplyr::filter(pCO2_history %in% 'low'))))
shapiro.test(resid(aov(D1_mtROS_Low))) # 0.9996
leveneTest(D1_mtROS_Low) # 0.7201
summary(aov(D1_mtROS_Low)) # no effect 

D1_mtROS_Mod <- (lm(MitoSoxGreen_Mean_FL1 ~ pCO2_exposure, 
                    data = (Day1_datafilt %>%  dplyr::filter(pCO2_history %in% 'moderate'))))
shapiro.test(resid(aov(D1_mtROS_Mod))) # 0.9409
leveneTest(D1_mtROS_Mod) # 0.2463
summary(aov(D1_mtROS_Mod)) # no effect 

D1_mtROS_Sev <- (lm(MitoSoxGreen_Mean_FL1 ~ pCO2_exposure, 
                    data = (Day1_datafilt %>%  dplyr::filter(pCO2_history %in% 'severe'))))
shapiro.test(resid(aov(D1_mtROS_Sev))) # 0.6005
leveneTest(D1_mtROS_Sev) # 0.6072
summary(aov(D1_mtROS_Sev)) # no effect 




# Day 14



D14_mtROS_Twoway <- (lm(MitoSoxGreen_Mean_FL1 ~ pCO2_history*pCO2_exposure, data = Day14_datafilt))
shapiro.test(resid(aov(D14_mtROS_Twoway))) # 0.8083
leveneTest(D14_mtROS_Twoway) # 0.473
summary(aov(D14_mtROS_Twoway)) # 
#                            Df   Sum Sq Mean Sq F value   Pr(>F)    
# pCO2_history                2  9478086 4739043  11.197 0.000174 ***
# pCO2_exposure               2  7418399 3709200   8.764 0.000821 ***
# pCO2_history:pCO2_exposure  4  4743754 1185938   2.802 0.040585 *  
# Residuals                  35 14813652  423247
D14_mtROS_TwoWay_HSD        <- TukeyHSD(aov(D14_mtROS_Twoway))  
D14_mtROS_TwoWay_HSD_contr  <- emmeans::emmeans(object = aov(D14_mtROS_Twoway),
                                    pairwise ~ "pCO2_history:pCO2_exposure",
                                    adjust = "tukey")
D14_mtROS_TwoWay_HSD_means  <- multcomp::cld(object = D14_mtROS_TwoWay_HSD_contr$emmeans)
# pCO2_history pCO2_exposure emmean  SE df lower.CL upper.CL .group
#  low          moderate        3277 291 35     2686     3868  1    
#  moderate     moderate        3750 291 35     3159     4341  12   
#  low          severe          4400 291 35     3809     4990  123  
#  moderate     low             4739 291 35     4148     5330   23  
#  low          low             4801 325 35     4141     5462   23  
#  severe       severe          5185 291 35     4595     5776    3  
#  severe       moderate        5230 291 35     4639     5820    3  
#  moderate     severe          5319 291 35     4729     5910    3  
#  severe       low             5340 291 35     4749     5930    3
proplive_means <- Day14_datafilt %>% 
                          dplyr::select(pCO2_exposure,pCO2_history,MitoSoxGreen_Mean_FL1) %>% 
                          na.omit() %>% 
                          dplyr::group_by(pCO2_exposure,pCO2_history) %>% 
                          dplyr::summarise(mean_mROS = mean(MitoSoxGreen_Mean_FL1), 
                                           n           = n(),
                                           sd_mROS   = sd(MitoSoxGreen_Mean_FL1),
                                           se_mROS   = sd_mROS/(sqrt(n)))



D14_mtROS_Baseline <- (lm(MitoSoxGreen_Mean_FL1 ~ 
                           pCO2_history,
                           data = (Day14_datafilt %>%  dplyr::filter(pCO2_baseline_change %in% 'baseline'))
                          ))
shapiro.test(resid(aov(D14_mtROS_Baseline))) # 0.9865
leveneTest(D14_mtROS_Baseline) # 0.01957 *
D14_mtROS_Baseline_KW <- (kruskal.test(MitoSoxGreen_Mean_FL1 ~ 
                                    pCO2_history, 
                                  data = (Day14_datafilt %>%  
                                            dplyr::filter(pCO2_baseline_change %in% 'baseline'))))
# data:  MitoSoxGreen_Mean_FL1 by pCO2_history
# Kruskal-Wallis chi-squared = 6.3099, df = 2, p-value = 0.04264
D14_mtROS_Baseline_Dunns <- dunnTest(MitoSoxGreen_Mean_FL1 ~ pCO2_history,
               data = (Day14_datafilt %>%  
                         dplyr::filter(pCO2_baseline_change %in% 'baseline')),
              method="bh")      # Adjusts p-values for multiple comparisons;
D14_mtROS_Baseline_Dunns
# low - moderate	1.5119790	0.13053920	0.19580880	
# low - severe	-0.9078413	0.36396208	0.36396208	
# moderate - severe	-2.4689278	0.01355186	0.04065557	


D14_mtROS_Low <- (lm(MitoSoxGreen_Mean_FL1 ~ 
                       pCO2_exposure, 
                     data = (Day14_datafilt %>%  
                               dplyr::filter(pCO2_history %in% 'low'))))
shapiro.test(resid(aov(D14_mtROS_Low))) # 0.792
leveneTest(D14_mtROS_Low) # 0.04912 *
summary(aov(D14_mtROS_Low)) # pCO2_exposure  2 6054119 3027060   6.607 0.0148 *
D14_mtROS_Low_KW <- (kruskal.test(MitoSoxGreen_Mean_FL1 ~ 
                                    pCO2_exposure, 
                                  data = (Day14_datafilt %>%  
                                            dplyr::filter(pCO2_history %in% 'low'))))
D14_mtROS_Low_KW # 0.03175 - different, also shwon in the interaction term in the two way anova
D14_mtROS_Low_Dunns <- dunnTest(MitoSoxGreen_Mean_FL1 ~ pCO2_exposure,
               data = (Day14_datafilt %>%  
                         dplyr::filter(pCO2_history %in% 'low')),
              method="bh")      # Adjusts p-values for multiple comparisons;
D14_mtROS_Low_Dunns
# low - moderate	2.3697163	0.01780174	0.05340521	
# low - severe	0.3741657	0.70828101	0.70828101	
# moderate - severe	-2.1166010	0.03429372	0.05144058	








D14_mtROS_Mod <- (lm(MitoSoxGreen_Mean_FL1 ~ 
                       pCO2_exposure, 
                     data = (Day14_datafilt %>%  
                               dplyr::filter(pCO2_history %in% 'moderate'))))
shapiro.test(resid(aov(D14_mtROS_Mod))) # 0.04689
leveneTest(D14_mtROS_Mod) # 0.5748
D14_mtROS_Mod_KW <- (kruskal.test(MitoSoxGreen_Mean_FL1 ~ 
                                    pCO2_exposure, 
                                  data = (Day14_datafilt %>%  
                                            dplyr::filter(pCO2_history %in% 'moderate'))))
D14_mtROS_Mod_KW # 0.01072 - different, also shown in the interaction term in the two way anova
D14_mtROS_Mod_Dunns <- dunnTest(MitoSoxGreen_Mean_FL1 ~ pCO2_exposure,
               data = (Day14_datafilt %>%  
                         dplyr::filter(pCO2_history %in% 'moderate')),
              method="bh")      # Adjusts p-values for multiple comparisons;
D14_mtROS_Mod_Dunns
# low - moderate	1.814229	0.069642405	0.104463607	
# low - severe	-1.265037	0.205858228	0.205858228	
# moderate - severe	-2.975508	0.002925033	0.008775098	





D14_mtROS_Sev <- (lm(MitoSoxGreen_Mean_FL1 ~ 
                       pCO2_exposure, 
                     data = (Day14_datafilt %>%  
                               dplyr::filter(pCO2_history %in% 'severe'))))
shapiro.test(resid(aov(D14_mtROS_Sev))) # 0.1989
leveneTest(D14_mtROS_Sev) # 0.5174
summary(aov(D14_mtROS_Sev)) # no effect, also shown by the interaction term in the two way anova

```

```{r ANOVAs - Mitochondrial membrane potential}

library(FSA)
library(rcompanion)


# Day 1


D1_Mito_Twoway <- (lm(JC10_FL2_FL1_Ratio ~ pCO2_history*pCO2_exposure, data = Day1_datafilt))
shapiro.test(resid(aov(D1_Mito_Twoway))) # 0.1992
summary(aov(D1_Mito_Twoway)) # marginal effect of history
#                             Df Sum Sq Mean Sq F value Pr(>F)  
# pCO2_history                2   4126  2062.8   2.841 0.0736 .
# pCO2_exposure               2    677   338.4   0.466 0.6318  
# pCO2_history:pCO2_exposure  4   1404   351.1   0.484 0.7476
TukeyHSD(aov(D1_Mito_Twoway))
# $pCO2_history
#                      diff        lwr      upr     p adj
# moderate-low    24.221604  -1.321011 49.76422 0.0658178
# severe-low      16.972800  -9.038526 42.98413 0.2582674
# severe-moderate -7.248805 -32.791420 18.29381 0.7661487
# Low - a
# Moderate -b
# High - ab

D1_Mito_Baseline <- (lm(JC10_FL2_FL1_Ratio ~ 
                           pCO2_history,
                           data = (Day1_datafilt %>%  dplyr::filter(pCO2_baseline_change %in% 'baseline'))
                          ))
shapiro.test(resid(aov(D1_Mito_Baseline))) # 0.9758
leveneTest(D1_Mito_Baseline) # 0.7329
summary(aov(D1_Mito_Baseline))
#              Df Sum Sq Mean Sq F value Pr(>F)  
# pCO2_history  2   2263  1131.5   5.784 0.0174 *
# Residuals    12   2347   195.6               
# 2 observations deleted due to missingness
TukeyHSD(aov(D1_Mito_Baseline))
#                      diff        lwr      upr     p adj
# moderate-low    29.459227   5.859876 53.05858 0.0153229
# severe-low      20.022582  -3.576769 43.62193 0.1003391
# severe-moderate -9.436645 -33.035996 14.16271 0.5513766



D1_Mito_Low <- (lm(JC10_FL2_FL1_Ratio ~ pCO2_exposure, 
                   data = (Day1_datafilt %>%  dplyr::filter(pCO2_history %in% 'low'))))
shapiro.test(resid(aov(D1_Mito_Low))) # 0.9974
leveneTest(D1_Mito_Low) # 0.2271
summary(aov(D1_Mito_Low)) # no effect 

D1_Mito_Mod <- (lm(JC10_FL2_FL1_Ratio ~ pCO2_exposure, 
                   data = (Day1_datafilt %>%  dplyr::filter(pCO2_history %in% 'moderate'))))
shapiro.test(resid(aov(D1_Mito_Mod))) # 0.3856
leveneTest(D1_Mito_Mod) # 0.3622
summary(aov(D1_Mito_Mod)) # no effect 

D1_Mito_Sev <- (lm(JC10_FL2_FL1_Ratio ~ pCO2_exposure, 
                   data = (Day1_datafilt %>%  dplyr::filter(pCO2_history %in% 'severe'))))
shapiro.test(resid(aov(D1_Mito_Sev))) # 0.0275
leveneTest(D1_Mito_Sev) # 0.6718
D1_Mito_Sev_KW <- (kruskal.test(JC10_FL2_FL1_Ratio ~ pCO2_exposure, 
                                data = (Day1_datafilt %>%  dplyr::filter(pCO2_history %in% 'severe'))))
D1_Mito_Sev_KW # no effect # Kruskal-Wallis chi-squared = 1.5956, df = 2, p-value = 0.4503




# Day 14



D14_Mito_Twoway <- (lm(JC10_FL2_FL1_Ratio ~ pCO2_history*pCO2_exposure, data = Day14_datafilt))
shapiro.test(resid(aov(D14_Mito_Twoway))) # 0.0335
leveneTest(D14_Mito_Twoway) # 0.4607
D14_Mito_SRH <- (scheirerRayHare(JC10_FL2_FL1_Ratio ~ 
                                   pCO2_history*pCO2_exposure, 
                                 data = Day14_datafilt))
D14_Mito_SRH # marginal effect of history
#                            Df Sum Sq      H  p.value
# pCO2_history                2  795.4 5.2852 0.071176
# pCO2_exposure               2  669.5 4.4485 0.108148
# pCO2_history:pCO2_exposure  4  715.8 4.7563 0.313231


D14_Mito_Baseline <- (lm(JC10_FL2_FL1_Ratio ~ 
                           pCO2_history,
                           data = (Day14_datafilt %>%  dplyr::filter(pCO2_baseline_change %in% 'baseline'))
                          ))
shapiro.test(resid(aov(D14_Mito_Baseline))) # 0.3087
leveneTest(D14_Mito_Baseline) # 0.4259
summary(aov(D14_Mito_Baseline))
#              Df  Sum Sq  Mean Sq F value Pr(>F)
# pCO2_history  2 0.01256 0.006282   0.538    0.6
# Residuals    10 0.11676 0.011676               
# 2 observations deleted due to missingness
D14_Mito_Baseline_KW <- (kruskal.test(JC10_FL2_FL1_Ratio ~ 
                                    pCO2_history, 
                                  data = (Day14_datafilt %>%  
                                            dplyr::filter(pCO2_baseline_change %in% 'baseline'))))
D14_Mito_Baseline_KW
# data:  JC10_FL2_FL1_Ratio by pCO2_history
# Kruskal-Wallis chi-squared = 0.93956, df = 2, p-value = 0.6251

      

D14_Mito_Low <- (lm(JC10_FL2_FL1_Ratio ~ 
                      pCO2_exposure, 
                    data = (Day14_datafilt %>%  
                              dplyr::filter(pCO2_history %in% 'low'))))
shapiro.test(resid(aov(D14_Mito_Low))) # 0.2251
leveneTest(D14_Mito_Low) # 0.3604
summary(aov(D14_Mito_Low)) # sig diff!
#               Df Sum Sq Mean Sq F value Pr(>F)  
# pCO2_exposure  2 0.1964 0.09819   6.313 0.0149 *
# Residuals     11 0.1711 0.01555
D14_Mito_Low_HSD <- TukeyHSD(aov(D14_Mito_Low))
#                       diff         lwr        upr     p adj
# moderate-low     0.2950972  0.06913727 0.52105712 0.0121003
# severe-low       0.1341072 -0.09185277 0.36006708 0.2850953
# severe-moderate -0.1609900 -0.37402710 0.05204702 0.1483920

D14_Mito_Mod <- (lm(JC10_FL2_FL1_Ratio ~
                      pCO2_exposure, 
                    data = (Day14_datafilt %>%  
                              dplyr::filter(pCO2_history %in% 'moderate'))))
shapiro.test(resid(aov(D14_Mito_Mod))) # 0.8256
leveneTest(D14_Mito_Mod) # 0.455
summary(aov(D14_Mito_Mod)) # no effect 

D14_Mito_Sev <- (lm(JC10_FL2_FL1_Ratio ~ 
                      pCO2_exposure, 
                    data = (Day14_datafilt %>%  
                              dplyr::filter(pCO2_history %in% 'severe'))))
shapiro.test(resid(aov(D14_Mito_Sev))) # 0.03002
leveneTest(D14_Mito_Sev) # 0.5544
summary(aov(D14_Mito_Sev))
D14_Mito_Sev_KW <- (kruskal.test(JC10_FL2_FL1_Ratio ~ 
                                   pCO2_exposure, 
                                 data = (Day14_datafilt %>% 
                                           dplyr::filter(pCO2_history %in% 'severe'))))
D14_Mito_Sev_KW # no effect # Kruskal-Wallis chi-squared = 0.38571, df = 2, p-value = 0.8246
```




### One way ANOVAs
* Effect of pCO2 exposure within each pXCO2 history and for each dependent variable
*  loop one way (kruskal wallis non param) and beta reg (survival data) \\
```{r stats}

# for loop d
Dates  <- as.data.frame(list(unique(paste(data_filt$Date))))

# for loop i
pCO2history_treatments  <- as.data.frame(list(unique(paste(data_filt$pCO2_history))))

# for loop m
FlowCy_probes           <- as.data.frame(list(c('SYBR_PI_prop_alive_ADJ',
                                                'SYBR_PI_prop_dead_ADJ',
                                                'MitoSoxGreen_Mean_FL1',
                                                'JC10_FL2_FL1_Ratio')))

# prepare data for analysis
data2 <- data_filt %>% 
  dplyr::select(c("Date","pCO2_history","pCO2_exposure",
                  "SYBR_PI_prop_alive_ADJ","SYBR_PI_prop_dead_ADJ",
                  "MitoSoxGreen_Mean_FL1", "JC10_FL2_FL1_Ratio")) 

# Call the cumulative dataframe that we will write to in the for loop below
df_total              <- data.frame() # start dataframe 
stats.table           <- data.frame(matrix(nrow = 1, ncol = 10)) # create dataframe to save cumunalitively during for loop
colnames(stats.table) <- c('Date', 
                          'pCO2_history',
                          'FlowCyProbe', 
                          'Test', 
                          'Shapiro', 
                          'Levenes',
                          'DF',
                          'Fvalue',
                          'chisquared',
                          'Pvalue') # names for comuns in the for loop


# RUN TE FOR LOOP!

for (d in 1:nrow(Dates)) {
  
  data_by_date <- data2 %>% 
        dplyr::filter(Date %in% Dates[d,1])
  
  for (i in 1:nrow(pCO2history_treatments)) {
    
    # filter the dataset 
    data_by_history <- data_by_date %>% 
      dplyr::filter(pCO2_history %in% pCO2history_treatments[i,1]) 
      #dplyr::filter(pCO2_exposure %in% gsub('.* ', '', treatments[i,1])) 
    
      for (m in 1:nrow(FlowCy_probes)) {
        
        # if loop for probe type-speicif testing based on the naure of the data..
        
        if (substr(FlowCy_probes[m,],1,4) == 'SYBR') { # if proportion data (0-1) we want to run beta regression models
          
        colNum   <- which( colnames(data_by_history)==FlowCy_probes[m,])
        data_by_history[,colNum] = as.numeric(data_by_history[,colNum])
        modBetaReg     <- betareg(data_by_history[,colNum]~pCO2_exposure, data = data_by_history) # beta reg model suitable for prop data
        modSUMMARY     <- joint_tests(modBetaReg) # use 'emmeans' pavkage for an anova-like table
        modSUMMARYDF   <- signif(modSUMMARY[["df1"]][1], 2) # cal p value for anova table - 2 sig figs
        modSUMMARYFval <- signif(modSUMMARY[["F.ratio"]][1], 4) # cal p value for anova table - 2 sig figs
        modSUMMARYchi  <- NA  
        modSUMMARYPval <- signif(modSUMMARY[["p.value"]][1], 4) # cal p value for anova table - 2 sig figs
        testRun        <- "Beta regression model"        
        
        shapTEST       <- 'NA' # proportion data between 0-1 is non parametric
        levTEST        <- as.data.frame('NA','NA') # proportion data between 0-1 is non parametric, need to make table for if/else below
        
        } else { # for the continuous data run ANOVA or Kruskal Wallis for norm/non-param. models
          
        colNum   <- which( colnames(data_by_history)==FlowCy_probes[m,])
        data_by_history[,colNum] = as.numeric(data_by_history[,colNum])
        modAOV   <- aov(lm(data_by_history[,colNum]~pCO2_exposure, data = data_by_history))
        shapTEST <- shapiro.test(resid(modAOV))
        levTEST  <- leveneTest(modAOV)
        
            # within continuous data.. run either ANOVA or Kruskal Wallis based on normality testing..
            if(shapTEST$p.value> 0.05 & levTEST$`Pr(>F)`[1] > 0.05) { # if normal - run anova
              
              modSUMMARY     <- summary(modAOV) # create anova table summary
              modSUMMARYDF   <- signif(modSUMMARY[[1]][["Df"]][1], 2) # cal p value for anova table - 2 sig figs
              modSUMMARYFval <- signif(modSUMMARY[[1]][["F value"]][1], 4) # cal p value for anova table - 2 sig figs
              modSUMMARYchi  <- NA  
              modSUMMARYPval <- signif(modSUMMARY[[1]][["Pr(>F)"]][1], 4) # cal p value for anova table - 2 sig figs
              testRun        <- "One-way ANOVA"
              
            } else { # if non-normal (either shapiro OR levenes defied) - run the Kruskal Wallis
              
              modSUMMARY     <- kruskal.test(data_by_history[,colNum] ~ pCO2_exposure, data = data_by_history) 
              modSUMMARYDF   <- signif(modSUMMARY[[2]], 2) # cal p value for Kruskal wallis test table - 2 sig figs
              modSUMMARYFval <- NA
              modSUMMARYchi  <- signif(modSUMMARY[[1]], 4) # cal p value for Kruskal wallis test table - 2 sig figs
              modSUMMARYPval <- signif(modSUMMARY[[3]], 4) # cal p value for Kruskal wallis test table - 2 sig figs
              testRun        <- "Kruskal Wallis"
              
            } # end of if loop WITHIN the 'else' for probe type-specif testing
        } # close the if else loop for probe type-specific testing (we are still in the the 'm' for loop!)
        stats.table$Date          <- data_by_history$Date[1]
        stats.table$pCO2_history  <- pCO2history_treatments[i,]
        stats.table$FlowCyProbe   <- FlowCy_probes[m,]
        stats.table$Test          <- testRun
        if (shapTEST[1] == 'NA') {
          stats.table$Shapiro = 'NA'} else {stats.table$Shapiro <- shapTEST$p.value}
        if (levTEST[1,1] == 'NA') {
          stats.table$Levenes = 'NA'} else {stats.table$Levenes <- levTEST$`Pr(>F)`[1]}
        stats.table$DF            <- modSUMMARYDF
        stats.table$Fvalue        <- modSUMMARYFval
        stats.table$chisquared    <- modSUMMARYchi
        stats.table$Pvalue        <- modSUMMARYPval
        
        df       <- data.frame(stats.table) # name dataframe for this single row
        df_total <- rbind(df_total,df) #bind to a cumulative list dataframe
        print(df_total) # print to monitor progress      
        
          } # close 'm' for loop - through each flow cy probe
    
    } # close 'i' for loop - through each pCO2 history (low, moderate, severe)
  
} # close 'd' for loop - through each sampling data (5/2/2023 and 5/16/2023)

View(df_total %>% dplyr::arrange(Pvalue))
df_total

df_total %>% dplyr::filter(!Pvalue > 0.1) 

  low <- data_filt %>% 
     dplyr::filter(Date %in% 20230516) %>% 
     dplyr::filter(pCO2_history %in% 'low') 

modBetaReg     <- betareg(SYBR_PI_prop_dead_ADJ~pCO2_exposure, data = low) # beta reg model suitable for prop data
joint_tests(modBetaReg) # use 'emmeans' pavkage for an anova-like table
summary(modBetaReg)
lrtest(modBetaReg)    
Anova(modBetaReg)
  # summary(aov(lm(SYBR_PI_count_dead~pCO2_`exposure,data=low)))
```

```{r analysis live dead}
library(multcomp)

# FOLLOWING YUAN'S PERMANOVA ANALYSIS (12/1/23) 
# found :
# (1) low and moderate history responds differently to high pCO2 exposure
# (2) low and moderate history responds differently to moderate pCO2 exposure
# (3) low and high history responds differently to moderate pCO2 exposure
# (4) moderate and high history responds differently to moderate pCO2 exposure

# BUT WHAT DEPENDENT VARIBALES ARE AT PLAY HERE? 
Day14_HighExp <- Day14_datafilt %>% dplyr::filter(pCO2_exposure %in% 'severe')
Day14_ModExp <- Day14_datafilt %>% dplyr::filter(pCO2_exposure %in% 'moderate')



# (1) low and moderate history responds differently to high pCO2 exposure
# diff in mit ROS 


Day14_HighExp_LowModHist <- Day14_HighExp %>% dplyr::filter(pCO2_history %in% c('low', 'moderate'))
# * prop live hemocytes
anova_1_Alive <- lm(SYBR_PI_prop_alive_ADJ ~ pCO2_history, data = Day14_HighExp_LowModHist)
shapiro.test(resid(anova_1_Alive)) # 0.1698 - norm
leveneTest(anova_1_Alive) # 0.5608 - homogeneity of variance
summary(aov(anova_1_Alive))
#              Df  Sum Sq Mean Sq F value Pr(>F)
# pCO2_history  1 0.02229 0.02229   1.341   0.28
# Residuals     8 0.13297 0.01662

anova_1_mtROS <- lm(MitoSoxGreen_Mean_FL1 ~ pCO2_history, data = Day14_HighExp_LowModHist)
shapiro.test(resid(anova_1_mtROS)) # 0.1732 - norm
leveneTest(anova_1_mtROS) # 0.7832 - homogeneity of variance
summary(aov(anova_1_mtROS))
#              Df  Sum Sq Mean Sq F value Pr(>F)  
# pCO2_history  1 2115917 2115917   7.067 0.0289 *
# Residuals     8 2395127  299391

anova_1_mtPot <- lm(JC10_FL2_FL1_Ratio ~ pCO2_history, data = Day14_HighExp_LowModHist)
shapiro.test(resid(anova_1_mtPot)) # 0.5571 - norm
leveneTest(anova_1_mtPot) # 0.278 - homogeneity of variance
summary(aov(anova_1_mtPot))
#              Df  Sum Sq  Mean Sq F value Pr(>F)
# pCO2_history  1 0.02394 0.023943   2.703  0.144
# Residuals     7 0.06200 0.008858     



# (2) low and moderate history responds differently to moderate pCO2 exposure
# diff in mit mem pot an d% alive hemocytes                 

Day14_ModExp_LowModHist <- Day14_ModExp %>% dplyr::filter(pCO2_history %in% c('low', 'moderate'))
# * prop live hemocytes
anova_2_Alive <- lm(SYBR_PI_prop_alive_ADJ ~ pCO2_history, data = Day14_ModExp_LowModHist)
shapiro.test(resid(anova_2_Alive)) # 0.5932 - norm
leveneTest(anova_2_Alive) # 0.2222 - homogeneity of variance
summary(aov(anova_2_Alive))
#              Df  Sum Sq Mean Sq F value Pr(>F)  
# pCO2_history  1 0.06438 0.06438   5.341 0.0496 *
# Residuals     8 0.09643 0.01205

anova_2_mtROS <- lm(MitoSoxGreen_Mean_FL1 ~ pCO2_history, data = Day14_ModExp_LowModHist)
shapiro.test(resid(anova_2_mtROS)) # 0.2455 - norm
leveneTest(anova_2_mtROS) # 0.7164 - homogeneity of variance
summary(aov(anova_2_mtROS))
#              Df  Sum Sq Mean Sq F value Pr(>F)
# pCO2_history  1  559171  559171   3.251  0.109
# Residuals     8 1375829  171979 

anova_2_mtPot <- lm(JC10_FL2_FL1_Ratio ~ pCO2_history, data = Day14_ModExp_LowModHist)
shapiro.test(resid(anova_2_mtPot)) # 0.5273 - norm
leveneTest(anova_2_mtPot) # 0.1648 - homogeneity of variance
summary(aov(anova_2_mtPot))
#              Df Sum Sq Mean Sq F value Pr(>F)  
# pCO2_history  1 0.1333 0.13328   8.179 0.0212 *
# Residuals     8 0.1304 0.01629   





# (3) low and high history responds differently to moderate pCO2 exposure
# different in ROS, marginal in mit mem potential                   

Day14_ModExp_LowSevHist <- Day14_ModExp %>% dplyr::filter(pCO2_history %in% c('low', 'severe'))
# * prop live hemocytes
anova_3_Alive <- lm(SYBR_PI_prop_alive_ADJ ~ pCO2_history, data = Day14_ModExp_LowSevHist)
shapiro.test(resid(anova_3_Alive)) # 0.459 - norm
leveneTest(anova_3_Alive) # 0.3987 - homogeneity of variance
summary(aov(anova_3_Alive))
#              Df  Sum Sq Mean Sq F value Pr(>F)
# pCO2_history  1 0.01727 0.01727   1.217  0.302
# Residuals     8 0.11353 0.01419 

anova_3_mtROS <- lm(MitoSoxGreen_Mean_FL1 ~ pCO2_history, data = Day14_ModExp_LowSevHist)
shapiro.test(resid(anova_3_mtROS)) # 0.593 - norm
leveneTest(anova_3_mtROS) # 0.2678 - homogeneity of variance
summary(aov(anova_3_mtROS))
#              Df  Sum Sq Mean Sq F value  Pr(>F)   
# pCO2_history  1 9531910 9531910   23.21 0.00132 **
# Residuals     8 3284714  410589 

anova_3_mtPot <- lm(JC10_FL2_FL1_Ratio ~ pCO2_history, data = Day14_ModExp_LowSevHist)
shapiro.test(resid(anova_3_mtPot)) # 0.1105 - norm
leveneTest(anova_3_mtPot) # 0.9437 - homogeneity of variance
summary(aov(anova_3_mtPot))
#              Df Sum Sq Mean Sq F value Pr(>F)  
# pCO2_history  1 0.1616 0.16159   5.142 0.0531 .
# Residuals     8 0.2514 0.03142    




# (4) moderate and high history responds differently to moderate pCO2 exposure
# different in mt ROS                    

Day14_ModExp_ModSevHist <- Day14_ModExp %>% dplyr::filter(pCO2_history %in% c('moderate', 'severe'))
# * prop live hemocytes
anova_4_Alive <- lm(SYBR_PI_prop_alive_ADJ ~ pCO2_history, data = Day14_ModExp_ModSevHist)
shapiro.test(resid(anova_4_Alive)) # 0.4546 - norm
leveneTest(anova_4_Alive) # 0.7012 - homogeneity of variance
summary(aov(anova_4_Alive))
#              Df  Sum Sq  Mean Sq F value Pr(>F)
# pCO2_history  1 0.01496 0.014957   2.459  0.156
# Residuals     8 0.04867 0.006083 

anova_4_mtROS <- lm(MitoSoxGreen_Mean_FL1 ~ pCO2_history, data = Day14_ModExp_ModSevHist)
shapiro.test(resid(anova_4_mtROS)) # 0.7522 - norm
leveneTest(anova_4_mtROS) # 0.1419 - homogeneity of variance
summary(aov(anova_4_mtROS))
#              Df  Sum Sq Mean Sq F value  Pr(>F)   
# pCO2_history  1 5473736 5473736   15.08 0.00465 **
# Residuals     8 2903018  362877  

anova_4_mtPot <- lm(JC10_FL2_FL1_Ratio ~ pCO2_history, data = Day14_ModExp_ModSevHist)
shapiro.test(resid(anova_4_mtPot)) # 0.06972 - norm
leveneTest(anova_4_mtPot) # 0.445 - homogeneity of variance
summary(aov(anova_4_mtPot))
#              Df  Sum Sq  Mean Sq F value Pr(>F)
# pCO2_history  1 0.00136 0.001362    0.06  0.813
# Residuals     8 0.18273 0.022841    













   
# 24 HOUR DATA - history x exposure tests

# live cells proportion
Day1_PropLive_betareg <- betareg(SYBR_PI_prop_alive_ADJ ~ pCO2_history*pCO2_exposure, data=Day1_datafilt)
lrtest(Day1_PropLive_betareg) #  using lrtests from the 'lmtests' package
joint_tests(Day1_PropLive_betareg) # using joint_tests from 'emmeans' package
# model term                 df1 df2 F.ratio p.value
#  pCO2_history                 2 Inf   1.354  0.2582
#  pCO2_exposure                2 Inf   0.680  0.5066
#  pCO2_history:pCO2_exposure   4 Inf   2.198  0.0665
Anova(Day1_PropLive_betareg) # using Anova fro 'car' package
# Response: SYBR_PI_prop_alive_ADJ
#                            Df  Chisq Pr(>Chisq)  
# pCO2_history                2 2.3096    0.31511  
# pCO2_exposure               2 1.3562    0.50757  
# pCO2_history:pCO2_exposure  4 8.0755    0.08885 .






# dead cells proportion - notice results are the exact same becasue values are dependent on one another (i..e 75% for A_alive is 25% for A_dead)
Day1_PropDead_betareg <- betareg(SYBR_PI_prop_dead_ADJ ~ pCO2_history*pCO2_exposure, data=Day1_datafilt)
lrtest(Day1_PropDead_betareg) #  using lrtests from the 'lmtests' package
joint_tests(Day1_PropDead_betareg) # using joint_tests from 'emmeans' package
# model term                 df1 df2 F.ratio p.value
#  pCO2_history                 2 Inf   1.354  0.2582
#  pCO2_exposure                2 Inf   0.680  0.5066
#  pCO2_history:pCO2_exposure   4 Inf   2.198  0.0665
summary(emmeans(Day1_PropDead_betareg, pairwise ~ pCO2_history|pCO2_exposure))
# under severe exposure, low history have higher survival than severe and moderate history




# follow up on a one way anova effect - severe was significat

Day1_PropLive_Severe     <- Day1_datafilt %>% dplyr::filter(pCO2_history %in% 'severe')
Day1_PropLive_Severe_mod <- betareg(SYBR_PI_prop_alive_ADJ~pCO2_exposure,data=Day1_PropLive_Severe)
joint_tests(Day1_PropLive_Severe_mod)
# model term    df1 df2 F.ratio p.value
#  pCO2_exposure   2 Inf   4.522  0.0109
Day1_PropLive_Severe_modMEANS <- emmeans::emmeans(object = Day1_PropLive_Severe_mod,
                                    pairwise ~ "pCO2_exposure",
                                    adjust = "tukey")
multcomp::cld(object = Day1_PropLive_Severe_modMEANS$emmeans,Letters = letters)
#  pCO2_exposure emmean     SE  df asymp.LCL asymp.UCL .group
#  severe         0.630 0.0370 Inf     0.557     0.702  a    
#  low            0.723 0.0382 Inf     0.648     0.797  ab   
#  moderate       0.776 0.0317 Inf     0.713     0.838   b






# 14 DAY EXPOSURE DATA  - history x exposure tests




# live cells proportion
Day14_PropLive_betareg <- betareg(SYBR_PI_prop_alive_ADJ ~ pCO2_history*pCO2_exposure, data=Day14_datafilt)
lrtest(Day14_PropLive_betareg) #  using lrtests from the 'lmtests' package
joint_tests(Day14_PropLive_betareg) # using joint_tests from 'emmeans' package
 # model term                 df1 df2 F.ratio Chisq p.value
 # pCO2_history                 2 Inf   3.338 6.676  0.0355
 # pCO2_exposure                2 Inf   3.302 6.604  0.0368
 # pCO2_history:pCO2_exposure   4 Inf   2.225 8.900  0.0637
summary(emmeans(Day14_PropLive_betareg, pairwise ~ pCO2_history))
# low has significantly lower survival than moderate regardless of subseqent exposure
history_means_contr <- emmeans::emmeans(object = Day14_PropLive_betareg,
                                    pairwise ~ "pCO2_history",
                                    adjust = "tukey")
history_means <- multcomp::cld(object = history_means_contr$emmeans,
                           Letters = letters)
history_means
# pCO2_history emmean     SE  df asymp.LCL asymp.UCL .group
#  low           0.774 0.0227 Inf     0.730     0.819  a    
#  severe        0.830 0.0203 Inf     0.790     0.869  ab   
#  moderate      0.856 0.0188 Inf     0.819     0.893   b

exposure_means_contr <- emmeans::emmeans(object = Day14_PropLive_betareg,
                                    pairwise ~ "pCO2_exposure",
                                    adjust = "tukey")
exposure_means <- multcomp::cld(object = exposure_means_contr$emmeans,
                           Letters = letters)
exposure_means
# pCO2_exposure emmean     SE  df asymp.LCL asymp.UCL .group
# moderate       0.785 0.0211 Inf     0.744     0.826  a    
# severe         0.835 0.0189 Inf     0.798     0.873  ab   
# low            0.855 0.0186 Inf     0.819     0.892   b



# HISTORIES!!!

# follow up on a one way anova effect - low and severe history had significant exposure diffs
#low pCO2
Day14_PropLive_Low     <- Day14_datafilt %>% dplyr::filter(pCO2_history %in% 'low')
Day14_PropLive_Low_mod <- betareg(SYBR_PI_prop_alive_ADJ~pCO2_exposure,data=Day14_PropLive_Low)
shapiro.test(resid(Day14_PropLive_Low_mod)) # 0.5921
joint_tests(Day14_PropLive_Low_mod)
 # model term    df1 df2 F.ratio Chisq p.value
 # pCO2_exposure   2 Inf   3.538 7.076  0.0291
Day14_PropLive_Low_modMEANS <- emmeans::emmeans(object = Day14_PropLive_Low_mod,
                                    pairwise ~ "pCO2_exposure",
                                    adjust = "tukey")
multcomp::cld(object = Day14_PropLive_Low_modMEANS$emmeans,Letters = letters)
# pCO2_exposure emmean     SE  df asymp.LCL asymp.UCL .group
#  moderate       0.706 0.0502 Inf     0.607     0.804  a    
#  severe         0.767 0.0462 Inf     0.677     0.858  ab   
#  low            0.868 0.0397 Inf     0.790     0.946   b 



#moderate pCO2
Day14_PropLive_Moderate     <- Day14_datafilt %>% dplyr::filter(pCO2_history %in% 'moderate')
Day14_PropLive_Moderate_mod <- betareg(SYBR_PI_prop_alive_ADJ~pCO2_exposure,data=Day14_PropLive_Moderate)
shapiro.test(resid(Day14_PropLive_Moderate_mod)) # 0.7294
joint_tests(Day14_PropLive_Moderate_mod)
 # model term    df1 df2 F.ratio Chisq p.value
 # pCO2_exposure   2 Inf   0.280  0.56  0.7557


#severe pCO2
Day14_PropLive_Severe     <- Day14_datafilt %>% dplyr::filter(pCO2_history %in% 'severe')
Day14_PropLive_Severe_mod <- betareg(SYBR_PI_prop_alive_ADJ~pCO2_exposure,data=Day14_PropLive_Severe)
shapiro.test(resid(Day14_PropLive_Severe_mod)) # 0.5218
joint_tests(Day14_PropLive_Severe_mod)
# model term    df1 df2 F.ratio p.value
#  pCO2_exposure   2 Inf   3.149  0.0429
Day14_PropLive_Severe_modMEANS <- emmeans::emmeans(object = Day14_PropLive_Severe_mod,
                                    pairwise ~ "pCO2_exposure",
                                    adjust = "tukey")
multcomp::cld(object = Day14_PropLive_Severe_modMEANS$emmeans,Letters = letters)
# pCO2_exposure emmean     SE  df asymp.LCL asymp.UCL .group
#  moderate       0.793 0.0242 Inf     0.746     0.841  a    
#  low            0.858 0.0208 Inf     0.817     0.898  ab   
#  severe         0.868 0.0201 Inf     0.828     0.907   b 
  


# EXPOSURES!!! 


# follow up on a one way anova effect - moderate expose had a significant history diff!
#low pCO2
Day14_PropLive_LowExp     <- Day14_datafilt %>% dplyr::filter(pCO2_exposure %in% 'low')
Day14_PropLive_LowExp_mod <- betareg(SYBR_PI_prop_alive_ADJ~pCO2_history,data=Day14_PropLive_LowExp)
shapiro.test(resid(Day14_PropLive_LowExp_mod)) # 0.8564
joint_tests(Day14_PropLive_LowExp_mod)
 # model term   df1 df2 F.ratio Chisq p.value
 # pCO2_history   2 Inf   1.334 2.668  0.2634


#moderate pCO2
Day14_PropLive_ModerateExp     <- Day14_datafilt %>% dplyr::filter(pCO2_exposure %in% 'moderate')
Day14_PropLive_ModerateExp_mod <- betareg(SYBR_PI_prop_alive_ADJ~pCO2_history,data=Day14_PropLive_ModerateExp)
shapiro.test(resid(Day14_PropLive_ModerateExp_mod)) # 0.6031
joint_tests(Day14_PropLive_ModerateExp_mod)
 # model term   df1 df2 F.ratio Chisq p.value
 # pCO2_history   2 Inf   3.969 7.938  0.0189
Day14_PropLive_ModExp_modMEANS <- emmeans::emmeans(object = Day14_PropLive_Moderateexp_mod,
                                    pairwise ~ "pCO2_history",
                                    adjust = "tukey")
multcomp::cld(object = Day14_PropLive_ModExp_modMEANS$emmeans,Letters = letters)
 # pCO2_history emmean     SE  df asymp.LCL asymp.UCL .group
 # low           0.710 0.0427 Inf     0.626     0.794  a    
 # severe        0.785 0.0383 Inf     0.710     0.860  ab   
 # moderate      0.857 0.0320 Inf     0.794     0.920   b 

#severe pCO2
Day14_PropLive_SevereExp     <- Day14_datafilt %>% dplyr::filter(pCO2_exposure %in% 'severe')
Day14_PropLive_SevereExp_mod <- betareg(SYBR_PI_prop_alive_ADJ~pCO2_history,data=Day14_PropLive_SevereExp)
shapiro.test(resid(Day14_PropLive_SevereExp_mod)) # 0.5151
joint_tests(Day14_PropLive_SevereExp_mod)
 # model term   df1 df2 F.ratio Chisq p.value
 # pCO2_history   2 Inf   1.505  3.01  0.2221







```

```{r analysis Mitochondrial ROS}



# 24 HOUR DATA - history x exposure tests



Day1_MitoSox_AOV <- aov(lm(MitoSoxGreen_Mean_FL1 ~ pCO2_history*pCO2_exposure, data=Day1_datafilt))
shapiro.test(resid(Day1_MitoSox_AOV)) # normal 0.4232
leveneTest(Day1_MitoSox_AOV) # 0.6705 PASS variance test
summary(Day1_MitoSox_AOV)
#                            Df Sum Sq Mean Sq F value Pr(>F)
# pCO2_history                2   71.2   35.59   0.683  0.512
# pCO2_exposure               2   63.6   31.79   0.610  0.549
# pCO2_history:pCO2_exposure  4  224.3   56.08   1.076  0.383
# Residuals                  36 1876.7   52.13



# 14 DAY EXPOSURE DATA  - history x exposure tests



Day14_MitoSox_AOV <- aov(lm(MitoSoxGreen_Mean_FL1 ~ pCO2_history*pCO2_exposure, data=Day14_datafilt))
shapiro.test(resid(Day14_MitoSox_AOV)) # normal 0.6608
leveneTest(Day14_MitoSox_AOV) # 0.2396 PASS variance test
summary(Day14_MitoSox_AOV)
#                             Df   Sum Sq Mean Sq F value   Pr(>F)    
# pCO2_history                2 11336397 5668198  11.232 0.000162 ***
# pCO2_exposure               2  6723335 3361668   6.661 0.003456 ** 
# pCO2_history:pCO2_exposure  4  3810366  952591   1.888 0.133824  
TukeyHSD(Day14_MitoSox_AOV)


# lets get them letters
mod_means_contr <- emmeans::emmeans(object = Day14_MitoSox_AOV,
                                    pairwise ~ "pCO2_exposure",
                                    adjust = "tukey")
mod_means <- multcomp::cld(object = mod_means_contr$emmeans,
                           Letters = letters)
 # pCO2_history emmean  SE df lower.CL upper.CL .group
 # low            4023 183 36     3651     4395  a    
 # moderate       4603 183 36     4231     4975  a    
 # severe         5252 183 36     4880     5624   b 

 # pCO2_exposure emmean  SE df lower.CL upper.CL .group
 # moderate        4085 183 36     3713     4457  a    
 # low             4823 183 36     4451     5195   b   
 # severe          4968 183 36     4596     5340   b 


mod_means_contr <- emmeans::emmeans(object = Day14_MitoSox_AOV,
                                    pairwise ~ "pCO2_history:pCO2_exposure",
                                    adjust = "tukey")
mod_means <- multcomp::cld(object = mod_means_contr$emmeans,
                           Letters = letters)
 # pCO2_history pCO2_exposure emmean  SE df lower.CL upper.CL .group
 # low          moderate        3277 291 35     2686     3868  a    
 # moderate     moderate        3750 291 35     3159     4341  ab   
 # low          severe          4400 291 35     3809     4990  abc  
 # moderate     low             4739 291 35     4148     5330   bc  
 # low          low             4801 325 35     4141     5462   bc  
 # severe       severe          5185 291 35     4595     5776    c  
 # severe       moderate        5230 291 35     4639     5820    c  
 # moderate     severe          5319 291 35     4729     5910    c  
 # severe       low             5340 291 35     4749     5930    c 

mitosoxDay14 <- data_filt %>% # data %>%
  # edit data to suit out needs
  dplyr::filter(Date %in% 20230516) %>% # filter for desired date of rhte experiment
  dplyr::select(c('Date','Scallop_ID','pCO2_exposure','pCO2_history','MitoSoxGreen_Mean_FL1')) %>% 
  na.omit() %>%
  dplyr::filter(pCO2_history %in% 'low') %>% 
  dplyr::filter(!Scallop_ID %in% 5)


Day14_MitoSox_AOV_LOW <- aov(lm(MitoSoxGreen_Mean_FL1 ~ pCO2_exposure, data=mitosoxDay14))
shapiro.test(resid(Day14_MitoSox_AOV_LOW)) # normal 0.792
leveneTest(Day14_MitoSox_AOV_LOW) # 0.04912 * PASS variance test
qqnorm(resid(Day14_MitoSox_AOV_LOW))
TukeyHSD(Day14_MitoSox_AOV_LOW)
Day14_MitoSox_KW_LOW <- kruskal.test(MitoSoxGreen_Mean_FL1 ~ pCO2_exposure, data=mitosoxDay14)
Day14_MitoSox_KW_LOW # p-value = 0.03175
# Kruskal-Wallis chi-squared = 6.9, df = 2, p-value = 0.03175
Day14_SRH_Dunns <- dunnTest(MitoSoxGreen_Mean_FL1 ~ pCO2_exposure,
              data=mitosoxDay14,
              method="bh")      # Adjusts p-values for multiple comparisons;
Day14_SRH_Dunns
# low - moderate	2.3697163	0.01780174	0.05340521	
# low - severe	0.3741657	0.70828101	0.70828101	
# moderate - severe	-2.1166010	0.03429372	0.05144058
```

```{r analysis Mitochondrial membrane potential}

# 24 HOUR DATA - history x exposure tests


Day1_MitoMemPot_AOV <- aov(lm(JC10_FL2_FL1_Ratio ~ pCO2_history*pCO2_exposure, data=Day1_datafilt))
shapiro.test(resid(Day1_MitoMemPot_AOV)) #  normal 0.1992
leveneTest(Day1_MitoMemPot_AOV) # 0.7438 PASS variance test
summary(Day1_MitoMemPot_AOV)
#                             Df Sum Sq Mean Sq F value Pr(>F)  
# pCO2_history                2   4126  2062.8   2.841 0.0736 .
# pCO2_exposure               2    677   338.4   0.466 0.6318  
# pCO2_history:pCO2_exposure  4   1404   351.1   0.484 0.7476  
# Residuals                  31  22507   726.0 
TukeyHSD(Day1_MitoMemPot_AOV)
# $pCO2_history
#                      diff        lwr      upr     p adj
# moderate-low    24.221604  -1.321011 49.76422 0.0658178
# severe-low      16.972800  -9.038526 42.98413 0.2582674
# severe-moderate -7.248805 -32.791420 18.29381 0.7661487


Day1_MitoMemPot_SRH <- scheirerRayHare(JC10_FL2_FL1_Ratio ~ pCO2_history*pCO2_exposure, data=Day1_datafilt)
Day1_MitoMemPot_SRH
#                             Df Sum Sq      H p.value
# pCO2_history                2  972.9 7.1187 0.02846
# pCO2_exposure               2  245.0 1.7926 0.40808
# pCO2_history:pCO2_exposure  4  229.7 1.6804 0.79427
# Residuals                  31 3958.9
Day1_SRH_Dunns <- dunnTest(JC10_FL2_FL1_Ratio ~ pCO2_history,
              data=Day1_datafilt,
              method="bh")      # Adjusts p-values for multiple comparisons;
                                # See ?dunnTest for options
Day1_SRH_Dunns
# low - moderate	-2.572622	0.01009314	0.03027941	
# low - severe	-1.395620	0.16282904	0.24424356	
# moderate - severe	1.132258	0.25752615	0.25752615	












# 14 DAY EXPOSURE DATA  - history x exposure tests




Day14_MitoMemPot_AOV <- aov(lm(JC10_FL2_FL1_Ratio ~ pCO2_history*pCO2_exposure, data=Day14_datafilt))
shapiro.test(resid(Day14_MitoMemPot_AOV)) #  non-normal 0.0006415
leveneTest(Day14_MitoMemPot_AOV) # 0.6969 PASS variance test
Day14_MitoMemPot_SRH <- scheirerRayHare(JC10_FL2_FL1_Ratio ~ pCO2_history*pCO2_exposure, data=Day14_datafilt)
Day14_MitoMemPot_SRH
#                             Df Sum Sq      H  p.value
# pCO2_history                2  588.0 3.7297 0.154920
# pCO2_exposure               2  963.8 6.1131 0.047051 * significant!
# pCO2_history:pCO2_exposure  4  975.4 6.1868 0.185627
# Residuals                  34 4070.8
Day14_SRH_Dunns <- dunnTest(JC10_FL2_FL1_Ratio ~ pCO2_exposure,
              data=Day14_datafilt,
              method="bh")      # Adjusts p-values for multiple comparisons;
                                # See ?dunnTest for options
Day14_SRH_Dunns
# low - moderate    	-2.355507	0.01849744	0.05549231	
# low - severe      	-1.876431	0.06059618	0.09089426	
# moderate - severe	   0.393393	0.69402926	0.69402926


# follow up on a one way anova effect - severe was significat
Day14_MitoPot_Low <- Day14_datafilt %>% filter(pCO2_history %in% 'low')
Day14_MitoPot_Low_mod <- kruskal.test(JC10_FL2_FL1_Ratio~pCO2_exposure,data=Day14_MitoPot_Low) # we know its non normal
# Kruskal-Wallis chi-squared = 8.88, df = 2, p-value = 0.0118
Day14_KW_low_Dunns <- dunnTest(JC10_FL2_FL1_Ratio ~ pCO2_exposure,
              data=Day14_MitoPot_Low,
              method="bh")      # Adjusts p-values for multiple comparisons;
                                # See ?dunnTest for options
Day14_KW_low_Dunns
# low - moderate	-2.969848	0.002979467	0.0089384	***
# low - severe	-1.697056	0.089686022	0.1345290	
# moderate - severe	1.272792	0.203091788	0.2030918	
```
