---
title: "PCA_All_Phys"
author: "Samuel Gurr"
date: "2023-08-28"
output: html_notebook
---

-   Last updates: September 13, 2023

# OA Reexposure Challenge

### May 2023: F2 Adult Bay scallops exposed to a two-week full-reciprocal pCO2 challenge

### Objective: synthesize the hemolymph flow cytometry and gill tissue lysate data 
at the individual-level resolution for principle component analysis 

## Load Libraries

```{r setup, include=TRUE}

# plotting and data edit 
library(ggplot2)
library(dplyr)
library(tidyverse)
library(car)
library(tidyr)
library(ggpubr)
# PCA 
library(corrr) # correlation analysis
library(ggcorrplot)
library(FactoMineR)
library(factoextra)
knitr::opts_knit$set(root.dir = "C:/Users/samjg/Documents/Github_repositories/Airradians_CellularMolecular_OA/RAnalysis") # sets the working directory for the entire R markdown file - no need to reload the wd
```

## Load data

```{r load ATP assay data}

# contains ATP and total protein in gill tissue 
ATP_master      <- read.csv(file="Output/Colorimetric_assays/ATP/ATP_Master.csv",
                          sep = ",",
                          header=TRUE) %>% dplyr::select(-X)
nrow(ATP_master) # 65 - remember quite a few samples lost at the bottom of the dewar for D14!

# contains cell vabilty, mitochondrial mem pot, & mtROS in live hemolymph
Flowcy_master <- read.csv(file = "Data/FlowCytometry/Hemolymph_data_filtered.csv",
                          sep = ",",
                          header=TRUE) %>% dplyr::select(-X)
nrow(Flowcy_master) # 90 - all samples, full dataset!

Merge_master <- merge(ATP_master,Flowcy_master)
nrow(Merge_master) # 65 - limited by the ATP dataset for reasons mentioned.. 

Merge_master_OM <- Merge_master %>% na.omit()
nrow(Merge_master_OM) # 58 - 7 rows ommitted
```


```{r call numerical data}
colnames(Merge_master)
# mean_TotalProtein_ug - col num = 6
# ATP_nmol_ng_protein - col num = 8
# MitoSoxGreen_Mean_FL1 - col num = 13
# JC10_FL2_FL1_Ratio - col num = 18
# SYBR_PI_prop_dead_ADJ - col num = 20

# day 1 ------------------------------------------------------------------------------------------------ #
Merge_master_OM_D1    <- Merge_master_OM[,as.numeric(c(1,2,3,8,13,18,19))] %>% # call columns , column 1 is Day, 
                           dplyr::filter(Day %in% 1)

numerical_data_D1     <- Merge_master_OM_D1 %>% # call columns , column 1 is Day, 
                           dplyr::select(-c(Day,pCO2_history, pCO2_exposure)) #omit columns
head(numerical_data_D1) # lets see it
nrow(numerical_data_D1) # 40 

numerical_data_D1_LOW <- Merge_master_OM_D1 %>% # call columns , column 1 is Day, 
                          dplyr::filter(pCO2_history == "low") %>% # filter by exposure 
                           dplyr::select(-c(Day,pCO2_history, pCO2_exposure)) #omit columns
numerical_data_D1_MOD <- Merge_master_OM_D1 %>% # call columns , column 1 is Day, 
                          dplyr::filter(pCO2_history == "moderate") %>% # filter by exposure 
                           dplyr::select(-c(Day,pCO2_history, pCO2_exposure)) #omit columns
numerical_data_D1_SEV <- Merge_master_OM_D1 %>% # call columns , column 1 is Day, 
                          dplyr::filter(pCO2_history == "severe") %>% # filter by exposure 
                           dplyr::select(-c(Day,pCO2_history, pCO2_exposure)) #omit columns



# day 14 ------------------------------------------------------------------------------------------------ #
Merge_master_OM_D14    <- Merge_master_OM[,as.numeric(c(1,2,3,8,13,18,19))] %>% # call columns , column 1 is Day, 
                           dplyr::filter(Day %in% 14)

numerical_data_D14     <- Merge_master_OM_D14 %>% # call columns , column 1 is Day, 
                           dplyr::select(-c(Day,pCO2_history, pCO2_exposure)) #omit columns
head(numerical_data_D14) # lets see it
nrow(numerical_data_D14) # 18

numerical_data_D14_LOW <- Merge_master_OM_D14 %>% # call columns , column 1 is Day, 
                          dplyr::filter(pCO2_history == "low") %>% # filter by exposure 
                           dplyr::select(-c(Day,pCO2_history, pCO2_exposure)) #omit columns
numerical_data_D14_MOD <- Merge_master_OM_D14 %>% # call columns , column 1 is Day, 
                          dplyr::filter(pCO2_history == "moderate") %>% # filter by exposure 
                           dplyr::select(-c(Day,pCO2_history, pCO2_exposure)) #omit columns
numerical_data_D14_SEV <- Merge_master_OM_D14 %>% # call columns , column 1 is Day, 
                          dplyr::filter(pCO2_history == "severe") %>% # filter by exposure 
                           dplyr::select(-c(Day,pCO2_history, pCO2_exposure)) #omit columns

```

```{r normalize the numerical data}
# normalize the data 

# day 1 ------------------------------------------------------------------------------------------------ #

data_normalized_D1     <- scale(numerical_data_D1)
data_normalized_D1_LOW <- scale(numerical_data_D1_LOW)
data_normalized_D1_MOD <- scale(numerical_data_D1_MOD)
data_normalized_D1_SEV <- scale(numerical_data_D1_SEV)

# day 14 ------------------------------------------------------------------------------------------------ #


data_normalized_D14     <- scale(numerical_data_D14)
data_normalized_D14_LOW <- scale(numerical_data_D14_LOW)
data_normalized_D14_MOD <- scale(numerical_data_D14_MOD)
data_normalized_D14_SEV <- scale(numerical_data_D14_SEV)

```

```{r plot the normalized numerical data }

# day 1 ------------------------------------------------------------------------------------------------ #

corr_matrix_D1     <- cor(data_normalized_D1)
ggcorrplot(corr_matrix_D1)
corr_matrix_D1_LOW <- cor(data_normalized_D1_LOW)
ggcorrplot(corr_matrix_D1_LOW)
corr_matrix_D1_MOD <- cor(data_normalized_D1_MOD)
ggcorrplot(corr_matrix_D1_MOD)
corr_matrix_D1_SEV <- cor(data_normalized_D1_SEV)
ggcorrplot(corr_matrix_D1_SEV)


# day 14 ------------------------------------------------------------------------------------------------ #


corr_matrix_D14     <- cor(data_normalized_D14)
ggcorrplot(corr_matrix_D14)
corr_matrix_D14_LOW <- cor(data_normalized_D14_LOW)
ggcorrplot(corr_matrix_D14_LOW)
corr_matrix_D14_MOD <- cor(data_normalized_D14_MOD)
ggcorrplot(corr_matrix_D14_MOD)
corr_matrix_D14_SEV <- cor(data_normalized_D14_SEV)
ggcorrplot(corr_matrix_D14_SEV)

```

```{r pca}

# day 1 ------------------------------------------------------------------------------------------------ #

data.pca_D1 <- princomp(corr_matrix_D1)
summary(data.pca_D1)

# each component explains a percentage of the total variance 
# in the data - the Cumulative Proportion section first PC is 53%  of the total var 
# this implies that ~1/2 of the data in the set of 4 variables is represented by the first PC

# Importance of components:
#                           Comp.1    Comp.2    Comp.3       Comp.4
# Standard deviation     0.6692444 0.5207367 0.3277008 4.245472e-09
# Proportion of Variance 0.5419470 0.3281132 0.1299399 2.180918e-17
# Cumulative Proportion  0.5419470 0.8700601 1.0000000 1.000000e+00

data.pca_D1_LOW <- princomp(corr_matrix_D1_LOW)
summary(data.pca_D1_LOW)

# Importance of components:
#                           Comp.1    Comp.2     Comp.3 Comp.4
# Standard deviation     0.8549036 0.4295075 0.23929234      0
# Proportion of Variance 0.7514517 0.1896742 0.05887412      0
# Cumulative Proportion  0.7514517 0.9411259 1.00000000      1

data.pca_D1_MOD <- princomp(corr_matrix_D1_MOD)
summary(data.pca_D1_MOD)
# Importance of components:
#                           Comp.1    Comp.2     Comp.3      Comp.4
# Standard deviation     1.0267803 0.4128778 0.22752978 1.15159e-08
# Proportion of Variance 0.8259028 0.1335417 0.04055556 1.03889e-16
# Cumulative Proportion  0.8259028 0.9594444 1.00000000 1.00000e+00

data.pca_D1_HIGH <- princomp(corr_matrix_D1_SEV)
summary(data.pca_D1_HIGH)
# Importance of components:
#                           Comp.1    Comp.2    Comp.3       Comp.4
# Standard deviation     0.7241249 0.5290951 0.1789147 1.026366e-08
# Proportion of Variance 0.6269895 0.3347346 0.0382759 1.259614e-16
# Cumulative Proportion  0.6269895 0.9617241 1.0000000 1.000000e+00


# day 14 ------------------------------------------------------------------------------------------------ #

data.pca_D14 <- princomp(corr_matrix_D14)
summary(data.pca_D14)

# each component explains a percentage of the total variance 
# in the data - the Cumulative Proportion section first PC is ~78%  of the total var 
# this implies that ~1/2 of the data in the set of 4 variables is represented by the first PC

# Importance of components:
#                           Comp.1    Comp.2     Comp.3 Comp.4
# Standard deviation     1.0591856 0.4810245 0.25425018      0
# Proportion of Variance 0.7912213 0.1631880 0.04559071      0
# Cumulative Proportion  0.7912213 0.9544093 1.00000000      1

data.pca_D14_SEV <- princomp(corr_matrix_D14_SEV)
summary(data.pca_D14_SEV)
# Importance of components:
#                           Comp.1    Comp.2     Comp.3       Comp.4
# Standard deviation     0.8133464 0.3828210 0.28079480 4.950219e-09
# Proportion of Variance 0.7458676 0.1652350 0.08889734 2.762864e-17
# Cumulative Proportion  0.7458676 0.9111027 1.00000000 1.000000e+00
```

```{r explore the loadings}

# day 1 ------------------------------------------------------------------------------------------------ #

data.pca_D1$loadings[, 1:2] # of components 1 and 2! 

# we see positibe for ATP and ROS and negative for JC10 and proportion dead 

#                             Comp.1        Comp.2
# ATP_nmol_ng_protein     0.71473241  0.2073058595
# MitoSoxGreen_Mean_FL1  -0.39693700  0.5622389550
# JC10_FL2_FL1_Ratio     -0.56823841 -0.0005582045
# SYBR_PI_prop_alive_ADJ -0.09329364 -0.8005693764

data.pca_D1_LOW$loadings[, 1:2] # of components 1 and 2! 

#                            Comp.1     Comp.2
# ATP_nmol_ng_protein     0.4771650  0.6517539
# MitoSoxGreen_Mean_FL1   0.4103624 -0.7377062
# JC10_FL2_FL1_Ratio     -0.5506252 -0.1164935
# SYBR_PI_prop_alive_ADJ -0.5483869  0.1320445


data.pca_D1_MOD$loadings[, 1:2] # of components 1 and 2! 

#                             Comp.1      Comp.2
# ATP_nmol_ng_protein     0.63036592  0.12674874
# MitoSoxGreen_Mean_FL1  -0.46575381  0.09833165
# JC10_FL2_FL1_Ratio     -0.62100322  0.06791015
# SYBR_PI_prop_alive_ADJ -0.00819802 -0.98471004


data.pca_D1_HIGH$loadings[, 1:2] # of components 1 and 2! 

#                            Comp.1     Comp.2
# ATP_nmol_ng_protein     0.5810862  0.4127083
# MitoSoxGreen_Mean_FL1  -0.6064729  0.3717533
# JC10_FL2_FL1_Ratio     -0.5283692 -0.1640099
# SYBR_PI_prop_alive_ADJ  0.1239168 -0.8152129


# day 14 ------------------------------------------------------------------------------------------------ #

data.pca_D14$loadings[, 1:2] # of components 1 and 2! 

# we see positibe for ATP and ROS and negative for JC10 and proportion dead 

#                            Comp.1     Comp.2
# ATP_nmol_ng_protein     0.1066496  0.8491964
# MitoSoxGreen_Mean_FL1  -0.5179642 -0.3722451
# JC10_FL2_FL1_Ratio      0.6459960 -0.1440196
# SYBR_PI_prop_alive_ADJ -0.5504800  0.3457709
```

# scree plot 
 used to visuale the importance of each PC and can be used to determine th number of PCs to retain 
```{r scree plot}

# day 1 ------------------------------------------------------------------------------------------------ #

fviz_eig(data.pca_D1, addlabels = TRUE)
# first two PCs explain almost 80% of the total variance 
fviz_eig(data.pca_D1_LOW, addlabels = TRUE) # 93%
fviz_eig(data.pca_D1_MOD, addlabels = TRUE) # 93%
fviz_eig(data.pca_D1_HIGH, addlabels = TRUE) # 93%
# day 14 ------------------------------------------------------------------------------------------------ #

fviz_eig(data.pca_D14, addlabels = TRUE)
# first two PCs explain almost 100% of the total variance! 
```


```{r biplot}

# day 1 ------------------------------------------------------------------------------------------------ #

fviz_pca_var(data.pca_D1, col.var = "black")
fviz_pca_var(data.pca_D1_LOW, col.var = "black")
fviz_pca_var(data.pca_D1_MOD, col.var = "black")
fviz_pca_var(data.pca_D1_HIGH, col.var = "black")
# day 14 ------------------------------------------------------------------------------------------------ #

fviz_pca_var(data.pca_D14, col.var = "black")
fviz_pca_var(data.pca_D14_SEV, col.var = "black")
```


The code below computed the square cosine value for each variable with respect to the first two principal components. 
A low value means that the variable is not perfectly represented by that component. 
A high value, on the other hand, means a good representation of the variable on that component.
```{r contribution of each variable}

# day 1 ------------------------------------------------------------------------------------------------ #

fviz_cos2(data.pca_D1, choice = "var", axes = 1:2)
fviz_cos2(data.pca_D1, choice = "var", axes = 1:2)
# day 14 ------------------------------------------------------------------------------------------------ #

fviz_cos2(data.pca_D14, choice = "var", axes = 1:2)
```

```{r biplot with cos2}
# high cos2 = red, mid cos2 = orange, low cos2 = green


# day 1 ------------------------------------------------------------------------------------------------ #

fviz_pca_var(data.pca_D1, col.var = "cos2",
            gradient.cols = c("green", "orange", "red"),
            repel = TRUE)

fviz_pca_var(data.pca_D1_LOW, col.var = "cos2",
            gradient.cols = c("green", "orange", "red"),
            repel = TRUE)
fviz_pca_var(data.pca_D1_MOD, col.var = "cos2",
            gradient.cols = c("green", "orange", "red"),
            repel = TRUE)
fviz_pca_var(data.pca_D1_HIGH, col.var = "cos2",
            gradient.cols = c("green", "orange", "red"),
            repel = TRUE)
# day 14 ------------------------------------------------------------------------------------------------ #

fviz_pca_var(data.pca_D14, col.var = "cos2",
            gradient.cols = c("green", "orange", "red"),
            repel = TRUE,
            geom = c("point", "text", "arrow"))


```


```{r}
library(ggfortify)
library(ggbiplot)

# day 1 ------------------------------------------------------------------------------------------------ #


# ALL

pca_res_D1         <- prcomp(data_normalized_D1, scale. = TRUE)
Merge_master_OM_D1 <- Merge_master_OM %>% 
                        dplyr::filter(Day %in% 1) %>% 
                        dplyr::mutate(pCO2_total = paste0(pCO2_history, ' x ', pCO2_exposure))
ggarrange(
autoplot(pca_res_D1, data = Merge_master_OM_D1, 
         colour = 'pCO2_history', 
         loadings = TRUE, 
         loadings.label = TRUE, loadings.label.size = 3, 
         frame = TRUE) 
         #frame.type = 'norm')
,

autoplot(pca_res_D1, data = Merge_master_OM_D1, 
         colour = 'pCO2_exposure', 
         loadings = TRUE, 
         loadings.label = TRUE, loadings.label.size = 3, 
         frame = TRUE) 
         #frame.type = 'norm')
)


# LOW history :::::::::::::::::::;
pca_res_D1_LOW     <- prcomp(data_normalized_D1_LOW, scale. = TRUE)
Merge_master_D1LOW <- Merge_master_OM %>% 
                        dplyr::filter((Day %in% 1 & pCO2_history %in% 'low')) %>% 
                        dplyr::mutate(Match_Mismatch = 
                                      case_when(pCO2_exposure == 'low' ~ 'match',
                                                TRUE ~ 'mismatch')) 
df.pca_res_D1LOW  <- as.data.frame(predict(pca_res_D1_LOW)[,1:2]) %>% 
                      dplyr::mutate(pCO2_history   = Merge_master_D1LOW$pCO2_history,
                                    pCO2_exposure  = Merge_master_D1LOW$pCO2_exposure,
                                    Match_Mismatch = Merge_master_D1LOW$Match_Mismatch)
# mod history :::::::::::::::::::::::::
pca_res_D1_mod     <- prcomp(data_normalized_D1_MOD, scale. = TRUE)
Merge_master_D1mod <- Merge_master_OM %>% 
                        dplyr::filter((Day %in% 1 & pCO2_history %in% 'moderate')) %>% 
                        dplyr::mutate(Match_Mismatch = 
                                      case_when(pCO2_exposure == 'moderate' ~ 'match',
                                                TRUE ~ 'mismatch')) 
df.pca_res_D1mod  <- as.data.frame(predict(pca_res_D1_mod)[,1:2]) %>% 
                      dplyr::mutate(pCO2_history   = Merge_master_D1mod$pCO2_history,
                                    pCO2_exposure  = Merge_master_D1mod$pCO2_exposure,
                                    Match_Mismatch = Merge_master_D1mod$Match_Mismatch)
# high pCO2 :::::::::::::::::::::::::::::
pca_res_D1_high     <- prcomp(data_normalized_D1_SEV, scale. = TRUE)
Merge_master_D1high <- Merge_master_OM %>% 
                        dplyr::filter((Day %in% 1 & pCO2_history %in% 'severe')) %>% 
                        dplyr::mutate(Match_Mismatch = 
                                      case_when(pCO2_exposure == 'severe' ~ 'match',
                                                TRUE ~ 'mismatch')) 
df.pca_res_D1high  <- as.data.frame(predict(pca_res_D1_high)[,1:2]) %>% 
                      dplyr::mutate(pCO2_history   = Merge_master_D1high$pCO2_history,
                                    pCO2_exposure  = Merge_master_D1high$pCO2_exposure,
                                    Match_Mismatch = Merge_master_D1high$Match_Mismatch)
# all plots by history match mismatch
ggarrange(
          ggplot(df.pca_res_D1LOW, 
                 aes(PC1, PC2, color = Match_Mismatch)) + 
            geom_point() +
            theme_classic() +
            stat_ellipse(type = "t") +
            coord_fixed(),
          ggplot(df.pca_res_D1mod, 
                 aes(PC1, PC2, color = Match_Mismatch)) + 
            geom_point() +
            theme_classic() +
            stat_ellipse(type = "t") +
            coord_fixed(),
          ggplot(df.pca_res_D1high, 
                 aes(PC1, PC2, color = Match_Mismatch)) + 
            geom_point() +
            theme_classic() +
            stat_ellipse(type = "t") +
            coord_fixed() 
          )





autoplot(pca_res_D1, data = Merge_master_OM_D1, 
         colour = 'pCO2_total', 
         loadings = TRUE, 
         loadings.label = TRUE, loadings.label.size = 3, 
         frame = TRUE) 

df.pca_res_D1<- as.data.frame(predict(pca_res_D1)[,1:2])
df.pca_res_D1$pCO2_history <- Merge_master_OM_D1$pCO2_history
df.pca_res_D1$pCO2_exposure <- Merge_master_OM_D1$pCO2_exposure
ggplot(df.pca_res_D1, aes(PC1, PC2, color = pCO2_history)) + 
  geom_point() +
  theme_bw() +
  stat_ellipse(type = "t") +
  coord_fixed() 
ggplot(df.pca_res_D1, aes(PC1, PC2, color = pCO2_exposure)) + 
  geom_point() +
  theme_bw() +
  stat_ellipse(type = "t") +
  coord_fixed() 



pca_res_D1         <- prcomp(data_normalized_D1, scale. = TRUE)
Merge_master_OM_D1 <- Merge_master_OM %>% 
                        dplyr::filter(Day %in% 1)

pca_res_D1_LOW         <- prcomp(data_normalized_D1_LOW, scale. = TRUE)
Merge_master_OM_D1_LOW <- Merge_master_OM %>% 
                        dplyr::filter(Day %in% 1 & pCO2_history == 'low')

pca_res_D1_MOD         <- prcomp(data_normalized_D1_MOD, scale. = TRUE)
Merge_master_OM_D1_MOD <- Merge_master_OM %>% 
                        dplyr::filter(Day %in% 1 & pCO2_history == 'moderate')

pca_res_D1_SEV         <- prcomp(data_normalized_D1_SEV, scale. = TRUE)
Merge_master_OM_D1_SEV <- Merge_master_OM %>% 
                        dplyr::filter(Day %in% 1 & pCO2_history == 'severe')

ggarrange(
          ggbiplot(pca_res_D1,
                            obs.scale = 1,
                            var.scale = 1,
                            size = 5,
                            groups = as.factor(Merge_master_OM_D1$pCO2_history),
                            ellipse = TRUE,
                            circle = TRUE) +
            scale_color_discrete(name = '') +  
            theme_classic() +   
            ggtitle("day1, pCO2 history") +
            theme(legend.direction = 'horizontal',
                  legend.position = 'top'),
          ggbiplot(pca_res_D1,
                            obs.scale = 1,
                            var.scale = 1,
                            size = 5,
                            groups = as.factor(Merge_master_OM_D1$pCO2_exposure),
                            ellipse = TRUE,
                            circle = TRUE) +
            scale_color_discrete(name = '') +  
            theme_classic() +   
            ggtitle("day1, pCO2 exposure") +
            theme(legend.direction = 'horizontal',
                  legend.position = 'top'),
ncol=2)


ggarrange(
          ggbiplot(pca_res_D1_LOW,
                            obs.scale = 1,
                            var.scale = 1,
                            size = 5,
                            groups = as.factor(Merge_master_OM_D1_LOW$pCO2_exposure),
                            ellipse = TRUE,
                            circle = TRUE) +
            scale_color_discrete(name = '') +  
            theme_classic() +   
            ggtitle("day1, low history") +
            theme(legend.direction = 'horizontal',
                  legend.position = 'top'),
          
          
          
          ggbiplot(pca_res_D1_MOD,
                            obs.scale = 1,
                            var.scale = 1,
                            size = 5,
                            groups = as.factor(Merge_master_OM_D1_MOD$pCO2_exposure),
                            ellipse = TRUE,
                            circle = TRUE) +
            scale_color_discrete(name = '') +  
            theme_classic() +   
            ggtitle("day1, mod history") +
            theme(legend.direction = 'horizontal',
                  legend.position = 'top'),
          
          
          ggbiplot(pca_res_D1_SEV,
                            obs.scale = 1,
                            var.scale = 1,
                            size = 5,
                            groups = as.factor(Merge_master_OM_D1_SEV$pCO2_exposure),
                            ellipse = TRUE,
                            circle = TRUE) +
            scale_color_discrete(name = '') +  
            theme_classic() +   
            ggtitle("day1, sev history") +
            theme(legend.direction = 'horizontal',
                  legend.position = 'top'),

nrow=3)








```

```{r}


# day 14 ------------------------------------------------------------------------------------------------ #


pca_res_D14 <- prcomp(data_normalized_D14, scale. = TRUE)

Merge_master_OM_D14 <- Merge_master_OM %>% 
                        dplyr::filter(Day %in% 14) %>% 
                        dplyr::mutate(pCO2_total = paste0(pCO2_history, ' x ', pCO2_exposure))

ggarrange(
autoplot(pca_res_D14, data = Merge_master_OM_D14, 
         colour = 'pCO2_history', 
         loadings = TRUE, 
         loadings.label = TRUE, loadings.label.size = 3, 
         frame = TRUE) 
         #frame.type = 'norm')
,

autoplot(pca_res_D14, data = Merge_master_OM_D14, 
         colour = 'pCO2_exposure', 
         loadings = TRUE, 
         loadings.label = TRUE, loadings.label.size = 3, 
         frame = TRUE) 
         #frame.type = 'norm')
)

autoplot(pca_res_D14, data = Merge_master_OM_D14, 
         colour = 'pCO2_total', 
         loadings = TRUE, 
         loadings.label = TRUE, loadings.label.size = 3, 
         frame = TRUE) 

df.pca_res_D14<- as.data.frame(predict(pca_res_D14)[,1:2])
df.pca_res_D14$pCO2_history <- Merge_master_OM_D14$pCO2_history
df.pca_res_D14$pCO2_exposure <- Merge_master_OM_D14$pCO2_exposure
ggplot(df.pca_res_D14, aes(PC1, PC2, color = pCO2_history)) + 
  geom_point() +
  theme_bw() +
  #stat_ellipse(type = "norm", linetype = 2) +
  stat_ellipse(type = "t") +
  coord_fixed() 
ggplot(df.pca_res_D14, aes(PC1, PC2, color = pCO2_exposure)) + 
  geom_point() +
  theme_bw() +
  #stat_ellipse(type = "norm", linetype = 2) +
  stat_ellipse(type = "t") +
  coord_fixed() 




# LOW history :::::::::::::::::::;
pca_res_D14_LOW     <- prcomp(data_normalized_D14_LOW, scale. = TRUE)
Merge_master_D14LOW <- Merge_master_OM %>% 
                        dplyr::filter((Day %in% 14 & pCO2_history %in% 'low')) %>% 
                        dplyr::mutate(Match_Mismatch = 
                                      case_when(pCO2_exposure == 'low' ~ 'match',
                                                TRUE ~ 'mismatch')) 
df.pca_res_D14LOW  <- as.data.frame(predict(pca_res_D14_LOW)[,1:2]) %>% 
                      dplyr::mutate(pCO2_history   = Merge_master_D14LOW$pCO2_history,
                                    pCO2_exposure  = Merge_master_D14LOW$pCO2_exposure,
                                    Match_Mismatch = Merge_master_D14LOW$Match_Mismatch)
# mod history :::::::::::::::::::::::::
pca_res_D14_mod     <- prcomp(data_normalized_D14_MOD, scale. = TRUE)
Merge_master_D14mod <- Merge_master_OM %>% 
                        dplyr::filter((Day %in% 14 & pCO2_history %in% 'moderate')) %>% 
                        dplyr::mutate(Match_Mismatch = 
                                      case_when(pCO2_exposure == 'moderate' ~ 'match',
                                                TRUE ~ 'mismatch')) 
df.pca_res_D14mod  <- as.data.frame(predict(pca_res_D14_mod)[,1:2]) %>% 
                      dplyr::mutate(pCO2_history   = Merge_master_D14mod$pCO2_history,
                                    pCO2_exposure  = Merge_master_D14mod$pCO2_exposure,
                                    Match_Mismatch = Merge_master_D14mod$Match_Mismatch)
# high pCO2 :::::::::::::::::::::::::::::
pca_res_D14_high     <- prcomp(data_normalized_D14_SEV, scale. = TRUE)
Merge_master_D14high <- Merge_master_OM %>% 
                        dplyr::filter((Day %in% 14 & pCO2_history %in% 'severe')) %>% 
                        dplyr::mutate(Match_Mismatch = 
                                      case_when(pCO2_exposure == 'severe' ~ 'match',
                                                TRUE ~ 'mismatch')) 
df.pca_res_D14high  <- as.data.frame(predict(pca_res_D14_high)[,1:2]) %>% 
                      dplyr::mutate(pCO2_history   = Merge_master_D14high$pCO2_history,
                                    pCO2_exposure  = Merge_master_D14high$pCO2_exposure,
                                    Match_Mismatch = Merge_master_D14high$Match_Mismatch)
# all plots by history match mismatch
ggarrange(
          ggplot(df.pca_res_D14LOW, 
                 aes(PC1, PC2, color = Match_Mismatch)) + 
            geom_point() +
            theme_classic() +
            stat_ellipse(type = "t") +
            coord_fixed(),
          ggplot(df.pca_res_D14mod, 
                 aes(PC1, PC2, color = Match_Mismatch)) + 
            geom_point() +
            theme_classic() +
            stat_ellipse(type = "t") +
            coord_fixed(),
          ggplot(df.pca_res_D14high, 
                 aes(PC1, PC2, color = Match_Mismatch)) + 
            geom_point() +
            theme_classic() +
            stat_ellipse(type = "t") +
            coord_fixed() 
          )






















pca_res_D14         <- prcomp(data_normalized_D14, scale. = TRUE)
Merge_master_OM_D14 <- Merge_master_OM %>% 
                        dplyr::filter(Day %in% 14)

pca_res_D14_LOW         <- prcomp(data_normalized_D14_LOW, scale. = TRUE)
Merge_master_OM_D14_LOW <- Merge_master_OM %>% 
                        dplyr::filter(Day %in% 14 & pCO2_history == 'low')

pca_res_D14_MOD         <- prcomp(data_normalized_D14_MOD, scale. = TRUE)
Merge_master_OM_D14_MOD <- Merge_master_OM %>% 
                        dplyr::filter(Day %in% 14 & pCO2_history == 'moderate')

pca_res_D14_SEV         <- prcomp(data_normalized_D14_SEV, scale. = TRUE)
Merge_master_OM_D14_SEV <- Merge_master_OM %>% 
                        dplyr::filter(Day %in% 14 & pCO2_history == 'severe')
ggarrange(
          ggbiplot(pca_res_D14,
                            obs.scale = 1,
                            var.scale = 1,
                            size = 5,
                            groups = as.factor(Merge_master_OM_D14$pCO2_history),
                            ellipse = TRUE,
                            circle = TRUE) +
            scale_color_discrete(name = '') +  
            theme_classic() +   
            ggtitle("day14, pCO2 history") +
            theme(legend.direction = 'horizontal',
                  legend.position = 'top'),
          ggbiplot(pca_res_D14,
                            obs.scale = 1,
                            var.scale = 1,
                            size = 5,
                            groups = as.factor(Merge_master_OM_D14$pCO2_exposure),
                            ellipse = TRUE,
                            circle = TRUE) +
            scale_color_discrete(name = '') +  
            theme_classic() +   
            ggtitle("day14, pCO2 exposure") +
            theme(legend.direction = 'horizontal',
                  legend.position = 'top'),
ncol=2)







ggarrange(
ggbiplot(pca_res_D14_LOW,
                  obs.scale = 1,
                  var.scale = 1,
                  size = 5,
                  groups = as.factor(Merge_master_OM_D14_LOW$pCO2_exposure),
                  ellipse = TRUE,
                  circle = TRUE) +
  scale_color_discrete(name = '') +  
  theme_classic() +   
  ggtitle("day14, low history") +
  theme(legend.direction = 'horizontal',
        legend.position = 'top'),



ggbiplot(pca_res_D14_MOD,
                  obs.scale = 1,
                  var.scale = 1,
                  size = 5,
                  groups = as.factor(Merge_master_OM_D14_MOD$pCO2_exposure),
                  ellipse = TRUE,
                  circle = TRUE) +
  scale_color_discrete(name = '') +  
  theme_classic() +   
  ggtitle("day14, mod history") +
  theme(legend.direction = 'horizontal',
        legend.position = 'top'),


ggbiplot(pca_res_D14_SEV,
                  obs.scale = 1,
                  var.scale = 1,
                  size = 5,
                  groups = as.factor(Merge_master_OM_D14_SEV$pCO2_exposure),
                  ellipse = TRUE,
                  circle = TRUE) +
  scale_color_discrete(name = '') +  
  theme_classic() +   
  ggtitle("day14, sev history") +
  theme(legend.direction = 'horizontal',
        legend.position = 'top'),

nrow=3)


```
