---
title: "SeawaterChemistry_RMD"
author: "Samuel Gurr"
date: "2023-07-02"
output: html_document
---

-   Last updates: June/7/2023

## Load Libraries

```{r setup, include=FALSE}
library(dplyr)
library(lubridate)
library(ggplot2)
library(forcats)
library(ggpubr)
knitr::opts_knit$set(root.dir = "C:/Users/samjg/Documents/Github_repositories/Airradians_CellularMolecular_OA/RAnalysis") # sets the working directory for the entire R markdown file - no need to reload the wd

```

## Load chemistry files 

### HOBO sensor data 
* load the raw file
* add a few edits to facilitate merge
* merge as 'HOBO_all'
```{r load HOBO data}

pH7_HOBOraw  <- read.csv("../Data/Seawater_chemistry/HOBO_sensors/raw_googledrive/pH_7.csv", head = T) %>% 
  dplyr::mutate(pCO2_treatment = 'High') %>% # call pCO2 treatment
  dplyr::mutate(Date = mdy(sub(' .*','', Date_time))) %>% # parse all string before the space as Date 
  dplyr::mutate(Date_time = mdy_hm(Date_time)) %>% 
  dplyr::select(!X.) # remove the column we do not need

pH75_HOBOraw <- read.csv("../Data/Seawater_chemistry/HOBO_sensors/raw_googledrive/pH_75.csv", head = T) %>% 
  dplyr::mutate(pCO2_treatment = 'Moderate') %>% # call pCO2 treatment
  dplyr::mutate(Date = mdy(sub(' .*','', Date_time))) %>% # parse all string before the space as Date 
  dplyr::mutate(Date_time = mdy_hms(Date_time)) %>% 
  dplyr::select(!X.) # remove the column we do not need

pH8_HOBOraw  <- read.csv("../Data/Seawater_chemistry/HOBO_sensors/raw_googledrive/pH_8.csv", head = T) %>% 
  dplyr::mutate(pCO2_treatment = 'Low') %>% # call pCO2 treatment
  dplyr::mutate(Date = mdy(sub(' .*','', Date_time))) %>% # parse all string before the space as Date 
  dplyr::mutate(Date_time = mdy_hms(Date_time)) %>% 
  dplyr::select(!X.) # remove the column we do not need

HOBO_all <- rbind(pH7_HOBOraw,pH75_HOBOraw,pH8_HOBOraw) %>% 
  dplyr::filter(Date > '2023-04-27' & Date < '2023-05-17')
tail(HOBO_all)

```

### Full Carb chem data 

contains the following (in a single data table) 
* discrete probe measurments 
* CO2SYS outputs for TA+pH and DIC+pH 

```{r load full carb chem data}
# F1 carbonate chemistry
F1_CarbChem <- read.csv("../Data/Seawater_chemistry/CarbChem/raw/F1_CarbChem_raw.csv", head = T) %>% 
    dplyr::mutate(Gen = "F1") %>% 
    dplyr::mutate(Date = mdy(Date)) %>% # parse all string before the space as Date 
    dplyr::mutate(pCO2_treatment = case_when(
                                        as.numeric(Treatment) %% 7 == 0 ~ "High",
                                        as.numeric(Treatment) %% 7.5 == 0 ~ "Moderate",
                                        as.numeric(Treatment) %% 8 == 0 ~ "Low")) %>% 
    dplyr::mutate(pCO2_treatment = fct_relevel(pCO2_treatment, c('Low', 'Moderate', 'High'))) %>% 
    dplyr::mutate(DIC_TA_factor = 'DIC+pH') %>% # all carb chem completed with DIC and pH for F1s (DIC did not break!)
    dplyr::mutate(Type = fct_relevel(Type, c('Larvae', 'Juveniles', 'Adults'))) %>% 
    dplyr::filter(Date < '2022-08-16')
# F2 carbonate chemistry
F2_CarbChem <- read.csv("../Data/Seawater_chemistry/CarbChem/raw/F2_CarbChem_raw.csv", head = T) %>% 
    dplyr::mutate(Gen = "F2") %>% 
    dplyr::mutate(Date = mdy(Date)) %>% # parse all string before the space as Date 
    dplyr::mutate(pCO2_treatment = case_when(
                                        Treatment %% 7 == 0 ~ "High",
                                        Treatment %% 7.5 == 0 ~ "Moderate",
                                        Treatment %% 8.0 == 0 ~ "Low")) %>% 
    dplyr::mutate(pCO2_treatment = fct_relevel(pCO2_treatment, c('Low', 'Moderate', 'High'))) %>% 
    dplyr::mutate(Type = fct_relevel(Type, c('Spat', 'Juveniles', 'Adults'))) %>% 
    dplyr::mutate(DIC_TA_factor = case_when(is.na(pCO2_out_matm) ~ 
                                  'TA+pH', # triangle means the carb chem completed with TA + pH
                                  TRUE ~ 'DIC+pH')) %>%  # circle means carb chemleted with DIC + pH
    dplyr::filter(Date < '2023-05-17')
View(F2_CarbChem)
```

### HOBO Figures (Supplementary materials)

```{r HOBO figures}

HOBO_all %>% 
  dplyr::mutate(pCO2_treatment = fct_relevel(pCO2_treatment, c('Low', 'Moderate', 'High'))) %>% 
  ggplot(aes(Date_time, 
             Temperature, 
             color = pCO2_treatment)) + 
    geom_point() + 
    scale_color_manual(values = c("#009E73","#E69F00", "#CC79A7")) +
    theme_classic() +
    theme(legend.position = "none") +
    facet_wrap(~pCO2_treatment)



HOBO_pHmV <- HOBO_all %>% 
  dplyr::mutate(pCO2_treatment = fct_relevel(pCO2_treatment, c('Low', 'Moderate', 'High'))) %>% 
  ggplot(aes(Date_time, 
             pH_mv, 
             color = pCO2_treatment)) + 
    geom_point() + 
    scale_color_manual(values = c("#009E73","#E69F00", "#CC79A7")) +
    theme_classic() +
    theme(legend.position = "none") # +
    # facet_wrap(~pCO2_treatment)


pdf(paste0("C:/Users/samuel.gurr/Documents/Github_repositories/Airradians_CellularMolecular_OA/RAnalysis/Output/SeawaterChemistry/HOBO_pHmV_FullRecipChallenge.pdf"), height = 4, width = 6)
print(HOBO_pHmV)
dev.off()

HOBO_pH <- HOBO_all %>% 
  dplyr::mutate(pCO2_treatment = fct_relevel(pCO2_treatment, c('Low', 'Moderate', 'High'))) %>% 
  ggplot(aes(Date_time, 
             pH, 
             color = pCO2_treatment)) + 
    geom_point() + 
    scale_color_manual(values = c("#009E73","#E69F00", "#CC79A7")) +
    theme_classic() +
    theme(legend.position = "none") #+
  # facet_wrap(~pCO2_treatment)

pdf(paste0("C:/Users/samuel.gurr/Documents/Github_repositories/Airradians_CellularMolecular_OA/RAnalysis/Output/SeawaterChemistry/HOBO_pHNBScale_FullRecipChallenge.pdf"), height = 4, width = 6)
print(HOBO_pH)
dev.off()
```

### CarbChem Figures (Supplementary materials)

* pCO2_out_matm
```{r pCO2_out_matm figures}

# pCO2 ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
F1_pCO2 <- F1_CarbChem %>% 
  dplyr::select(c('Date','pCO2_treatment','Gen', 'Type', 'DIC_TA_factor', 'pCO2_out_matm'))
F2_pCO2 <- F2_CarbChem %>% 
  dplyr::mutate(pCO2_out_matm =  # case when DIC pH calc pCO2 is na, merge with the TA + pH pCO2 values!
                case_when(is.na(pCO2_out_matm) ~ 
                          pCO2_matm_TApH,
                          TRUE ~ pCO2_out_matm)) %>% 
  dplyr::select(c('Date','pCO2_treatment','Gen', 'Type', 'DIC_TA_factor', 'pCO2_out_matm'))
# merge together
pCO2_ALL <- rbind(F1_pCO2,F2_pCO2) %>% 
      dplyr::mutate(Type = fct_relevel(Type, c('Larvae', 'Spat', 'Juveniles', 'Adults'))) 
# levels(pCO2_ALL$Type)

#plot it 
CarbChem_pCO2_ALL <- pCO2_ALL %>% 
  # means and NAs omitted
  na.omit() %>%  
  group_by(Date, pCO2_treatment,Type, Gen, DIC_TA_factor) %>% # group by columns for treatment
  dplyr::summarise( # summarise to aquire the mean and SE for plotting
    pCO2_mean = mean(pCO2_out_matm), # mean
    pCO2_sd = sd(pCO2_out_matm), # sd
    n = n(), # count
    pCO2_se = pCO2_sd / sqrt(n)) %>% # SE
  # omit some error data 
  
    dplyr::filter(!(Gen %in% 'F1' & 
                    pCO2_treatment %in% c('Low', 'Moderate', 'High') & 
                    pCO2_mean > 1200)) %>% # 
    dplyr::filter(!(Gen %in% 'F1' & 
                    Type %in% 'Adults' & 
                    pCO2_treatment %in% 'Low' & 
                    Date < '2022-04-01' &
                    pCO2_mean > 650)) %>% # 
  
    dplyr::filter(!(Gen %in% 'F2' & 
                    pCO2_treatment %in% 'Moderate' & 
                    pCO2_mean < 300)) %>%  # ommit one data point
    dplyr::filter(!(Gen %in% 'F2' & 
                    Type %in% 'Spat' & 
                    pCO2_treatment %in% 'High')) %>% # typo? one timepoint of pH 7?
     dplyr::filter(!(Gen %in% 'F1' & 
                    Type %in% c('Juveniles', 'Adults') & 
                    pCO2_treatment %in% 'High')) %>% #

  # plot it
  ggplot(aes(Date, 
             pCO2_mean, 
             color = as.factor(pCO2_treatment))) + 
    geom_point(aes(shape=DIC_TA_factor), size = 2) +
    geom_errorbar(aes(ymin=(pCO2_mean)-(pCO2_se), 
                  ymax=(pCO2_mean)+(pCO2_se)), 
                  width=.2,position=position_dodge(.4)) +
    geom_smooth(se=F) + # no CI grey
    scale_shape_manual(values=c(16, 17)) + # filled circle, filled triangle, and X 
    scale_color_manual(values = c("#009E73","#E69F00", "#CC79A7")) +
    scale_x_date(date_breaks = "3 months", date_labels =  "%b %Y") +    
    theme_classic() +
    ylab(expression(italic("p")~"CO"[2])) +
    theme(legend.position = 'none',axis.title.x = element_blank(),axis.text.x=element_blank()) +
    #facet_grid(.~Gen+Type, scales = "free_x",space="free")
    facet_grid(.~Gen, scales = "free_x",space="free")
CarbChem_pCO2_ALL # view

```

```{r Cacite sat state figures}
library(ggtext)
# pCO2 :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
F1_Wca <- F1_CarbChem %>% 
  dplyr::select(c('Date','pCO2_treatment','Gen', 'Type', 'DIC_TA_factor', 'Wca_out'))
F2_Wca <- F2_CarbChem %>% 
  dplyr::mutate(Wca_out =  # case when DIC pH calc pCO2 is na, merge with the TA + pH pCO2 values!
                case_when(is.na(Wca_out) ~ 
                          WCa_TApH,
                          TRUE ~ Wca_out)) %>% 
  dplyr::select(c('Date','pCO2_treatment','Gen', 'Type', 'DIC_TA_factor', 'Wca_out'))
# merge together
WCa_ALL <- rbind(F1_Wca,F2_Wca) %>% 
      dplyr::mutate(Type = fct_relevel(Type, c('Larvae', 'Spat', 'Juveniles', 'Adults'))) 


CarbChem_WCa_ALL <- WCa_ALL %>% 
  # means and NAs omitted
  dplyr::select(c('Date','pCO2_treatment','Gen', 'Type','DIC_TA_factor', 'Wca_out')) %>% 
  na.omit() %>%  
  group_by(Date, pCO2_treatment, Gen, Type, DIC_TA_factor) %>% # group by columns for treatment
  dplyr::summarise( # summarise to aquire the mean and SE for plotting
    WCa_mean = mean(Wca_out), # mean
    WCa_sd = sd(Wca_out), # sd
    n = n(), # count
    WCa_se = WCa_sd / sqrt(n)) %>% # SE
  # omit some error data 
    dplyr::filter(!(pCO2_treatment %in% 'Moderate' &
                    WCa_mean < 0.75)) %>%  # ommit one data point
    dplyr::filter(!(Type %in% 'Spat' & 
                      pCO2_treatment %in% 'High')) %>%  # typo? one timepoint of pH 7?
    dplyr::filter(!(Gen %in% 'F1' & 
                    Type %in% c('Larvae','Juveniles', 'Adults') & 
                    pCO2_treatment %in% 'High')) %>% #
    dplyr::filter(!(Gen %in% 'F2' & 
                    pCO2_treatment %in% 'Moderate' & 
                      WCa_mean < 1.5)) %>% # typo? one timepoint of pH 7?
  ggplot(aes(Date, 
             WCa_mean, 
             color = as.factor(pCO2_treatment))) + 
    geom_point(aes(shape=DIC_TA_factor), size = 2) +
    geom_errorbar(aes(ymin=(WCa_mean)-(WCa_se), 
                  ymax=(WCa_mean)+(WCa_se)), 
                  width=.2,position=position_dodge(.4)) +    
    geom_smooth(se=F) + # no CI grey
    scale_shape_manual(values=c(16, 17)) + # filled circle, filled triangle, and X 
    scale_color_manual(values = c("#009E73","#E69F00", "#CC79A7")) +
    scale_x_date(date_breaks = "3 months", date_labels =  "%b %Y") +   
    coord_cartesian(ylim = c(0,5), expand = FALSE) +
    theme_classic() +
    ylab(expression("Ω"["calcite"])) +
    theme(legend.position = "none",axis.text.x = element_text(angle = 30,  hjust=1))  +
    facet_grid(.~Gen, scales = "free_x",space="free")
CarbChem_WCa_ALL

```



```{r Aragonite sat state figures}
library(ggtext)
# pCO2 :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
F1_WAr <- F1_CarbChem %>% 
  dplyr::select(c('Date','pCO2_treatment','Gen', 'Type', 'DIC_TA_factor', 'War_out_DIC_pH')) %>% 
  dplyr::rename(WAr_out = War_out_DIC_pH)
F2_WAr <- F2_CarbChem %>% 
  dplyr::mutate(WAr_out =  # case when DIC pH calc pCO2 is na, merge with the TA + pH pCO2 values!
                case_when(is.na(War_out_DIC_pH) ~ 
                          WAr_TApH,
                          TRUE ~ War_out_DIC_pH)) %>% 
  dplyr::select(c('Date','pCO2_treatment','Gen', 'Type', 'DIC_TA_factor', 'WAr_out'))
# merge together
WAr_ALL <- rbind(F1_WAr,F2_WAr) %>% 
      dplyr::mutate(Type = fct_relevel(Type, c('Larvae', 'Spat', 'Juveniles', 'Adults'))) %>% 
      na.omit()
max(WAr_ALL$WAr_out)

CarbChem_WAr_ALL <- WAr_ALL %>% 
  dplyr::filter(!(WAr_out > 5)) %>% 
  # means and NAs omitted5
  dplyr::select(c('Date','pCO2_treatment','Gen', 'Type','DIC_TA_factor', 'WAr_out')) %>% 
  na.omit() %>%  
  group_by(Date, pCO2_treatment, Gen, Type, DIC_TA_factor) %>% # group by columns for treatment
  dplyr::summarise( # summarise to aquire the mean and SE for plotting
    WAr_mean = mean(WAr_out), # mean
    WAr_sd = sd(WAr_out), # sd
    n = n(), # count
    WAr_se = WAr_sd / sqrt(n)) %>% # SE
  # omit some error data 
    # dplyr::filter(!(pCO2_treatment %in% 'Moderate' &
    #                 WAr_mean < 0.75)) %>%  # ommit one data point
    # dplyr::filter(!(Type %in% 'Spat' & 
    #                   pCO2_treatment %in% 'High')) %>%  # typo? one timepoint of pH 7?
    dplyr::filter(!(Gen %in% 'F1' & 
                     Type %in% c('Larvae','Juveniles', 'Adults') & 
                     pCO2_treatment %in% 'High')) %>% #
    dplyr::filter(!(Gen %in% 'F2' & 
                     pCO2_treatment %in% 'Moderate' & 
                       WAr_mean < 0.8)) %>% # typo? one timepoint of pH 7?
  ggplot(aes(Date, 
             WAr_mean, 
             color = as.factor(pCO2_treatment))) + 
    geom_point(aes(shape=DIC_TA_factor), size = 2) +
    geom_errorbar(aes(ymin=(WAr_mean)-(WAr_se), 
                  ymax=(WAr_mean)+(WAr_se)), 
                  width=.2,position=position_dodge(.4)) +    
    geom_smooth(se=F) + # no CI grey
    scale_shape_manual(values=c(16, 17)) + # filled circle, filled triangle, and X 
    scale_color_manual(values = c("#009E73","#E69F00", "#CC79A7")) +
    scale_x_date(date_breaks = "3 months", date_labels =  "%b %Y") +   
    coord_cartesian(ylim = c(0,3.5), expand = FALSE) +
    theme_classic() +
    ylab(expression("Ω"["aragonite"])) +
    theme(legend.position = "none",axis.text.x = element_text(angle = 30,  hjust=1))  +
    facet_grid(.~Gen, scales = "free_x",space="free")
CarbChem_WAr_ALL

```

# Experiment plots - violin total mean
```{r violin plots pCO2 abd WCa}
library('patchwork')

pCO2_Experiment.violin <- pCO2_ALL %>% 
  dplyr::filter(Date > '2023-04-30') %>% 
  ggviolin(x = "pCO2_treatment", 
           y = "pCO2_out_matm",
           fill = 'pCO2_treatment',
           size = c(.2),
           font.label =list(size = 5),
           palette = c("#009E73","#E69F00", "#CC79A7"),
    add =  c("jitter", "mean_sd"), add.params = list(fill = "white")) +
    ylab(expression(italic("p")~"CO"[2])) +
    coord_cartesian(ylim = c(250,1300), expand = FALSE) +
    theme(legend.position = 'none',
          axis.text.y = element_text(size =8),
          axis.title.x = element_blank(),axis.text.x=element_blank()) 

WCa_Experiment.violin <- WCa_ALL %>% 
  dplyr::filter(Date > '2023-04-30') %>% 
  ggviolin(x = "pCO2_treatment", 
           y = "Wca_out",
           fill = 'pCO2_treatment',
           size = c(.2),
           font.label =list(size = 1, face = "bold"),
           palette = c("#009E73","#E69F00", "#CC79A7"),
    add =  c("jitter", "mean_sd"), add.params = list(fill = "white")) + 
    ylab(expression("Ω"["calcite"])) +
    coord_cartesian(ylim = c(0,5), expand = FALSE) +
    theme(legend.position = 'none', 
          axis.text.y = element_text(size =10),
          axis.text.x = element_text(size = 10, angle = 30)) 


WAr_Experiment.violin <- WAr_ALL %>% 
  dplyr::filter(!(WAr_out > 5)) %>%
  dplyr::filter(Date > '2023-04-30') %>% 
  ggviolin(x = "pCO2_treatment", 
           y = "WAr_out",
           fill = 'pCO2_treatment',
           size = c(.2),
           font.label =list(size = 1, face = "bold"),
           palette = c("#009E73","#E69F00", "#CC79A7"),
    add =  c("jitter", "mean_sd"), add.params = list(fill = "white")) + 
    ylab(expression("Ω"["aragonite"])) +
    coord_cartesian(ylim = c(0,3.5), expand = FALSE) +
    theme(legend.position = 'none', 
          axis.text.y = element_text(size =10),
          axis.text.x = element_text(size = 10, angle = 30)) 


pdf(paste0("C:/Users/samjg/Documents/Github_repositories/Airradians_CellularMolecular_OA/RAnalysis/Output/SeawaterChemistry/CarbChem_FullRecipChallenge.pdf"), height = 4, width = 2)
ggarrange(pCO2_Experiment.violin, WCa_Experiment.violin, nrow = 2,common.legend = FALSE)
dev.off()



timeseriesplots <- (CarbChem_pCO2_ALL / CarbChem_WCa_ALL)
violinplots     <- (pCO2_Experiment.violin /WCa_Experiment.violin)

pdf(paste0("C:/Users/samjg/Documents/Github_repositories/Airradians_CellularMolecular_OA/RAnalysis/Output/SeawaterChemistry/CarbChem_Figure1.pdf"), height = 5, width = 10)
ggarrange(ggarrange(timeseriesplots, labels = "a", align = "h"), 
          ggarrange(violinplots, labels = "b", align = "h"), 
            ncol = 2, 
            widths = c(5, 2)) 
dev.off()

```

# Experiment plots - meanSE each timepoint
```{r violin plots pCO2 abd WCa}
library('patchwork')
library('Rmisc')

pCO2_Experiment_Means <- pCO2_ALL %>% 
                            dplyr::filter(Date > '2023-04-30') %>% 
                            summarySE(measurevar="pCO2_out_matm", 
                                      groupvars=c("Date", "pCO2_treatment"))


pCO2_Experiment_Plot <-  pCO2_Experiment_Means %>%
                                 ggplot(aes(x=(as.factor(Date)), 
                                               y=pCO2_out_matm, 
                                               color=as.factor(pCO2_treatment))) +
                                    geom_point(position=position_dodge(.5), size = 3)+ 
                                    scale_color_manual(values=c("forestgreen",
                                                                "darkorange2",
                                                                "purple"))+
                                    geom_errorbar(aes(ymin=pCO2_out_matm-se, 
                                                      ymax=pCO2_out_matm+se), width=.4,
                                                  position=position_dodge(.5))+
                                    theme_classic() +  
                                    xlab("Date") +
                                    ylab(expression(italic("p")~"CO"[2])) +
                                   #xlab("Age (d)") +
                                    theme(panel.grid.major = element_blank(), 
                                          panel.grid.minor = element_blank(),
                                          legend.position="none")+ 
                                    scale_y_continuous(expand = c(0, 0), limits = c(400, NA)) +
                                    # labs(color='pCO2 treatment') + # legend name
                                    theme(text = element_text(size=10))

pdf(paste0("C:/Users/samuel.gurr/Documents/Github_repositories/Airradians_CellularMolecular_OA/RAnalysis/Output/SeawaterChemistry/pCO2_FullRecipChallenge.pdf"), height = 4, width = 6)
print(pCO2_Experiment_Plot)
dev.off()

WAr_Experiment_Means <- WAr_ALL %>% 
                            dplyr::filter(Date > '2023-04-30') %>% 
                            summarySE(measurevar="WAr_out", 
                                      groupvars=c("Date", "pCO2_treatment"))


WAr_Experiment_Plot <-  WAr_Experiment_Means %>%
                                 ggplot(aes(x=(as.factor(Date)), 
                                               y=WAr_out, 
                                               color=as.factor(pCO2_treatment))) +
                                    geom_point(position=position_dodge(.5), size = 3)+ 
                                    scale_color_manual(values=c("forestgreen",
                                                                "darkorange2",
                                                                "purple"))+
                                    geom_errorbar(aes(ymin=WAr_out-se, 
                                                      ymax=WAr_out+se), width=.4,
                                                  position=position_dodge(.5))+
                                    theme_classic() +  
                                    xlab("Date") +
                                    ylab("Argonite saturation state") +
                                   #xlab("Age (d)") +
                                    theme(panel.grid.major = element_blank(), 
                                          panel.grid.minor = element_blank(),
                                          legend.position="none")+ 
                                    scale_y_continuous(expand = c(0, 0), limits = c(0.5, NA)) +
                                    # labs(color='pCO2 treatment') + # legend name
                                    theme(text = element_text(size=10))

pdf(paste0("C:/Users/samuel.gurr/Documents/Github_repositories/Airradians_CellularMolecular_OA/RAnalysis/Output/SeawaterChemistry/Aragonite_FullRecipChallenge.pdf"), height = 4, width = 6)
print(WAr_Experiment_Plot)
dev.off()

```


```{r pCO2 with calcite and aragonite}
library(ggpubr)

#Calcite 
xCacite <- ggarrange(pCO2_Experiment.violin, WCa_Experiment.violin, nrow = 2,common.legend = FALSE)
yCaclite <- ggarrange(CarbChem_pCO2_ALL,CarbChem_WCa_ALL, nrow = 2)
ggarrange(y,x,ncol=2,widths = c(2, 0.75))
pdf(paste0("C:/Users/samuel.gurr/Documents/Github_repositories/Airradians_CellularMolecular_OA/RAnalysis/Output/SeawaterChemistry/CarbChem_pCO2_WCa.pdf"), height = 6, width = 8)
ggarrange(CarbChem_pCO2_ALL,CarbChem_WCa_ALL, nrow = 2)
#ggarrange(yCaclite,xCacite,ncol=2,widths = c(2, 0.75))
dev.off()



xAragonite <- ggarrange(pCO2_Experiment.violin, WAr_Experiment.violin, nrow = 2,common.legend = FALSE)
yAragonite <- ggarrange(CarbChem_pCO2_ALL,CarbChem_WAr_ALL, nrow = 2)
ggarrange(yAragonite,xAragonite,ncol=2,widths = c(2, 0.75))
pdf(paste0("C:/Users/samuel.gurr/Documents/Github_repositories/Airradians_CellularMolecular_OA/RAnalysis/Output/SeawaterChemistry/CarbChem_pCO2_WAr.pdf"), height = 6, width = 8)
ggarrange(CarbChem_pCO2_ALL,CarbChem_WAr_ALL, nrow = 2)
dev.off()
```

# Tables - Experiment Carbonate Chemsitry (F2s in May)

* all data after 5-1-2023
```{r Experiment carbonate chemistry - call data}

F2_CarbChem_EXPERIMENT  <- F2_CarbChem %>% dplyr::filter(Date > '2023-05-01') %>% 
  dplyr::select(Date, Replicate, Treatment, # metadata
                pH, Salinity, Temperature_bucket_C, # dipping probe measurements
                pH_out, TA_mmol_kgSW, # instrument measurements
                pCO2_out_matm, Wca_out, War_out_DIC_pH
                ) # CO2SYS 

F2_CarbChem_EXPERIMENT$TA_mmol_kgSW <- as.numeric(F2_CarbChem_EXPERIMENT$TA_mmol_kgSW)

# dates called
unique(F2_CarbChem_EXPERIMENT$Date) # "2023-05-02" "2023-05-09" "2023-05-16"

# count repts at each day 
F2_CarbChem_EXPERIMENT %>% group_by(Date, Treatment) %>% summarise(n=n()) # N = 3 each replicates sampling day!

# means by tank 
F2_CarbChem_EXPERIMENT_means <- F2_CarbChem_EXPERIMENT %>% 
                                  dplyr::select(-Replicate) %>% 
                                  group_by(Date, Treatment) %>% 
                                  summarise_all(mean, na.rm = TRUE) %>% 
                                  dplyr::rename(
                                    pCO2 = pCO2_out_matm,
                                    Temperature = Temperature_bucket_C,
                                    pH_measured = pH_out, 
                                    WCa = Wca_out,
                                    WAr = War_out_DIC_pH
                                  )

```

```{r Experiment carbonate chemistry - melt to long form}

# change to long format to properly facet
F2_CarbChem_EXPERIMENT_long <- F2_CarbChem_EXPERIMENT_means %>% 
                                  reshape2::melt(id.vars=c('Date', 'Treatment'))


# get the mean. sd. and se for all the data - not ethat an N = 3 for the Date
# these data are already in the mean wihtin day (by N=3 replicates) - run this by the team if they 
# want otherwise (summary - preents a mean of a mean, from a mena witin day (replicate tank) and across days)
F2_CarbChem_EXPERIMENT_longMEANS <- F2_CarbChem_EXPERIMENT_long %>% # calc means and standard error
                                         na.omit() %>% 
                                         dplyr::group_by(Treatment, variable) %>% 
                                         dplyr::summarise(mean = mean(value),
                                                          sd   = sd(value),
                                                          se   = sd/(sqrt(n())) ,
                                                          n = n())



# cast to wide format

F2_CarbChem_EXPERIMENT_wideMEANS <- reshape2::dcast(F2_CarbChem_EXPERIMENT_longMEANS, Treatment ~ variable, value.var="mean")
F2_CarbChem_EXPERIMENT_wideStErr <- reshape2::dcast(F2_CarbChem_EXPERIMENT_longMEANS, Treatment ~ variable, value.var="se")
F2_CarbChem_EXPERIMENT_wideN     <- reshape2::dcast(F2_CarbChem_EXPERIMENT_longMEANS, Treatment ~ variable, value.var="n")

colnames(F2_CarbChem_EXPERIMENT_wideMEANS)

# final table

F2_CarbChem_EXPERIMENT_wideMEANS <- F2_CarbChem_EXPERIMENT_wideMEANS %>% arrange(desc(WAr))

FINAL_TABLE                <- data.frame(matrix(nrow = nrow(F2_CarbChem_EXPERIMENT_wideMEANS), ncol = 1))


FINAL_TABLE$pCO2_treatment <- F2_CarbChem_EXPERIMENT_wideMEANS$Treatment


FINAL_TABLE$pH             <- paste( (paste( (signif(F2_CarbChem_EXPERIMENT_wideMEANS$pH, digits=5)),
                                     (signif(F2_CarbChem_EXPERIMENT_wideStErr$pH, digits=3)), sep=" ± ")),
                                     " (",
                                     F2_CarbChem_EXPERIMENT_wideN$pH,
                                     ")",
                                     sep = "")

FINAL_TABLE$Salinity       <-  paste( (paste( (signif(F2_CarbChem_EXPERIMENT_wideMEANS$Salinity, digits=4)),
                                     (signif(F2_CarbChem_EXPERIMENT_wideStErr$Salinity, digits=1)), sep=" ± ")),
                                     " (",
                                     F2_CarbChem_EXPERIMENT_wideN$Salinity,
                                     ")",
                                     sep = "")

FINAL_TABLE$Temperature    <- paste( (paste( (signif(F2_CarbChem_EXPERIMENT_wideMEANS$Temperature, digits=3)),
                                     (signif(F2_CarbChem_EXPERIMENT_wideStErr$Temperature, digits=1)), sep=" ± ")),
                                     " (",
                                     F2_CarbChem_EXPERIMENT_wideN$Temperature,
                                     ")",
                                     sep = "")


FINAL_TABLE$pH_measured    <- paste( (paste( (signif(F2_CarbChem_EXPERIMENT_wideMEANS$pH_measured, digits=5)),
                                     (signif(F2_CarbChem_EXPERIMENT_wideStErr$pH_measured, digits=3)), sep=" ± ")),
                                     " (",
                                     F2_CarbChem_EXPERIMENT_wideN$pH_measured,
                                     ")",
                                     sep = "")


FINAL_TABLE$TA             <- paste( (paste( (signif(F2_CarbChem_EXPERIMENT_wideMEANS$TA_mmol_kgSW, digits=6)),
                                     (signif(F2_CarbChem_EXPERIMENT_wideStErr$TA_mmol_kgSW, digits=4)), sep=" ± ")),
                                     " (",
                                     F2_CarbChem_EXPERIMENT_wideN$TA_mmol_kgSW,
                                     ")",
                                     sep = "")

FINAL_TABLE$pCO2           <-  paste( (paste( (signif(F2_CarbChem_EXPERIMENT_wideMEANS$pCO2, digits=3)),
                                     (signif(F2_CarbChem_EXPERIMENT_wideStErr$pCO2, digits=2)), sep=" ± ")),
                                     " (",
                                     F2_CarbChem_EXPERIMENT_wideN$pCO2,
                                     ")",
                                     sep = "")

FINAL_TABLE$Calcite.sat             <- paste( (paste( (signif(F2_CarbChem_EXPERIMENT_wideMEANS$WCa, digits=6)),
                                     (signif(F2_CarbChem_EXPERIMENT_wideStErr$WCa, digits=4)), sep=" ± ")),
                                     " (",
                                     F2_CarbChem_EXPERIMENT_wideN$WCa,
                                     ")",
                                     sep = "")

FINAL_TABLE$Aragonite.Sat  <-  paste( (paste( (signif(F2_CarbChem_EXPERIMENT_wideMEANS$WAr, digits=3)),
                                     (signif(F2_CarbChem_EXPERIMENT_wideStErr$WAr, digits=3)), sep=" ± ")),
                                     " (",
                                     F2_CarbChem_EXPERIMENT_wideN$WAr,
                                     ")",
                                     sep = "")

FINAL_TABLE                <- FINAL_TABLE[,-1] %>%  # view table
                                  dplyr::mutate(pCO2_treatment = case_when(pCO2_treatment == 8.0 ~ 'Low',
                                                                           pCO2_treatment == 7.5 ~ 'Moderate',
                                                                           pCO2_treatment == 7.0 ~ 'High',))


```

```{r Experiment carbonate chemistry - output table}
library(knitr)
library(kableExtra)
FINAL_TABLE %>%
  kbl(caption = "Table 1. Seawater chemistry") %>%
  kable_classic(full_width = T, html_font = "Cambria")


# save output table
write.table(F2_CarbChem_EXPERIMENT_longMEANS,"Output/SeawaterChemistry/Tables/Means_CarbChem_Experiment_May2023.csv",sep=",", row.names=FALSE)  # write table to 
write.table(FINAL_TABLE,"Output/SeawaterChemistry/Tables/Summary_Experiment_May2023.csv",sep=",", row.names=FALSE, fileEncoding = "latin1")  # write table to 


```


# Tables - F2 Rearing Carbonate Chemistry (F2s BEFORE May)

* all data BEFORE 5-1-2023
* from 2022-08-16 to 2023-04-25
```{r F2 REARING carbonate chemistry - call data}

F2_CarbChem_REARING  <- F2_CarbChem %>% dplyr::filter(Date < '2023-05-01') %>% 
  dplyr::select(Date, Replicate, Treatment, # metadata
                pH, Salinity, Temperature_bucket_C, # dipping probe measurements
                pH_out, TA_mmol_kgSW, # instrument measurements
                pCO2_out_matm, Wca_out, War_out_DIC_pH
                ) # CO2SYS 

F2_CarbChem_REARING$TA_mmol_kgSW <- as.numeric(F2_CarbChem_REARING$TA_mmol_kgSW)

# dates called
unique(F2_CarbChem_REARING$Date) # "2023-05-02" "2023-05-09" "2023-05-16"

# count repts at each day 
F2_CarbChem_REARING %>% group_by(Date, Treatment) %>% summarise(n=n()) # N = 3 each replicates sampling day!

# means by tank 
F2_CarbChem_REARING_means <- F2_CarbChem_REARING %>% 
                                  dplyr::select(-Replicate) %>% 
                                  group_by(Date, Treatment) %>% 
                                  summarise_all(mean, na.rm = TRUE) %>% 
                                  dplyr::rename(
                                    pCO2 = pCO2_out_matm,
                                    Temperature = Temperature_bucket_C,
                                    pH_measured = pH_out, 
                                    WCa = Wca_out,
                                    WAr = War_out_DIC_pH
                                  )

```

```{r F2 REARING carbonate chemistry - melt to long form}

# change to long format to properly facet
F2_CarbChem_REARING_long <- F2_CarbChem_REARING_means %>% 
                                  reshape2::melt(id.vars=c('Date', 'Treatment'))


# get the mean. sd. and se for all the data - not ethat an N = 3 for the Date
# these data are already in the mean wihtin day (by N=3 replicates) - run this by the team if they 
# want otherwise (summary - preents a mean of a mean, from a mena witin day (replicate tank) and across days)
F2_CarbChem_REARING_longMEANS <- F2_CarbChem_REARING_long %>% # calc means and standard error
                                         na.omit() %>% 
                                         dplyr::group_by(Treatment, variable) %>% 
                                         dplyr::summarise(mean = mean(value),
                                                          sd   = sd(value),
                                                          se   = sd/(sqrt(n())) ,
                                                          n = n())



# cast to wide format

F2_CarbChem_REARING_wideMEANS <- reshape2::dcast(F2_CarbChem_REARING_longMEANS, Treatment ~ variable, value.var="mean")
F2_CarbChem_REARING_wideStErr <- reshape2::dcast(F2_CarbChem_REARING_longMEANS, Treatment ~ variable, value.var="se")
F2_CarbChem_REARING_wideN     <- reshape2::dcast(F2_CarbChem_REARING_longMEANS, Treatment ~ variable, value.var="n")

colnames(F2_CarbChem_REARING_wideMEANS)

# final table

F2_CarbChem_REARING_wideMEANS <- F2_CarbChem_REARING_wideMEANS %>% arrange(desc(WAr))

FINAL_TABLE                <- data.frame(matrix(nrow = nrow(F2_CarbChem_REARING_wideMEANS), ncol = 1))


FINAL_TABLE$pCO2_treatment <- F2_CarbChem_REARING_wideMEANS$Treatment


FINAL_TABLE$pH             <- paste( (paste( (signif(F2_CarbChem_REARING_wideMEANS$pH, digits=5)),
                                     (signif(F2_CarbChem_REARING_wideStErr$pH, digits=3)), sep=" ± ")),
                                     " (",
                                     F2_CarbChem_REARING_wideN$pH,
                                     ")",
                                     sep = "")

FINAL_TABLE$Salinity       <-  paste( (paste( (signif(F2_CarbChem_REARING_wideMEANS$Salinity, digits=4)),
                                     (signif(F2_CarbChem_REARING_wideStErr$Salinity, digits=1)), sep=" ± ")),
                                     " (",
                                     F2_CarbChem_REARING_wideN$Salinity,
                                     ")",
                                     sep = "")

FINAL_TABLE$Temperature    <- paste( (paste( (signif(F2_CarbChem_REARING_wideMEANS$Temperature, digits=3)),
                                     (signif(F2_CarbChem_REARING_wideStErr$Temperature, digits=1)), sep=" ± ")),
                                     " (",
                                     F2_CarbChem_REARING_wideN$Temperature,
                                     ")",
                                     sep = "")


FINAL_TABLE$pH_measured    <- paste( (paste( (signif(F2_CarbChem_REARING_wideMEANS$pH_measured, digits=5)),
                                     (signif(F2_CarbChem_REARING_wideStErr$pH_measured, digits=3)), sep=" ± ")),
                                     " (",
                                     F2_CarbChem_REARING_wideN$pH_measured,
                                     ")",
                                     sep = "")


FINAL_TABLE$TA             <- paste( (paste( (signif(F2_CarbChem_REARING_wideMEANS$TA_mmol_kgSW, digits=6)),
                                     (signif(F2_CarbChem_REARING_wideStErr$TA_mmol_kgSW, digits=4)), sep=" ± ")),
                                     " (",
                                     F2_CarbChem_REARING_wideN$TA_mmol_kgSW,
                                     ")",
                                     sep = "")

FINAL_TABLE$pCO2           <-  paste( (paste( (signif(F2_CarbChem_REARING_wideMEANS$pCO2, digits=3)),
                                     (signif(F2_CarbChem_REARING_wideStErr$pCO2, digits=2)), sep=" ± ")),
                                     " (",
                                     F2_CarbChem_REARING_wideN$pCO2,
                                     ")",
                                     sep = "")

FINAL_TABLE$Calcite.sat             <- paste( (paste( (signif(F2_CarbChem_REARING_wideMEANS$WCa, digits=6)),
                                     (signif(F2_CarbChem_REARING_wideStErr$WCa, digits=4)), sep=" ± ")),
                                     " (",
                                     F2_CarbChem_REARING_wideN$WCa,
                                     ")",
                                     sep = "")

FINAL_TABLE$Aragonite.Sat  <-  paste( (paste( (signif(F2_CarbChem_REARING_wideMEANS$WAr, digits=3)),
                                     (signif(F2_CarbChem_REARING_wideStErr$WAr, digits=3)), sep=" ± ")),
                                     " (",
                                     F2_CarbChem_REARING_wideN$WAr,
                                     ")",
                                     sep = "")

FINAL_TABLE                <- FINAL_TABLE[,-1] %>%  # view table
                                  dplyr::mutate(pCO2_treatment = case_when(pCO2_treatment == 8.0 ~ 'Low',
                                                                           pCO2_treatment == 7.5 ~ 'Moderate',
                                                                           pCO2_treatment == 7.0 ~ 'High',))


```

```{r F2 REARING carbonate chemistry - output table}
library(knitr)
library(kableExtra)
FINAL_TABLE %>%
  kbl(caption = "Table 1. Seawater chemistry") %>%
  kable_classic(full_width = T, html_font = "Cambria")


# save output table
write.table(F2_CarbChem_REARING_longMEANS,"Output/SeawaterChemistry/Tables/Means_CarbChem_F2_Rearing.csv",sep=",", row.names=FALSE)  # write table to 
write.table(FINAL_TABLE,"Output/SeawaterChemistry/Tables/Summary_F2_Rearing.csv",sep=",", row.names=FALSE, fileEncoding = "latin1")  # write table to 


```



# Tables -  F1 Rearing Carbonate Chemistry (all F1, two treatments remember!)

* all data
* from 2021-07-26 to 2022-08-15
```{r F1 REARING carbonate chemistry - call data}

F1_CarbChem_REARING  <- F1_CarbChem %>% 
  dplyr::select(Date, Replicate, Treatment, # metadata
                pH, Salinity, Temperature_bucket_C, # dipping probe measurements
                pH_out, TA_mmol_kgSW, # instrument measurements
                pCO2_out_matm, Wca_out, War_out_DIC_pH
                ) # CO2SYS 

F1_CarbChem_REARING$TA_mmol_kgSW <- as.numeric(F1_CarbChem_REARING$TA_mmol_kgSW)

# dates called
unique(F1_CarbChem_REARING$Date) # "2023-05-02" "2023-05-09" "2023-05-16"

# count repts at each day 
F1_CarbChem_REARING %>% group_by(Date, Treatment) %>% summarise(n=n()) # N = 3 each replicates sampling day!

unique(F1_CarbChem_REARING$Replicate)
unique(F1_CarbChem_REARING$Treatment)
# means by tank 
F1_CarbChem_REARING_means <- F1_CarbChem_REARING[!is.na(F1_CarbChem_REARING$War_out_DIC_pH),] %>% 
                                  dplyr::filter(!pH_out >10) %>% 
                                  dplyr::filter(!Replicate %in% c('extra','single tape','single tap','RESPO', 'double tape', 'not used (F)', 'used (E)')) %>% 
                                  dplyr::filter(!Treatment %in% c('Tank Farm','Tank farm', '7', '')) %>% 
                                  dplyr::select(-Replicate) %>% 
                                  group_by(Date, Treatment) %>% 
                                  summarise_all(mean, na.rm = TRUE) %>% 
                                  dplyr::rename(
                                    pCO2 = pCO2_out_matm,
                                    Temperature = Temperature_bucket_C,
                                    pH_measured = pH_out, 
                                    WCa = Wca_out,
                                    WAr = War_out_DIC_pH
                                  )

```

```{r F1 REARING carbonate chemistry - melt to long form}

# change to long format to properly facet
F1_CarbChem_REARING_long <- F1_CarbChem_REARING_means %>% 
                                  reshape2::melt(id.vars=c('Date', 'Treatment'))


# get the mean. sd. and se for all the data - not ethat an N = 3 for the Date
# these data are already in the mean wihtin day (by N=3 replicates) - run this by the team if they 
# want otherwise (summary - preents a mean of a mean, from a mena witin day (replicate tank) and across days)
F1_CarbChem_REARING_longMEANS <- F1_CarbChem_REARING_long %>% # calc means and standard error
                                         na.omit() %>% 
                                         dplyr::group_by(Treatment, variable) %>% 
                                         dplyr::summarise(mean = mean(value),
                                                          sd   = sd(value),
                                                          se   = sd/(sqrt(n())) ,
                                                          n = n())



# cast to wide format

F1_CarbChem_REARING_wideMEANS <- reshape2::dcast(F1_CarbChem_REARING_longMEANS, Treatment ~ variable, value.var="mean")
F1_CarbChem_REARING_wideStErr <- reshape2::dcast(F1_CarbChem_REARING_longMEANS, Treatment ~ variable, value.var="se")
F1_CarbChem_REARING_wideN     <- reshape2::dcast(F1_CarbChem_REARING_longMEANS, Treatment ~ variable, value.var="n")

colnames(F1_CarbChem_REARING_wideMEANS)

# final table

F1_CarbChem_REARING_wideMEANS <- F1_CarbChem_REARING_wideMEANS %>% arrange(desc(WAr))

FINAL_TABLE                <- data.frame(matrix(nrow = nrow(F1_CarbChem_REARING_wideMEANS), ncol = 1))


FINAL_TABLE$pCO2_treatment <- F1_CarbChem_REARING_wideMEANS$Treatment


FINAL_TABLE$pH             <- paste( (paste( (signif(F1_CarbChem_REARING_wideMEANS$pH, digits=5)),
                                     (signif(F1_CarbChem_REARING_wideStErr$pH, digits=3)), sep=" ± ")),
                                     " (",
                                     F1_CarbChem_REARING_wideN$pH,
                                     ")",
                                     sep = "")

FINAL_TABLE$Salinity       <-  paste( (paste( (signif(F1_CarbChem_REARING_wideMEANS$Salinity, digits=4)),
                                     (signif(F1_CarbChem_REARING_wideStErr$Salinity, digits=1)), sep=" ± ")),
                                     " (",
                                     F1_CarbChem_REARING_wideN$Salinity,
                                     ")",
                                     sep = "")

FINAL_TABLE$Temperature    <- paste( (paste( (signif(F1_CarbChem_REARING_wideMEANS$Temperature, digits=3)),
                                     (signif(F1_CarbChem_REARING_wideStErr$Temperature, digits=1)), sep=" ± ")),
                                     " (",
                                     F1_CarbChem_REARING_wideN$Temperature,
                                     ")",
                                     sep = "")


FINAL_TABLE$pH_measured    <- paste( (paste( (signif(F1_CarbChem_REARING_wideMEANS$pH_measured, digits=5)),
                                     (signif(F1_CarbChem_REARING_wideStErr$pH_measured, digits=3)), sep=" ± ")),
                                     " (",
                                     F1_CarbChem_REARING_wideN$pH_measured,
                                     ")",
                                     sep = "")


FINAL_TABLE$TA             <- paste( (paste( (signif(F1_CarbChem_REARING_wideMEANS$TA_mmol_kgSW, digits=6)),
                                     (signif(F1_CarbChem_REARING_wideStErr$TA_mmol_kgSW, digits=4)), sep=" ± ")),
                                     " (",
                                     F1_CarbChem_REARING_wideN$TA_mmol_kgSW,
                                     ")",
                                     sep = "")

FINAL_TABLE$pCO2           <-  paste( (paste( (signif(F1_CarbChem_REARING_wideMEANS$pCO2, digits=3)),
                                     (signif(F1_CarbChem_REARING_wideStErr$pCO2, digits=2)), sep=" ± ")),
                                     " (",
                                     F1_CarbChem_REARING_wideN$pCO2,
                                     ")",
                                     sep = "")

FINAL_TABLE$Calcite.sat             <- paste( (paste( (signif(F1_CarbChem_REARING_wideMEANS$WCa, digits=6)),
                                     (signif(F1_CarbChem_REARING_wideStErr$WCa, digits=4)), sep=" ± ")),
                                     " (",
                                     F1_CarbChem_REARING_wideN$WCa,
                                     ")",
                                     sep = "")

FINAL_TABLE$Aragonite.Sat  <-  paste( (paste( (signif(F1_CarbChem_REARING_wideMEANS$WAr, digits=3)),
                                     (signif(F1_CarbChem_REARING_wideStErr$WAr, digits=3)), sep=" ± ")),
                                     " (",
                                     F1_CarbChem_REARING_wideN$WAr,
                                     ")",
                                     sep = "")

FINAL_TABLE                <- FINAL_TABLE[,-1] %>%  # view table
                                  dplyr::mutate(pCO2_treatment = case_when(pCO2_treatment == '8' ~ 'Low',
                                                                           pCO2_treatment == '7.5' ~ 'Moderate'))


```

```{r F1 REARING carbonate chemistry - output table}
library(knitr)
library(kableExtra)
FINAL_TABLE %>%
  kbl(caption = "Table 1. Seawater chemistry") %>%
  kable_classic(full_width = T, html_font = "Cambria")


# save output table
write.table(F1_CarbChem_REARING_longMEANS,"Output/SeawaterChemistry/Tables/Means_CarbChem_F1_Rearing.csv",sep=",", row.names=FALSE)  # write table to 
write.table(FINAL_TABLE,"Output/SeawaterChemistry/Tables/Summary_F1_Rearing.csv",sep=",", row.names=FALSE, fileEncoding = "latin1")  # write table to 


```