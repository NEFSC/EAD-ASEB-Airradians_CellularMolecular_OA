---
title: "Gill_ATP_analysis"
author: "Samuel Gurr"
date: "2023-08-28"
output: html_notebook
---

-   Last updates: August 28, 2023

# OA Reexposure Challenge

### May 2023: F2 Adult Bay scallops exposed to a two-week full-reciprocal pCO2 challenge

### Objective: plot and analyze ATP colorimetric data from snap frozen gill tissue 

## Load Libraries

```{r setup, include=TRUE}

# library(lmtest) # to receive p value from betareg model
# library(FSA) # for the Dun test post hoc for SRH non-parametric 2 way anova]
# library(emmeans)
library(ggplot2)
library(dplyr)
library(tidyverse)
library(car)
# library(lmerTest)
library(tidyr)
# library(reshape2)
library(ggpubr)
# library(nlme)
# library(rcompanion) # to run the Schrier -Ray-Hare non parametric 2 way 
library(ggpmisc) # stat_poly for inserting equation and R2 for ggplot line 
knitr::opts_knit$set(root.dir = "C:/Users/samjg/Documents/Github_repositories/Airradians_CellularMolecular_OA/RAnalysis") # sets the working directory for the entire R markdown file - no need to reload the wd
```

## Load colorimetric datasets

* ATP assay kits
```{r load ATP assay data}
# Ran on 20230828 - Plate 1 
raw_0828_plate1      <- read.csv(file="Data/Colorimetric_assays/ATP/Runs_20230828/Plate_1/20230828_ATP_Plate1.csv",
                          sep = ",",
                          skip=2,
                          header=TRUE,
                          fileEncoding="latin1")
raw_0828_plate1_mtx  <- as.matrix(raw_0828_plate1[c(1:8),c(3:14)])
colnames(raw_0828_plate1_mtx) = c("1","2","3","4","5","6","7","8","9","10","11","12")
rownames(raw_0828_plate1_mtx) = c("A","B","C","D","E","F","G","H")
raw_0828_plate1_table <- as.data.frame.table(raw_0828_plate1_mtx, responseName = "value") %>% 
                            dplyr::rename(well_row=Var1, well_column=Var2, Abs_570nm=value) %>% 
                            dplyr::mutate(well=paste0(well_row,well_column),
                                          Run_date ="20230828",
                                          Plate="1") %>% 
                            dplyr::select(-c(well_row,well_column))

# Ran on 20230828 - Plate 1, the sceond run about 5  minuts after the first, as "1.2" (20230828_ATP_Plate1_second_run.csv)
raw_0828_plate1.2      <- read.csv(file="Data/Colorimetric_assays/ATP/Runs_20230828/Plate_1/20230828_ATP_Plate1_second_run.csv",
                          sep = ",",
                          skip=2,
                          header=TRUE,
                          fileEncoding="latin1")
raw_0828_plate1.2_mtx  <- as.matrix(raw_0828_plate1.2[c(1:8),c(3:14)])
colnames(raw_0828_plate1.2_mtx) = c("1","2","3","4","5","6","7","8","9","10","11","12")
rownames(raw_0828_plate1.2_mtx) = c("A","B","C","D","E","F","G","H")
raw_0828_plate1.2_table <- as.data.frame.table(raw_0828_plate1.2_mtx, responseName = "value") %>% 
                            dplyr::rename(well_row=Var1, well_column=Var2, Abs_570nm=value) %>% 
                            dplyr::mutate(well=paste0(well_row,well_column),
                                          Run_date ="20230828",
                                          Plate="1.2") %>% 
                            dplyr::select(-c(well_row,well_column))

# Ran on 20230828 - Plate 2 
raw_0828_plate2      <- read.csv(file="Data/Colorimetric_assays/ATP/Runs_20230828/Plate_2/20230828_ATP_Plate2.csv",
                          sep = ",",
                          skip=2,
                          header=TRUE,
                          fileEncoding="latin1")
raw_0828_plate2_mtx  <- as.matrix(raw_0828_plate2[c(1:8),c(3:14)])
colnames(raw_0828_plate2_mtx) = c("1","2","3","4","5","6","7","8","9","10","11","12")
rownames(raw_0828_plate2_mtx) = c("A","B","C","D","E","F","G","H")
raw_0828_plate2_table <- as.data.frame.table(raw_0828_plate2_mtx, responseName = "value") %>% 
                            dplyr::rename(well_row=Var1, well_column=Var2, Abs_570nm=value) %>% 
                            dplyr::mutate(well=paste0(well_row,well_column),
                                          Run_date ="20230828",
                                          Plate="2") %>% 
                            dplyr::select(-c(well_row,well_column))

# Ran on 20230829 - Plate 1 
raw_0829_plate1      <- read.csv(file="Data/Colorimetric_assays/ATP/Runs_20230829/Plate_1/20230829_ATP_Plate1.csv",
                          sep = ",",
                          skip=2,
                          header=TRUE,
                          fileEncoding="latin1")
raw_0829_plate1_mtx  <- as.matrix(raw_0829_plate1[c(1:8),c(3:14)])
colnames(raw_0829_plate1_mtx) = c("1","2","3","4","5","6","7","8","9","10","11","12")
rownames(raw_0829_plate1_mtx) = c("A","B","C","D","E","F","G","H")
raw_0829_plate1_table <- as.data.frame.table(raw_0829_plate1_mtx, responseName = "value") %>% 
                            dplyr::rename(well_row=Var1, well_column=Var2, Abs_570nm=value) %>% 
                            dplyr::mutate(well=paste0(well_row,well_column),
                                          Run_date ="20230829",
                                          Plate="1") %>% 
                            dplyr::select(-c(well_row,well_column))


# load metadata

metadata      <- read.csv(file="Data/Colorimetric_assays/ATP/Metadata_ATP_assays.csv",
                          sep = ",",
                          header=TRUE)

# merge the rbind of all raw data with the metadat 
raw_ATP <- merge( (rbind(raw_0828_plate1_table, 
                         raw_0828_plate2_table,
                         raw_0829_plate1_table)),
                  (metadata %>% dplyr::select(!Notes)) )

# write csv
write.csv(raw_ATP, file = "Data/Colorimetric_assays/ATP/Raw_Master_ATP.csv")

```


* Load BCA Total Protein assay kits
```{r load BCA assay data}
# Ran on 20230829 - Plate 1 
BCA_0829_plate1      <- read.csv(file="Data/Colorimetric_assays/BCA_ATPcorrection/Runs_20230829/Plate_1/20230829_BCA_ATPcorrection_Plate1.csv",
                          sep = ",",
                          skip=2,
                          header=TRUE,
                          fileEncoding="latin1")
BCA_0829_plate1_mtx  <- as.matrix(BCA_0829_plate1[c(1:8),c(3:14)])
colnames(BCA_0829_plate1_mtx) = c("1","2","3","4","5","6","7","8","9","10","11","12")
rownames(BCA_0829_plate1_mtx) = c("A","B","C","D","E","F","G","H")
BCA_0829_plate1_table <- as.data.frame.table(BCA_0829_plate1_mtx, responseName = "value") %>% 
                            dplyr::rename(well_row=Var1, well_column=Var2, Abs_562nm=value) %>% 
                            dplyr::mutate(well=paste0(well_row,well_column),
                                          Run_date ="20230829",
                                          Plate="1") %>% 
                            dplyr::select(-c(well_row,well_column))

# Ran on 20230829 - Plate 2
BCA_0829_plate2      <- read.csv(file="Data/Colorimetric_assays/BCA_ATPcorrection/Runs_20230829/Plate_2/20230829_BCA_ATPcorrection_Plate2.csv",
                          sep = ",",
                          skip=2,
                          header=TRUE,
                          fileEncoding="latin1")
BCA_0829_plate2_mtx  <- as.matrix(BCA_0829_plate2[c(1:8),c(3:14)])
colnames(BCA_0829_plate2_mtx) = c("1","2","3","4","5","6","7","8","9","10","11","12")
rownames(BCA_0829_plate2_mtx) = c("A","B","C","D","E","F","G","H")
BCA_0829_plate2_table <- as.data.frame.table(BCA_0829_plate2_mtx, responseName = "value") %>% 
                            dplyr::rename(well_row=Var1, well_column=Var2, Abs_562nm=value) %>% 
                            dplyr::mutate(well=paste0(well_row,well_column),
                                          Run_date ="20230829",
                                          Plate="2") %>% 
                            dplyr::select(-c(well_row,well_column))

# load metadata

metadata_BCA <- read.csv(file="Data/Colorimetric_assays/BCA_ATPcorrection/Metadata_BCA_ATPcorrection.csv",
                          sep = ",",
                          header=TRUE)

# merge the rbind of all raw data with the metadat 
raw_BCA <- merge( (rbind(BCA_0829_plate1_table, 
                         BCA_0829_plate2_table)),
                  metadata_BCA)


# write csv
write.csv(raw_BCA, file = "Data/Colorimetric_assays/BCA_ATPcorrection/Raw_Master_BCA_ATPcorrection.csv")

```


* Load Experiment metadata - merge with the loaded raw colorimetric data

```{r load Experimentl metadata}
Exp_metadata      <- read.csv(file="Data/Experiment_metadata.csv",sep = ",",header=TRUE)
```

# Finalize BCA data 

- Objs: 

  * (1) Merge by the common 'Scallop_ID' and retain all rows in the colorimetric data (all=T)
  - Why? We unfortunately found that that the dewar was not properly unloaded 
  on day 14 of the experiment, below we can reveal replicates that were lost (hence 'NAs' via merge below)
  
  * (2) omit NAs - empty wells (no sample or standard)
  
  * (3) separate standards from samples
  
  * (4) Run standard curve, calculate totalprotein
  
  * (5) Calculate total protien; subtract out background + correct for standard curve +  average
  
```{r Total protein data}
# * (1) Merge by the common 'Scallop_ID' and retain all rows in the colorimetric data (all=T)
# - Why? We unfortunately found that that the dewar was not properly unloaded 
# on day 14 of the experiment, below we can reveal replicates that were lost (hence 'NAs' via merge below)
raw_BCA_merged    <- merge(raw_BCA, Exp_metadata, by='Scallop_ID',all=TRUE)
View(raw_BCA_merged)
lost_gill_samples <- raw_BCA_merged %>% dplyr::filter(Abs_562nm %in% NA)
nrow(lost_gill_samples) # 29 -NOTE: NOT ALL of these were lost, some due to low yield of supernatant to run,
# the true value for lost samples 
  


# * (2) ommit NAs - empty wells (no sample or standard)
raw_BCA_merged_om <- raw_BCA_merged %>% dplyr::filter(!Type %in% NA)
 
View(raw_BCA_merged_om)

# * (3) separate standards from samples, format the standards
BCA_standards <- raw_BCA_merged_om %>% 
                    dplyr::filter(grepl('Standard', Type)) %>% # grepl for 'contains' string
                    dplyr::mutate(BCA_ug_mL = 
                                    as.numeric(gsub('.*_','',Type))) %>% # (i.e. 25 in 'Standards_25')
                    dplyr::mutate(Unique_ID = paste0('Plate_',Plate,'_', Type))



# * (4) Run standard curve, calculate totalprotein 
BCA_background_zero <- BCA_standards %>% 
                        dplyr::filter(Type %in% 'Standard_0') %>% 
                        dplyr::select(Unique_ID,Plate, BCA_ug_mL,Abs_562nm) %>% # select columns of interest
                        dplyr::group_by(Unique_ID, Plate, BCA_ug_mL) %>% # group by to get the means
                        dplyr::summarise_each(funs(mean,sd,se=sd(.)/sqrt(n()))) # get all the stats 
# Plate 1, blank to correct by is 0.08355
# Plate 2, blank to correct by is 0.08090

BCA_standards_means <- BCA_standards %>% 
                        #dplyr::filter(!Type %in% 'Standard_0') %>% 
                        dplyr::mutate(Abs_562nm_cor = 
                                     case_when(Plate == 1 ~ (Abs_562nm-0.08355),
                                               Plate == 2 ~ (Abs_562nm-0.08090) ) ) %>% 
                        dplyr::select(Unique_ID, Plate, BCA_ug_mL, Abs_562nm_cor) %>% # select columns 
                        dplyr::group_by(Unique_ID, Plate, BCA_ug_mL) %>% # group by to get the means
                        dplyr::summarise_each(funs(mean,sd,se=sd(.)/sqrt(n()))) # get all the stats 

BCA_stand_plots_quadratic <- BCA_standards_means %>% # QUADRATIC SMOOTH LINE WORKS BEST HERE (MANUFACTURERS INSTRUCTIONS)
                     dplyr::filter(!BCA_ug_mL %in% 25) %>% # hash me out to test
                     ggplot(aes(y=mean, x=BCA_ug_mL)) + 
                        geom_point() +
                        theme_bw() +
                        labs(y= "Net Absorbance at 562nm", x = "Protein Concentration in ug/mL") +
                        #geom_line() +
                        #stat_poly_line(color='red') +
                        #geom_smooth() +
                        stat_smooth(method = "lm", formula = y ~ x + I(x^2), size = 1) +
                        stat_poly_eq(parse=T, aes(label = ..eq.label..), formula=y ~ x + I(x^2)) +
                        ggtitle('Quadratic') +
                        #stat_poly_eq(use_label(c("eq", "R2"))) +
                        facet_wrap(~Plate) 

# NOTE! I found that some of my discriminants are negative (b^2 - 4ac) so Im going to extrapolate from a linear 
# curve based on the last few standards
BCA_stand_plots_linear <- BCA_standards_means %>% # QUADRATIC SMOOTH LINE WORKS BEST HERE (MANUFACTURERS INSTRUCTIONS)
                     dplyr::filter(!BCA_ug_mL %in% c('0','25','125','250','500')) %>% # hash me out to test
                     ggplot(aes(y=mean, x=BCA_ug_mL)) + 
                        geom_point() +
                        theme_bw() +
                        labs(y= "Net Absorbance at 562nm", x = "Protein Concentration in ug/mL") +
                        #geom_line() +
                        #stat_poly_line(color='red') +
                        #geom_smooth() +
                        stat_smooth(method = "lm", formula = y ~ x, size = 1) +
                        stat_poly_eq(parse=T, aes(label = ..eq.label..), formula=y ~ x) +
                        ggtitle('Linear - for negative desriminant') +
                        #stat_poly_eq(use_label(c("eq", "R2"))) +
                        facet_wrap(~Plate) 


#print
pdf(paste("Data/Colorimetric_assays/BCA_ATPcorrection/Standard_Curve_BCA_ATPcorrection.pdf", sep =''), 
    width=10, 
    height=7)
print(ggarrange(BCA_stand_plots_quadratic,BCA_stand_plots_linear))
dev.off()

# Standard curve, Plate 1 equation y = 0.0347 + 0.00127x - 1.01x10^-7x^2 - need to solve for x!
# Standard curve, Plate 2 equation y = 0.045 + 0.00125x - 1.3x10^-7x^2 - need to solve for x!


# * (5) Calculate Total protein per sample; subtract out background + correct for standard curve +  average

# Again, Plate 1 blank to correct by is 0.08355
# Again, Plate 2 blank to correct by is 0.08090

# Standard curve, Plate 1
a1 <- -1.01*10^-7
b1 <- 0.00127
c1 <- 0.0347
# EQ: (-(b1) + sqrt( (b1^2) - (4*(((a1)-Abs_562nm_cor))*(c1)) ))/(2*a1)

# Standard curve, Plate 2
a2 <- -1.3*10^-7
b2 <- 0.00125
c2 <- 0.045
# EQ: (-(b2) + sqrt( (b2^2) - (4*a2*(c2-Abs_562nm_cor)) ) ) / (2*a2)


# linear equation plate 1 == (Abs_562nm_cor - 0.192)/0.000993
# linear equation plate 2 == (Abs_562nm_cor - 0.224)/0.000911


# IMPORTANT! we used 25 ul of the standards and 25 ul of the unknowns (samples) 
# therefore we can interpret the unknown direct to the the standard curve without having 
# to account for addition factors, fot example, if we used 5 ul unknown (sample) we would have to adjust 
# by multiplying by 5 to reach the standard curve 

V = 0.025 # 25 ul or 0.025 mL

TotalProtein_final <- raw_BCA_merged_om %>% 
                      dplyr::filter(Type %in% 'Sample') %>% # call samples
                      dplyr::mutate(Unique_ID = 
                                      paste0('Plate_',Plate,'_', Scallop_ID)) %>% # unique ID t0 group by
                      dplyr::mutate(Abs_562nm_cor = # correct the raw abs, subtract background
                                   case_when(Plate == 1 ~ (Abs_562nm-0.08355), # for plate 1
                                             Plate == 2 ~ (Abs_562nm-0.08090) ) ) %>% # for plate 2 
                      dplyr::mutate(TotalProtein_ug_mL = 
                                    case_when(
                                      Scallop_ID %in% c(33, 51) ~ ((Abs_562nm_cor - 0.224)/0.000911), #linear fr neg discrim. - luckily only two values from plate 2
                                      Plate == 1 ~ ((-(b1) + sqrt( (b1^2) - (4*a1*(c1-Abs_562nm_cor)) ) ) / (2*a1)), # quadratic for Plate 1
                                      Plate == 2 | Scallop_ID != c(33, 51) ~ ((-(b2) + sqrt( (b2^2) - (4*a2*(c2-Abs_562nm_cor)) ) ) / (2*a2))  # quadratic for plate 2 
                                              ),
                                    TotalProtein_ug = TotalProtein_ug_mL*V) %>% # ug per mL concentration to ug in 25 ul sample 
                      dplyr::group_by(Day,pCO2_history,pCO2_exposure,
                                      Unique_ID, Plate, Scallop_ID) %>% # group by to get the means
                      dplyr::summarise(mean_TotalProtein_ug = mean(TotalProtein_ug),
                                       sd_TotalProtein_ug   = sd(TotalProtein_ug),
                                       n = n(),
                                       se_TotalProtein_ug  = sd_TotalProtein_ug / sqrt(n))

View(TotalProtein_final)
# write csv
write.csv(TotalProtein_final, file = "Data/Colorimetric_assays/BCA_ATPcorrection/Calc_Master_BCA_ATPcorrection.csv")


```


# Finalize ATP data 

- Objs: 

  * (1) Merge by the common 'Scallop_ID' and retain all rows in the colorimetric data (all=T)
  - Why? We unfortunately found that that the dewar was not properly unloaded 
  on day 14 of the experiment, below we can reveal replicates that were lost (hence 'NAs' via merge below)
  
  * (2) omit NAs - empty wells (no sample or standard)
  
  * (3) separate standards from samples
  
  * (4) Run standard curve, calculate totalprotein
  
  * (5) Calculate ATP; subtract out background + correct for standard curve +  average +
  
  
```{r ATP data}
# * (1) Merge by the common 'Scallop_ID' and retain all rows in the colorimetric data (all=T)
# - Why? We unfortunately found that that the dewar was not properly unloaded 
# on day 14 of the experiment, below we can reveal replicates that were lost (hence 'NAs' via merge below)
raw_ATP_merged    <- merge(raw_ATP, Exp_metadata, by='Scallop_ID', all=TRUE)

lost_gill_samples <- raw_ATP_merged %>% dplyr::filter(Abs_570nm %in% NA)
nrow(lost_gill_samples) # 26 samples lost
  


# * (2) ommit NAs - empty wells (no sample or standard)
raw_ATP_merged_om <- raw_ATP_merged %>% dplyr::filter(!Type %in% NA)
 


# * (3) separate standards from samples, format the standards
ATP_standards <- raw_ATP_merged_om %>% 
                    dplyr::filter(grepl('Standard', Type)) %>% # grepl for 'contains' string
                    dplyr::mutate(ATP_nmol = 
                                    as.numeric(gsub('.*_','',Type))) %>% # (i.e. 25 in 'Standards_25')
                    dplyr::mutate(Unique_ID = paste0(Run_date,'_', Type))



# * (4) Run standard curve, calculate totalprotein 
ATP_background_zero <- ATP_standards %>% 
                        dplyr::filter(Type %in% 'Standard_0') %>% 
                        dplyr::select(Unique_ID, Run_date, ATP_nmol, Abs_570nm) %>% # select columns of interest
                        dplyr::group_by(Unique_ID, Run_date, ATP_nmol) %>% # group by to get the means
                        dplyr::summarise_each(funs(mean,sd,se=sd(.)/sqrt(n()))) # get all the stats 
# Run_date 20230828, blank to correct by is 0.04675
# Run_date 20230829, blank to correct by is 0.04680

ATP_standards_means <- ATP_standards %>% 
                        #dplyr::filter(!Type %in% 'Standard_0') %>% 
                        dplyr::mutate(Abs_570nm_cor = 
                                     case_when(Run_date == 20230828 ~ (Abs_570nm-0.04675),
                                               Run_date == 20230829 ~ (Abs_570nm-0.04680) ) ) %>% 
                        dplyr::select(Unique_ID, Run_date, ATP_nmol, Abs_570nm_cor) %>% # select columns 
                        dplyr::group_by(Unique_ID, Run_date, ATP_nmol) %>% # group by to get the means
                        dplyr::summarise_each(funs(mean,sd,se=sd(.)/sqrt(n()))) # get all the stats 

ATP_stand_plots <- ATP_standards_means %>% # LINEAR WORKS WELL
                     #dplyr::filter(!ATP_nmol %in% 0) %>%  # ommit zeros
                     ggplot(aes(y=mean, x=ATP_nmol)) + 
                        geom_point() +
                        theme_bw() +
                        #geom_line() +
                        stat_poly_line() +
                        labs(y= "OD 570nm", x = "ATP (nmol, known standards)") +
                        stat_poly_eq(use_label(c("eq", "R2"))) +
                        facet_wrap(~Run_date) 

#print
pdf(paste("Data/Colorimetric_assays/ATP/Standard_Curve_ATP.pdf", sep =''), 
    width=10, 
    height=7)
print(ATP_stand_plots)
dev.off()

# Run_date 20230828, y = 0.0385x - 0.0114 
# Run_date 20230829, y = 0.0994x - 0.0249 



# * (5) Calculate Total protein per sample; subtract out background + correct for standard curve +  average
# Background correction, Run_date 20230828, blank to correct by is 0.04675
# Background correction, Run_date 20230829, blank to correct by is 0.04680

# Standard curve, Run_date 20230828, x = ((Abs_570nm + 0.0114)/0.0385) - NOTE, below we have OD and are solving for x (ATP nmol)
# Standard curve, Run_date 20230829, x = ((Abs_570nm + 0.0249)/0.0994) - NOTE, below we have OD and are solving for x (ATP nmol)


# ATP concentration = (B/V * D) * DDF
# * B = the concentration in nmol ATP from the standard curve 
# * V = the volume added to each well 
# * D = dilution volume if sample was diluted to fit the curve (d/n apply here)
# * DDF = the deproteinization dilution factor LOOK THIS OVER WE ADDED 25 ul TO THE SAMPLE

V = 0.0005 # 50 in ul; as liters = 0.0005
# side note: ATP molecular weight = 507.18 g/mol

# IMPORTANT! we used 50 ul of the standards and 50 ul of the unknowns (samples) 
# therefore we can interpret the unknown direct to the the standard curve without having 
# to account for addition factors in order to infer nmol concentration

ATP_final <- raw_ATP_merged_om %>% 
                      dplyr::filter(Type %in% 'Sample') %>% # call samples
                      dplyr::mutate(Unique_ID = 
                                      paste0(Run_date,'_', Type, Scallop_ID)) %>% # unique ID t0 group by
                      dplyr::mutate(Abs_570nm_cor = # correct the raw abs, subtract background
                                   case_when(Run_date == 20230828 ~ (Abs_570nm-0.04675), # for plate 1
                                             Run_date == 20230829 ~ (Abs_570nm-0.04680) ) ) %>% # for plate 2 
                      dplyr::mutate(ATP_nmol = # correct the raw abs, subtract background
                                    case_when(Run_date == 20230828 ~ ((Abs_570nm + 0.0114)/0.0385), # for plate 1 - nmol to umol by div 1000
                                              Run_date == 20230829 ~ ((Abs_570nm + 0.0249)/0.0994) ) )  %>% # for plate 2 - nmol to umol by div 1000
                      dplyr::group_by(Day,pCO2_history,pCO2_exposure,
                                      Unique_ID, Run_date, Scallop_ID) %>% # group by to get the means
                      dplyr::summarise(mean_ATP_nmol = mean(ATP_nmol),
                                       sd_ATP_nmol   = sd(ATP_nmol),
                                       n = n(),
                                       se_ATP_nmol   = sd_ATP_nmol / sqrt(n))
# write csv
write.csv(ATP_final, file = "Data/Colorimetric_assays/ATP/Calc_Master_ATP.csv")

```


Finally we are here... the moment of truth! 

# MERGE ATP WITH TOTAL PROTEIN DATA 
```{r}
ATP_final_prepmerge    <- ATP_final[,c(1:3,6,7)]
TotalProtein_prepmerge <- TotalProtein_final[,c(1:3,6,7)]

# IMPORTANT! the ATP assay used 50 ul sample whereas BCA used 25 ul of sample
# therefore to relate ATP to total protein we must divide ATP by 2

MERGED_DF <- merge(ATP_final_prepmerge, 
                   TotalProtein_prepmerge, 
                   all=T)  %>% # looks like we have 3 absent values for total protein..
                dplyr::mutate(ATP_nmol_ug_protein = (mean_ATP_nmol/2)/mean_TotalProtein_ug)
View(MERGED_DF) # view the file for any NAs


# IMPORTANT! three individuals did not have enough supernatant to run total protein, listed below as NAs
# Day 1 ID 24 (low history x severe exposure)
# Day 1 ID 35 (moderate history x low exposure)
# Day 14 ID 67 (severe history x low exposure)
MERGED_DF %>% dplyr::filter(ATP_nmol_ug_protein %in% NA)

# lets see the mean_TotalProtein_ug for these treatments  
aggregate(MERGED_DF$mean_TotalProtein_ug, list(MERGED_DF$Day, 
                                               MERGED_DF$pCO2_history,
                                               MERGED_DF$pCO2_exposure
                                               ), FUN=mean, na.rm=TRUE)
# 1	severe	low == 	1.0833254	(for ID 24)
# 1	moderate	low	== 0.9582917 (for ID 35)
# 14	severe	low	== 0.8076951  (for ID 67)

MASTER_DF <- merge(ATP_final_prepmerge, 
                   TotalProtein_prepmerge, 
                   all=T)  %>% # looks like we have 3 absent values for total protein..
                dplyr::mutate(mean_TotalProtein_ug = 
                                case_when(
                                  Scallop_ID %in% 24 ~ 1.0833254,
                                  Scallop_ID %in% 35 ~ 0.9582917,
                                  Scallop_ID %in% 67 ~ 0.8076951,
                                  TRUE ~ mean_TotalProtein_ug),
                              ATP_nmol_ug_protein = (mean_ATP_nmol/2)/mean_TotalProtein_ug)

View(MASTER_DF)
# write csv
write.csv(MASTER_DF, file = "Data/Colorimetric_assays/ATP_Master.csv")

```

# FIGURES 


```{r}

MASTER_DF <- read.csv(file = "Data/Colorimetric_assays/ATP_Master.csv", head = T)

ggplot(MASTER_DF, aes(mean_ATP_nmol,mean_TotalProtein_ug)) +
  geom_point() +
  stat_smooth(method = "lm", formula = y ~ x, size = 1) +
  theme_bw() +
  facet_wrap(~pCO2_history)

ggplot(MASTER_DF, aes(mean_ATP_nmol,mean_TotalProtein_ug)) +
  geom_point()+
  stat_smooth(method = "lm", formula = y ~ x, size = 1) +
  theme_bw() +
  facet_wrap(~pCO2_exposure)

```
* ATP (corrected for total protein)
```{r}
MASTER_DF <- read.csv(file = "Data/Colorimetric_assays/ATP_Master.csv", head = T)

Day1_ATP_RxnNorm <- MASTER_DF %>% # data %>%
  dplyr::filter(Day == 1) %>% # filter for desired date of rhte experiment
  dplyr::mutate(ATP_nmol_ug_protein = as.numeric(ATP_nmol_ug_protein)) %>% 
  dplyr::select(c('Day','pCO2_exposure','pCO2_history','ATP_nmol_ug_protein')) %>% 
  na.omit() %>%   
  # we have means (from x2 assay reps per individual), now mean by treatment!
  group_by(pCO2_exposure, pCO2_history) %>% # group by columns for treatment
  dplyr::summarise( # summarise to acquire the mean and SE for plotting
    ATP_mean = mean(ATP_nmol_ug_protein), # mean
    ATP_sd = sd(ATP_nmol_ug_protein), # sd
    ATP_n = n(), # count
    ATP_se = ATP_sd / sqrt(ATP_n)) %>% # SE
  # plot it
  ggplot(aes(x=pCO2_exposure, y=ATP_mean, group=pCO2_history)) + # call the new mean
    geom_line(aes(group = factor(pCO2_history), 
                  linetype = pCO2_history), 
              size = 0.5, 
              position=position_dodge(.4)) +  # connect a line between variables
    scale_linetype_manual(values=c("solid", "dashed", "dotted")) +
    geom_point(aes(shape=pCO2_history, fill=pCO2_history), size = 4.5,position=position_dodge(.4)) + 
    scale_shape_manual(values=c(21, 22, 24)) + # filled circle, filled triangle, and X 
    scale_fill_manual(values=c("#009E73","#E69F00", "#CC79A7")) + # fill circles
    geom_errorbar(aes(ymin=(ATP_mean)-(ATP_se), # new means and se by treatment
                      ymax=(ATP_mean)+(ATP_se)), # new means and se by treatment
                  width=0,position=position_dodge(.4)) + # width determines the length of the end ticks
    theme_classic() +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "none") + 
    ggtitle("ATP, Day 1") +
    scale_y_continuous(expand = c(0, 0), limits = c(0, 2.5)) + # true 0 origin
    labs(y= "ATP (umol ug protein-1)", x = "pCO2 Exposure")
Day1_ATP_RxnNorm # view the plot


Day14_ATP_RxnNorm <- MASTER_DF %>% # data %>%
  dplyr::filter(Day == 14) %>% # filter for desired date of rhte experiment
  dplyr::mutate(ATP_nmol_ug_protein = as.numeric(ATP_nmol_ug_protein)) %>% 
  dplyr::select(c('Day','pCO2_exposure','pCO2_history','ATP_nmol_ug_protein')) %>% 
  na.omit() %>%   
  # we have means (from x2 assay reps per individual), now mean by treatment!
  group_by(pCO2_exposure, pCO2_history) %>% # group by columns for treatment
  dplyr::summarise( # summarise to acquire the mean and SE for plotting
    ATP_mean = mean(ATP_nmol_ug_protein), # mean
    ATP_sd = sd(ATP_nmol_ug_protein), # sd
    ATP_n = n(), # count
    ATP_se = ATP_sd / sqrt(ATP_n)) %>% # SE
  # plot it
  ggplot(aes(x=pCO2_exposure, y=ATP_mean, group=pCO2_history)) + # call the new mean
    geom_line(aes(group = factor(pCO2_history), 
                  linetype = pCO2_history), 
              size = 0.5, 
              position=position_dodge(.4)) +  # connect a line between variables
    scale_linetype_manual(values=c("solid", "dashed", "dotted")) +
    geom_point(aes(shape=pCO2_history, fill=pCO2_history), size = 4.5,position=position_dodge(.4)) + 
    scale_shape_manual(values=c(21, 22, 24)) + # filled circle, filled triangle, and X 
    scale_fill_manual(values=c("#009E73","#E69F00", "#CC79A7")) + # fill circles
    geom_errorbar(aes(ymin=(ATP_mean)-(ATP_se), # new means and se by treatment
                      ymax=(ATP_mean)+(ATP_se)), # new means and se by treatment
                  width=0,position=position_dodge(.4)) + # width determines the length of the end ticks
    theme_classic() +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "none") + 
    ggtitle("ATP, Day 14") +
    scale_y_continuous(expand = c(0, 0), limits = c(0, 2.5)) + # true 0 origin
    labs(y= "ATP (umol ug protein-1)", x = "pCO2 Exposure")
Day14_ATP_RxnNorm # view the plot

ggarrange(Day1_ATP_RxnNorm,Day14_ATP_RxnNorm, ncol=2)
```


* Total Protein 
```{r}

MASTER_DF <- read.csv(file = "Data/Colorimetric_assays/ATP_Master.csv", head = T)


Day1_TotalProtein_RxnNorm <- MASTER_DF %>% # data %>%
  dplyr::filter(Day == 1) %>% # filter for desired date of rhte experiment
  dplyr::mutate(mean_TotalProtein_ug = as.numeric(mean_TotalProtein_ug)) %>% 
  dplyr::select(c('Day','pCO2_exposure','pCO2_history','mean_TotalProtein_ug')) %>% 
  na.omit() %>%   
  # we have means (from x2 assay reps per individual), now mean by treatment!
  group_by(pCO2_exposure, pCO2_history) %>% # group by columns for treatment
  dplyr::summarise( # summarise to acquire the mean and SE for plotting
    TP_mean = mean(mean_TotalProtein_ug), # mean
    TP_sd = sd(mean_TotalProtein_ug), # sd
    TP_n = n(), # count
    TP_se = TP_sd / sqrt(TP_n)) %>% # SE
  # plot it
  ggplot(aes(x=pCO2_exposure, y=TP_mean, group=pCO2_history)) + # call the new mean
    geom_line(aes(group = factor(pCO2_history), 
                  linetype = pCO2_history), 
              size = 0.5, 
              position=position_dodge(.4)) +  # connect a line between variables
    scale_linetype_manual(values=c("solid", "dashed", "dotted")) +
    geom_point(aes(shape=pCO2_history, fill=pCO2_history), size = 4.5,position=position_dodge(.4)) + 
    scale_shape_manual(values=c(21, 22, 24)) + # filled circle, filled triangle, and X 
    scale_fill_manual(values=c("#009E73","#E69F00", "#CC79A7")) + # fill circles
    geom_errorbar(aes(ymin=(TP_mean)-(TP_se), # new means and se by treatment
                      ymax=(TP_mean)+(TP_se)), # new means and se by treatment
                  width=0,position=position_dodge(.4)) + # width determines the length of the end ticks
    theme_classic() +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "none") + 
    scale_y_continuous(expand = c(0, 0), limits = c(0, 3)) + # true 0 origin
    ggtitle("Total Protein") +
    labs(y= "Total Protie (ug mL)", x = "pCO2 Exposure")
Day1_TotalProtein_RxnNorm # view the plot


Day14_TotalProtein_RxnNorm <- MASTER_DF %>% # data %>%
  dplyr::filter(Day == 14) %>% # filter for desired date of rhte experiment
  dplyr::mutate(mean_TotalProtein_ug = as.numeric(mean_TotalProtein_ug)) %>% 
  dplyr::select(c('Day','pCO2_exposure','pCO2_history','mean_TotalProtein_ug')) %>% 
  na.omit() %>%   
  # we have means (from x2 assay reps per individual), now mean by treatment!
  group_by(pCO2_exposure, pCO2_history) %>% # group by columns for treatment
  dplyr::summarise( # summarise to acquire the mean and SE for plotting
    TP_mean = mean(mean_TotalProtein_ug), # mean
    TP_sd = sd(mean_TotalProtein_ug), # sd
    TP_n = n(), # count
    TP_se = TP_sd / sqrt(TP_n)) %>% # SE
  # plot it
  ggplot(aes(x=pCO2_exposure, y=TP_mean, group=pCO2_history)) + # call the new mean
    geom_line(aes(group = factor(pCO2_history), 
                  linetype = pCO2_history), 
              size = 0.5, 
              position=position_dodge(.4)) +  # connect a line between variables
    scale_linetype_manual(values=c("solid", "dashed", "dotted")) +
    geom_point(aes(shape=pCO2_history, fill=pCO2_history), size = 4.5,position=position_dodge(.4)) + 
    scale_shape_manual(values=c(21, 22, 24)) + # filled circle, filled triangle, and X 
    scale_fill_manual(values=c("#009E73","#E69F00", "#CC79A7")) + # fill circles
    geom_errorbar(aes(ymin=(TP_mean)-(TP_se), # new means and se by treatment
                      ymax=(TP_mean)+(TP_se)), # new means and se by treatment
                  width=0,position=position_dodge(.4)) + # width determines the length of the end ticks
    theme_classic() +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "none") + 
    scale_y_continuous(expand = c(0, 0), limits = c(0, 3)) + # true 0 origin
    ggtitle("Total Protein") +
    labs(y= "Total Protie (ug mL)", x = "pCO2 Exposure")
Day14_TotalProtein_RxnNorm # view the plot

ggarrange(Day1_TotalProtein_RxnNorm,Day14_TotalProtein_RxnNorm, ncol=2)
```



```{r stats - for loop for pCO2 history}

MASTER_DF <- read.csv(file = "Data/Colorimetric_assays/ATP_Master.csv", head = T)

# for loop d
Day  <- as.data.frame(list(unique(as.character(MASTER_DF$Day))))

# for loop i
pCO2history_treatments  <- as.data.frame(list(unique(paste(MASTER_DF$pCO2_history))))

# for loop m
Corlorimetric_assays          <- as.data.frame(list(c('ATP_nmol_ug_protein',
                                                'mean_TotalProtein_ug')))

# prepare data for analysis
data <- MASTER_DF %>% 
  dplyr::select(c("Day","pCO2_history","pCO2_exposure",
                  "ATP_nmol_ug_protein","mean_TotalProtein_ug")) 

# Call the cumulative dataframe that we will write to in the for loop below
df_total              <- data.frame() # start dataframe 
stats.table           <- data.frame(matrix(nrow = 1, ncol = 10)) # create dataframe to save cumunalitively during for loop
colnames(stats.table) <- c('Day', 
                          'pCO2_history',
                          'Corlorimetric_assays', 
                          'Test', 
                          'Shapiro', 
                          'Levenes',
                          'DF',
                          'Fvalue',
                          'chisquared',
                          'Pvalue') # names for comuns in the for loop


# RUN TE FOR LOOP!

for (d in 1:nrow(Day)) {
  
  x <- (Day[d,])
  data_by_Day <- data %>% 
        dplyr::filter(Day %in% x)
  
  for (i in 1:nrow(pCO2history_treatments)) {
    
    # filter the dataset 
    data_by_history <- data_by_Day %>% 
      dplyr::filter(pCO2_history %in% pCO2history_treatments[i,1]) 
      #dplyr::filter(pCO2_exposure %in% gsub('.* ', '', treatments[i,1])) 
    
      for (m in 1:nrow(Corlorimetric_assays)) {
        
        # if loop for probe type-speicif testing based on the naure of the data..
          
        colNum   <- which( colnames(data_by_history)==Corlorimetric_assays[m,])
        data_by_history[,colNum] = as.numeric(data_by_history[,colNum])
        modAOV   <- aov(lm(data_by_history[,colNum]~pCO2_exposure, data = data_by_history))
        shapTEST <- shapiro.test(resid(modAOV))
        levTEST  <- leveneTest(modAOV)
        
            # within continuous data.. run either ANOVA or Kruskal Wallis based on normality testing..
            if(shapTEST$p.value> 0.05 & levTEST$`Pr(>F)`[1] > 0.05) { # if normal - run anova
              
              modSUMMARY     <- summary(modAOV) # create anova table summary
              modSUMMARYDF   <- signif(modSUMMARY[[1]][["Df"]][1], 2) # cal p value for anova table - 2 sig figs
              modSUMMARYFval <- signif(modSUMMARY[[1]][["F value"]][1], 4) # cal p value for anova table - 2 sig figs
              modSUMMARYchi  <- NA  
              modSUMMARYPval <- signif(modSUMMARY[[1]][["Pr(>F)"]][1], 4) # cal p value for anova table - 2 sig figs
              testRun        <- "One-way ANOVA"
              
            } else { # if non-normal (either shapiro OR levenes defied) - run the Kruskal Wallis
              
              modSUMMARY     <- kruskal.test(data_by_history[,colNum] ~ pCO2_exposure, data = data_by_history) 
              modSUMMARYDF   <- signif(modSUMMARY[[2]], 2) # cal p value for Kruskal wallis test table - 2 sig figs
              modSUMMARYFval <- NA
              modSUMMARYchi  <- signif(modSUMMARY[[1]], 4) # cal p value for Kruskal wallis test table - 2 sig figs
              modSUMMARYPval <- signif(modSUMMARY[[3]], 4) # cal p value for Kruskal wallis test table - 2 sig figs
              testRun        <- "Kruskal Wallis"
            } # close the if else loop for probe type-specific testing (we are still in the the 'm' for loop!)
        
        stats.table$Day          <- data_by_history$Day[1]
        stats.table$pCO2_history  <- pCO2history_treatments[i,]
        stats.table$Corlorimetric_assays   <- Corlorimetric_assays[m,]
        stats.table$Test          <- testRun
        if (shapTEST[1] == 'NA') {
          stats.table$Shapiro = 'NA'} else {stats.table$Shapiro <- shapTEST$p.value}
        if (levTEST[1,1] == 'NA') {
          stats.table$Levenes = 'NA'} else {stats.table$Levenes <- levTEST$`Pr(>F)`[1]}
        stats.table$DF            <- modSUMMARYDF
        stats.table$Fvalue        <- modSUMMARYFval
        stats.table$chisquared    <- modSUMMARYchi
        stats.table$Pvalue        <- modSUMMARYPval
        
        df       <- data.frame(stats.table) # name dataframe for this single row
        df_total <- rbind(df_total,df) #bind to a cumulative list dataframe
        print(df_total) # print to monitor progress      
        
          } # close 'm' for loop - through each flow cy probe
    
    } # close 'i' for loop - through each pCO2 history (low, moderate, severe)
  
} # close 'd' for loop - through each sampling data (5/2/2023 and 5/16/2023)

View(df_total)
df_total
  # summary(aov(lm(SYBR_PI_count_dead~pCO2_`exposure,data=low)))
```



```{r stats run Two-Way tests}
library(rcompanion) # to run the Schrier -Ray-Hare non parametric 2 way 

# Day 1 data
MASTER_DF_d1 <- MASTER_DF %>% dplyr::filter(Day %in% 1)

# test ATP
Day1_ATP_AOV <- aov(lm(ATP_nmol_ug_protein ~ pCO2_history*pCO2_exposure, data=MASTER_DF_d1))
shapiro.test(resid(Day1_ATP_AOV)) # 7.784e-06 - non normal
leveneTest(Day1_ATP_AOV) # 0.8039 PASS variance test
Day1_ATP_AOV_SRH <- scheirerRayHare(ATP_nmol_ug_protein ~ pCO2_history*pCO2_exposure, data=MASTER_DF_d1)
Day1_ATP_AOV_SRH
#                            Df Sum Sq      H p.value
# pCO2_history                2   96.1 0.5573 0.75681
# pCO2_exposure               2  170.8 0.9901 0.60953
# pCO2_history:pCO2_exposure  4  918.3 5.3233 0.25571
# Residuals                  36 6404.8  


# Day 14 data
MASTER_DF_d14 <- MASTER_DF %>% dplyr::filter(Day %in% 14)

# test ATP
Day14_ATP_AOV <- aov(lm(ATP_nmol_ug_protein ~ pCO2_history*pCO2_exposure, data=MASTER_DF_d14))
shapiro.test(resid(Day14_ATP_AOV)) # 0.9328 normal
leveneTest(Day14_ATP_AOV) # 9.574e-07 *** NO PASS variance test
Day14_ATP_AOV_SRH <- scheirerRayHare(ATP_nmol_ug_protein ~ pCO2_history*pCO2_exposure, data=MASTER_DF_d14)
Day14_ATP_AOV_SRH
#                            Df Sum Sq      H p.value
# pCO2_history                2  49.80 1.4229 0.49094
# pCO2_exposure               2  26.25 0.7500 0.68729
# pCO2_history:pCO2_exposure  4 142.20 4.0629 0.39757
# Residuals                  11 446.75


```

```{r }
library(rcompanion) # to run the Schrier -Ray-Hare non parametric 2 way 

# Day 1 data
MASTER_DF_d1 <- MASTER_DF %>% dplyr::filter(Day %in% 1)
MASTER_DF_d14 <- MERGED_DF %>% dplyr::filter(Day %in% 14)

MASTER_DF_d14_SEV <- MASTER_DF_d14 %>% dplyr::filter(pCO2_history %in% 'severe')
Day14_ATP_AOV_SEV <- aov(lm(ATP_nmol_ug_protein ~ pCO2_exposure, data=MASTER_DF_d14_SEV))
shapiro.test(resid(Day14_ATP_AOV_SEV)) # 0.792 normal
leveneTest(Day14_ATP_AOV_SEV) #  0.01186  PASS variance test
summary(Day14_ATP_AOV_SEV)
Day14_ATP_SEV_KW <-  kruskal.test(ATP_nmol_ug_protein~ pCO2_exposure, data = MASTER_DF_d14_SEV)
Day14_ATP_SEV_KW
```


